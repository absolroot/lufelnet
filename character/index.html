---
layout: default
custom_css: [character]
custom_js: [translation-loader]

redirect_from:
- /kr/character/
- /kr/character/index.html
---

<div class="main-wrapper">
    <!-- 언어 안내 메시지 -->
    <!--
    <div id="language-notice" class="language-notice" style="display: none;">
        <p id="language-notice-text"></p>
    </div>-->

    <div class="navigation-path">
        <script>document.write(`<a href="../?v=${APP_VERSION}" id="nav-home">홈</a>`);</script>
        <span class="separator">/</span>
        <span class="current-page" id="nav-current">괴도</span>
    </div>
    <div class="header-container">
        <h1 id="page-title">괴도 육성</h1>
    </div>
    <!-- Filter section -->
    <div class="filter-section">
        <div class="filter-header">
            <button class="filter-toggle-btn">
                <img src="{{ site.baseurl }}/assets/img/character-cards/filter.png" alt="필터" />
                <span></span>
            </button>
            <button class="filter-reset-btn" style="display: none;">
                <img src="{{ site.baseurl }}/assets/img/character-cards/reset.png" alt="초기화" />
            </button>
        </div>

        <div class="filter-content" style="display: none;">
            <!-- Element filter -->
            <div class="filter-group">
                <h3>속성</h3>
                <div class="filter-options">
                    <label>
                        <input type="checkbox" name="element" value="물리">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_물리.png" alt="물리">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="총격">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_총격.png" alt="총격">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="화염">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_화염.png" alt="화염">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="빙결">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_빙결.png" alt="빙결">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="전격">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_전격.png" alt="전격">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="질풍">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_질풍.png" alt="질풍">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="염동">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_염동.png" alt="염동">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="핵열">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_핵열.png" alt="핵열">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="축복">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_축복.png" alt="축복">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="주원">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_주원.png" alt="주원">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="만능">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/속성_만능.png" alt="만능">
                        <span></span>
                    </label>
                </div>
            </div>

            <!-- Position filter -->
            <div class="filter-group">
                <h3>직업</h3>
                <div class="filter-options">
                    <label>
                        <input type="checkbox" name="position" value="지배">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/직업_지배.png" alt="지배">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="반항">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/직업_반항.png" alt="반항">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="우월">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/직업_우월.png" alt="우월">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="굴복">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/직업_굴복.png" alt="굴복">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="방위">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/직업_방위.png" alt="방위">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="구원">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/직업_구원.png" alt="구원">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="해명">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/직업_해명.png" alt="해명">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="자율">
                        <img src="{{ site.baseurl }}/assets/img/character-cards/직업_자율.png" alt="자율">
                    </label>
                </div>
            </div>

            <!-- Rarity filter -->
            <div class="filter-group">
                <h3>유형</h3>
                <div class="filter-options tag-options">
                    <label>
                        <input type="checkbox" name="rarity" value="5" hidden>
                        <div class="star-container">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star5.png" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star5.png" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star5.png" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star5.png" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star5.png" alt="★">
                        </div>
                    </label>
                    <label>
                        <input type="checkbox" name="rarity" value="4" hidden>
                        <div class="star-container">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star4.png" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star4.png" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star4.png" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/star4.png" alt="★">
                        </div>
                    </label>
                    <label><input type="checkbox" name="tag" value="한정"><img
                            src="{{ site.baseurl }}/assets/img/pay/정해진 운명.png" alt="한정"></label>
                    <label><input type="checkbox" name="tag" value="통상"><img
                            src="{{ site.baseurl }}/assets/img/pay/미래의 운명.png" alt="통상"></label>
                    <label><input type="checkbox" name="tag" value="페르소나3"><span>P3</span></label>
                    <label><input type="checkbox" name="tag" value="페르소나5"><span>P5</span></label>
                </div>
            </div>

            <!-- Tag filter -->
            <div class="filter-group">
                <h3>태그</h3>
                <div class="filter-options tag-options">
                    <label><input type="checkbox" name="tag" value="TECHNICAL"><span>TECHNICAL</span></label>
                    <label><input type="checkbox" name="tag" value="추가효과"><span>추가 효과</span></label>
                    <label><input type="checkbox" name="tag" value="지속대미지"><span>지속 대미지</span></label>
                    <label><input type="checkbox" name="tag" value="방어력감소"><span>방어력 감소</span></label>
                    <label><input type="checkbox" name="tag" value="관통"><span>관통</span></label>
                    <label><input type="checkbox" name="tag" value="효과명중"><span>효과 명중</span></label>
                    <label><input type="checkbox" name="tag" value="실드"><span>실드</span></label>
                    <label><input type="checkbox" name="tag" value="화상"><span>화상</span></label>
                    <label><input type="checkbox" name="tag" value="풍습"><span>풍습</span></label>
                    <label><input type="checkbox" name="tag" value="감전"><span>감전</span></label>
                    <label><input type="checkbox" name="tag" value="동결"><span>동결</span></label>
                    <label><input type="checkbox" name="tag" value="HP 소모"><span>HP 소모</span></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Separator line -->
    <div class="separator-line"></div>

    <!-- Search section below filter section -->
    <div class="search-section">
        <div class="search-container">
            <div class="search-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5c0-3.59-2.91-6.5-6.5-6.5S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.27v.79L19 20.49 20.49 19 15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                        fill="rgba(255, 255, 255, 0.6)" />
                </svg>
            </div>
            <input type="text" id="characterSearch" placeholder="캐릭터 검색..." autocomplete="off">
            <div id="searchDropdown" class="search-dropdown"></div>
        </div>
        <div class="search-count"></div>
        <div class="spoiler-toggle-container">
            <label class="spoiler-toggle-label">
                <input type="checkbox" id="spoilerToggle" class="spoiler-toggle-checkbox">
                <span class="spoiler-toggle-text" id="spoilerToggleText">스포일러 보기</span>
            </label>
        </div>
    </div>
    <!-- Character card container -->
    <div class="character-cards" id="characterCards">
        <!-- Dynamically generated by JavaScript -->
    </div>

    <!-- 광고 -->
    <!--
    <div id="ad-unit-bottom" class="AD-bottom" style="margin-top: 40px; margin-bottom:12px; text-align: center; align-items: center; display: flex; justify-content: center;"> 
    <ins class="adsbygoogle"
        style="display:inline-block;width:970px;height:90px"
        data-ad-client="ca-pub-5862324369257695"
        data-ad-slot="9244892982"></ins>
    </div>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

    <style>
        @media (max-width: 1440px) {
            .AD-bottom {
                display: none !important;
            }
        }
    </style>-->
</div>

<style>
    /* 스포일러 토글 스타일 */
    .spoiler-toggle-container {
        display: flex;
        align-items: center;
        margin-left: 12px;
    }

    .spoiler-toggle-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        user-select: none;
        transition: color 0.2s ease;
    }

    .spoiler-toggle-label:hover {
        color: rgba(255, 255, 255, 1);
    }

    .spoiler-toggle-checkbox {
        appearance: none;
        width: 20px !important;
        height: 20px !important;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        position: relative;
        transition: all 0.2s ease;
        background: transparent;
        background-image: none !important;
        margin-right: 4px !important;
    }

    .spoiler-toggle-checkbox:checked {
        background: #a90505b7;
        border-color: #a90505b7;
        background-image: none !important;
        width: 20px !important;
        height: 20px !important;
        margin-right: 4px !important;
    }

    /* 체크 표시가 박스 가운데에 있을 수 있도록 */
    .spoiler-toggle-checkbox:checked::after {
        content: '✓';
        position: absolute;
        top: -2px;
        left: 1px;
        color: white;
        font-size: 12px;
        font-weight: bold;
        padding: 2px 0 0 2px;
    }

    .spoiler-toggle-checkbox:hover {
        border-color: rgba(255, 255, 255, 0.5);
    }

    .spoiler-toggle-text {
        font-weight: 500;
    }

    /* 검색 섹션 레이아웃 조정 */
    .search-section {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 12px;
        margin-bottom: 24px;
    }

    .search-container {
        flex: 1;
        position: relative;
    }

    .search-count {
        white-space: nowrap;
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
    }

    /* 미출시 캐릭터 태그 스타일 */
    .not-released-tag {
        position: absolute;
        top: 10px;
        right: 0px;
        background: #f6d933;
        color: #000;
        font-size: 8px;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 0px;
        z-index: 10;
        box-shadow: 0 1px 3px rgba(255, 255, 255, 0.05);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* 캐릭터 카드에 relative position 추가 (태그 위치 기준) */
    .card {
        position: relative;
    }

    .card a {
        position: relative;
        display: block;
    }
</style>

<script>
    // 다국어 지원 함수
    async function updateLanguageContent() {
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';

        // Jekyll 다국어 데이터 사용
        const i18nData = {
            kr: {
                language_notice: "",
                nav_home: "홈",
                nav_current: "괴도",
                page_title: "괴도 육성",
                filtered_count: "전체",
                search_placeholder: "캐릭터 검색..."
            },
            en: {
                language_notice: "{{ site.data.i18n.en.language_notice | default: '' }}",
                nav_home: "{{ site.data.i18n.en.nav_home | default: 'Home' }}",
                nav_current: "{{ site.data.i18n.en.character_breadcrumb | default: 'Characters' }}",
                page_title: "{{ site.data.i18n.en.character_page_title | default: 'Characters' }}",
                filtered_count: "{{ site.data.i18n.en.filtered_count | default: 'Total' }}",
                search_placeholder: "{{ site.data.i18n.en.character_search_placeholder | default: 'Search characters...' }}"
            },
            jp: {
                language_notice: "{{ site.data.i18n.jp.language_notice | default: '' }}",
                nav_home: "{{ site.data.i18n.jp.nav_home | default: 'ホーム' }}",
                nav_current: "{{ site.data.i18n.jp.character_breadcrumb | default: '怪盗' }}",
                page_title: "{{ site.data.i18n.jp.character_page_title | default: '怪盗' }}",
                filtered_count: "{{ site.data.i18n.jp.filtered_count | default: '全体' }}",
                search_placeholder: "{{ site.data.i18n.jp.character_search_placeholder | default: '怪盗検索...' }}"
            }
        };

        const data = i18nData[currentLang];
        if (!data) return;

        // 언어 안내 메시지
        if (currentLang !== 'kr') {
            const notice = document.getElementById('language-notice');
            const noticeText = document.getElementById('language-notice-text');
            if (notice && noticeText && data.language_notice) {
                noticeText.textContent = data.language_notice;
                notice.style.display = 'block';
            }
        }

        // 네비게이션 및 제목 업데이트
        const navHome = document.getElementById('nav-home');
        const navCurrent = document.getElementById('nav-current');
        const pageTitle = document.getElementById('page-title');
        const searchInput = document.getElementById('characterSearch');

        if (navHome) navHome.textContent = data.nav_home;
        if (navCurrent) navCurrent.textContent = data.nav_current;
        if (pageTitle) pageTitle.textContent = data.page_title;
        if (searchInput) searchInput.placeholder = data.search_placeholder;

        // 필터 카운트 텍스트 업데이트를 위한 전역 변수 설정
        window.i18nFilteredCount = data.filtered_count;

        // 필터 제목 번역
        updateFilterTitles(currentLang);
    }

    // 필터 제목 번역 함수
    function updateFilterTitles(currentLang) {
        const filterTitles = {
            kr: {
                element: "속성",
                position: "직업",
                type: "유형",
                tag: "태그",
                count_unit: "명"
            },
            en: {
                element: "Element",
                position: "Position",
                type: "Type",
                tag: "Tag",
                count_unit: " "
            },
            jp: {
                element: "属性",
                position: "職業",
                type: "タイプ",
                tag: "タグ",
                count_unit: "体"
            }
        };

        const titles = filterTitles[currentLang];
        if (!titles) return;

        // 필터 그룹 제목들 업데이트
        const filterGroups = document.querySelectorAll('.filter-group h3');
        if (filterGroups.length >= 4) {
            filterGroups[0].textContent = titles.element; // 속성
            filterGroups[1].textContent = titles.position; // 직업
            filterGroups[2].textContent = titles.type; // 유형
            filterGroups[3].textContent = titles.tag; // 태그
        }

        // 개수 단위 전역 변수 설정
        window.i18nCountUnit = titles.count_unit;
    }

    // 언어별 SEO 설정 함수
    function updateSEOContent() {
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';

        const seoData = {
            'kr': {
                title: '괴도 육성 가이드 - 페르소나5 더 팬텀 X 루페르넷',
                description: '페르소나5 더 팬텀 X의 괴도별 육성 가이드. 추천 세팅, 스킬, 의식, 전용무기 정보를 확인하세요.'
            },
            'en': {
                title: 'Character Build Guide - Persona 5: The Phantom X LufelNet',
                description: 'Character development guide for Persona 5: The Phantom X. Check recommended setup, skills, awareness, and exclusive weapon info.'
            },
            'jp': {
                title: '怪盗育成ガイド - ペルソナ5 ザ・ファントム X LufelNet',
                description: 'ペルソナ5 ザ・ファントム Xの怪盗別育成ガイド。おすすめ設定、スキル、意識、専用武器情報をご確認ください。'
            }
        };

        const currentSEO = seoData[currentLang] || seoData['kr'];

        // 타이틀 업데이트
        document.title = currentSEO.title;

        // 메타 태그 업데이트
        const metaDescription = document.querySelector('meta[name="description"]');
        const ogTitle = document.querySelector('meta[property="og:title"]');
        const ogDescription = document.querySelector('meta[property="og:description"]');

        if (metaDescription) metaDescription.setAttribute('content', currentSEO.description);
        if (ogTitle) ogTitle.setAttribute('content', currentSEO.title);
        if (ogDescription) ogDescription.setAttribute('content', currentSEO.description);
    }

    // Initialize navigation on page load
    // 기존 DOMContentLoaded 리스너 제거됨 - 하단의 통합된 리스너 사용

    // 스크립트에서 데이터 추출하는 함수
    function extractDataFromScript(scriptText) {
        // 레거시 정규식 경로는 더 이상 사용하지 않음.
        // 호출 호환성 유지용 더미 구현.
        throw new Error('Failed to extract data from script');
    }

    // 안전한 스크립트 로더
    function loadScriptOnce(src) {
        return new Promise((resolve, reject) => {
            const exists = Array.from(document.scripts).some(s => s.src && s.src.includes(src));
            if (exists) return resolve();
            const s = document.createElement('script');
            s.src = src;
            s.onload = () => resolve();
            s.onerror = () => reject(new Error('Failed to load ' + src));
            document.head.appendChild(s);
        });
    }

    // 언어별 characters.js를 샌드박스에서 평가해 순수 데이터만 추출
    async function fetchCharactersData(url) {
        try {
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const text = await res.text();
            const sandbox = {};
            // 파일 내에서 window.characterList / window.characterData에 병합하도록 되어 있어도
            // 이 샌드박스 window는 비어 있으므로 순수 언어 데이터만 담긴다.
            const win = (new Function('window', `${text}\n; return window;`))(sandbox);
            const list = win.characterList || { mainParty: [], supportParty: [] };
            const data = win.characterData || {};
            return { characterList: list, characterData: data };
        } catch (e) {
            return null;
        }
    }

    // 스포일러 토글 상태 확인 함수
    function isSpoilerEnabled() {
        return localStorage.getItem('spoilerToggle') === 'true';
    }

    // 언어별 캐릭터 데이터 로딩 및 병합
    async function loadCharacterData() {
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';
        const spoilerEnabled = isSpoilerEnabled();

        // 스포일러 모드에서 미출시 캐릭터 감지를 위해 원본 언어별 캐릭터 리스트 저장
        let originalLangCharacterList = null;

        try {
            // 1) KR 스크립트 로드 후 전역에서 추출
            await loadScriptOnce(`/data/kr/characters/characters.js?v=${APP_VERSION}`);
            const krCharacterData = JSON.parse(JSON.stringify(window.characterData || {}));
            const krCharacterList = JSON.parse(JSON.stringify(window.characterList || {}));

            // 2) 언어 데이터 로드 및 병합(샌드박스 평가로 전역 오염 방지)
            if (currentLang !== 'kr') {
                const langUrl = `/data/${currentLang}/characters/characters.js?v=${APP_VERSION}`;
                const lang = await fetchCharactersData(langUrl);
                if (lang) {
                    const langCharacterData = lang.characterData || {};
                    const langCharacterList = lang.characterList || { mainParty: [], supportParty: [] };
                    originalLangCharacterList = [...(langCharacterList.mainParty || []), ...(langCharacterList.supportParty || [])];
                    if (!spoilerEnabled) {
                        const mergedData = mergeCharacterData(krCharacterData, langCharacterData);
                        window.characterData = mergedData;
                        window.characterList = langCharacterList;
                    } else {
                        window.characterData = krCharacterData;
                        window.characterList = krCharacterList;
                    }
                } else {
                    // 언어별 데이터 로드 실패 시 KR 사용
                    originalLangCharacterList = [...(krCharacterList?.mainParty || []), ...(krCharacterList?.supportParty || [])];
                    window.characterData = krCharacterData;
                    window.characterList = krCharacterList;
                }
            } else {
                window.characterData = krCharacterData;
                window.characterList = krCharacterList;
            }

            // 스포일러 모드에서 미출시 캐릭터 감지를 위해 원본 리스트를 전역 변수에 저장
            window.originalLangCharacterList = originalLangCharacterList;

            return true;

        } catch (error) {
            console.error('Failed to load character data:', error);
            return false;
        }
    }

    // 캐릭터 데이터 병합 함수 (하이브리드 방식)
    function mergeCharacterData(krData, langData) {
        const mergedData = {};
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';


        // 샘플 데이터 확인
        const firstKrKey = Object.keys(krData)[0];
        const firstLangKey = Object.keys(langData)[0];

        // 언어별 데이터에 있는 캐릭터만 포함 (langData 기준으로 필터링)
        for (const characterKey in langData) {
            //console.log('Merging character:', characterKey);

            if (krData[characterKey]) {
                //console.log(`✅ Found KR data for ${characterKey}`);
                // 한국어 데이터를 기본으로 완전히 복사 (모든 속성 보존)
                mergedData[characterKey] = { ...krData[characterKey] };

                const langChar = langData[characterKey];
                const krChar = krData[characterKey];

                // name 처리: 현재 언어에 따라 적절한 이름 사용
                if (currentLang === 'en') {
                    if (krChar.name_en) {
                        mergedData[characterKey].name = krChar.name_en;
                    } else if (langChar.name && langChar.name !== '') {
                        mergedData[characterKey].name = langChar.name;
                    }
                } else if (currentLang === 'jp') {
                    if (krChar.name_jp) {
                        mergedData[characterKey].name = krChar.name_jp;
                    } else if (langChar.name && langChar.name !== '') {
                        mergedData[characterKey].name = langChar.name;
                    } else {
                    }
                } else {
                    // KR 언어일 때는 기본 KR 이름 사용
                }

                // persona 처리: 현재 언어에 따라 적절한 페르소나 이름 사용
                if (currentLang === 'en') {
                    if (krChar.persona_en) {
                        mergedData[characterKey].persona = krChar.persona_en;
                    } else if (langChar.persona && langChar.persona !== '') {
                        mergedData[characterKey].persona = langChar.persona;
                    }
                } else if (currentLang === 'jp') {
                    if (krChar.persona_jp) {
                        mergedData[characterKey].persona = krChar.persona_jp;
                        //console.log(`Using KR JP persona for ${characterKey}: ${krChar.persona_jp}`);
                    } else if (langChar.persona && langChar.persona !== '') {
                        mergedData[characterKey].persona = langChar.persona;
                        //console.log(`Using Lang JP persona for ${characterKey}: ${langChar.persona}`);
                    }
                }

                // 속성 번역 처리 (element 필드는 그대로 유지하되, 표시용 번역 추가)
                if (currentLang !== 'kr' && typeof characterTranslations !== 'undefined' && characterTranslations.elements) {
                    const translatedElement = characterTranslations.elements[mergedData[characterKey].element];
                    if (translatedElement) {
                        mergedData[characterKey].element_display = translatedElement;
                    }

                    const translatedPosition = characterTranslations.positions[mergedData[characterKey].position];
                    if (translatedPosition) {
                        mergedData[characterKey].position_display = translatedPosition;
                    }
                }

                // 다른 필드들은 언어별 데이터에 값이 있고 빈 문자열이 아닐 때만 덮어쓰기
                // 중요: element, position, rarity 등은 절대 덮어쓰지 않음 (한국어 데이터 유지)
                if (langChar.role && langChar.role !== '') {
                    mergedData[characterKey].role = langChar.role;
                }
                if (langChar.tag && langChar.tag !== '') {
                    mergedData[characterKey].tag = langChar.tag;
                }
                // release_order는 언어별 데이터에 있으면 무조건 사용 (0도 유효한 값)
                if (langChar.release_order !== undefined) {
                    mergedData[characterKey].release_order = langChar.release_order;
                    //console.log(`Using Lang release_order for ${characterKey}: ${langChar.release_order}`);
                }

                // 중요한 속성들이 제대로 보존되었는지 확인
                if (!mergedData[characterKey].element || !mergedData[characterKey].position || !mergedData[characterKey].rarity) {
                    console.warn(`Missing critical data for ${characterKey}:`, {
                        element: mergedData[characterKey].element,
                        position: mergedData[characterKey].position,
                        rarity: mergedData[characterKey].rarity
                    });
                }

            } else {
                console.warn(`❌ Character ${characterKey} not found in KR data`);
                console.warn('Available KR characters:', Object.keys(krData).slice(0, 10), '... (showing first 10)');
            }
        }

        return mergedData;
    }

    // P3 필터 표시 여부 확인
    function shouldShowP3Filter() {
        if (!characterData) return false;

        // 로딩된 캐릭터 중에 persona3=true인 캐릭터가 있는지 확인
        return Object.values(characterData).some(char => char.persona3 === true);
    }

    // P3 필터 표시/숨김 처리
    function toggleP3Filter() {
        const p3Filter = document.querySelector('label input[value="페르소나3"]');
        if (p3Filter) {
            const p3Label = p3Filter.closest('label');
            if (shouldShowP3Filter()) {
                p3Label.style.display = 'flex';
            } else {
                p3Label.style.display = 'none';
            }
        }
    }

    // 중복 실행 방지를 위한 플래그
    let isInitializing = false;
    let isInitialized = false;

    async function initializePageContent() {
        // 중복 실행 방지
        if (isInitializing || isInitialized) {
            // console.log('initializePageContent already running or completed');
            return;
        }

        isInitializing = true;
        // console.log('=== STARTING PAGE INITIALIZATION ===');

        // 캐릭터 데이터 로딩
        const dataLoaded = await loadCharacterData();
        if (!dataLoaded || typeof window.characterData === 'undefined') {
            console.error('characterData is not loaded');
            isInitializing = false;
            return;
        }

        // 지역 변수를 window.characterData로 설정
        const characterData = window.characterData;
        const characterList = window.characterList;

        // P3 필터 표시 여부 처리
        toggleP3Filter();

        const cardsContainer = document.getElementById('characterCards');
        const searchCount = document.querySelector('.search-count');

        // 기존 카드들 제거 (중복 방지)
        cardsContainer.innerHTML = '';

        // Combine mainParty and supportParty from characterList (언어별 제한된 목록)
        let allCharacters = [
            ...characterList.mainParty,
            ...characterList.supportParty
        ];

        // Exclude 'Wonder' from characters
        allCharacters = allCharacters.filter(character => character !== "원더");

        // characterList에 있는 캐릭터만 사용하고, characterData에도 존재하는지 확인
        const availableCharacters = allCharacters.filter(characterName => characterData[characterName] !== undefined);

        // Sort by release_order (descending), then by rarity
        const sortedCharacters = availableCharacters.sort((a, b) => {
            const aReleaseOrder = characterData[a].release_order || 0;
            const bReleaseOrder = characterData[b].release_order || 0;
            const releaseOrderDiff = bReleaseOrder - aReleaseOrder;

            if (releaseOrderDiff !== 0) return releaseOrderDiff;
            return characterData[b].rarity - characterData[a].rarity;
        });



        // 초기 검색 결과 수 표시
        const countText = window.i18nFilteredCount || '전체';
        const countUnit = window.i18nCountUnit || '명';
        searchCount.textContent = `${countText} ${sortedCharacters.length}${countUnit}`;


        // Create card for each character
        sortedCharacters.forEach((characterName, index) => {

            const charData = characterData[characterName];
            if (!charData) {
                return;
            }


            // 속성 값 디버그
            const element = charData.element;
            const position = charData.position;
            const rarity = charData.rarity;

            if (!element || !position || !rarity) {
                console.warn(`Missing attributes for ${characterName}:`, {
                    element: element,
                    position: position,
                    rarity: rarity
                });
            }

            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.element = element || 'undefined';
            card.dataset.position = position || 'undefined';
            card.dataset.rarity = rarity || 'undefined';
            card.dataset.persona5 = charData.persona5 ? 'true' : 'false';
            card.dataset.persona3 = charData.persona3 ? 'true' : 'false';
            card.dataset.limit = charData.limit ? 'true' : 'false';
            card.dataset.tags = charData.tag || '';

            // Create link wrapper - 언어 파라미터 추가
            const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';
            const link = document.createElement('a');
            link.href = `/character.html?name=${encodeURIComponent(characterName)}&lang=${currentLang}&v=${APP_VERSION}`;
            link.style.textDecoration = 'none';
            link.style.color = 'inherit';

            // Position icon container
            const positionContainer = document.createElement('div');
            positionContainer.className = 'position-container';

            // Position icon
            const positionIcon = document.createElement('img');
            const positionForIcon = position || 'undefined';
            positionIcon.src = `{{ site.baseurl }}/assets/img/character-cards/직업_${positionForIcon}.png`;
            positionIcon.alt = charData.position_display || position || 'undefined';
            positionIcon.className = 'position-icon';

            // Character image
            const img = document.createElement('img');
            img.src = `{{ site.baseurl }}/assets/img/character-cards/card_skeleton.webp`;
            img.alt = characterName;
            img.className = 'character-img';

            // 실제 이미지 로드
            const realImage = new Image();
            realImage.src = `{{ site.baseurl }}/assets/img/character-cards/${characterName}.webp`;
            realImage.alt = characterName;
            realImage.className = 'character-img';
            realImage.onload = () => {
                img.src = realImage.src;
                img.classList.add('loaded');
            };

            // Element icon
            const elementIcon = document.createElement('img');
            const elementForIcon = element || 'undefined';
            elementIcon.src = `{{ site.baseurl }}/assets/img/character-cards/속성_${elementForIcon}.png`;
            elementIcon.alt = charData.element_display || element || 'undefined';
            elementIcon.className = 'element-icon';

            // Add name
            const nameText = document.createElement('span');
            // 스포일러 모드와 언어에 따른 이름 표시 로직
            const spoilerEnabled = isSpoilerEnabled();
            if (currentLang === 'en' && charData.codename) {
                nameText.textContent = charData.codename;
            } else if (currentLang === 'jp' && spoilerEnabled && charData.name_jp) {
                // 스포일러 모드에서 일본어 이름 사용
                nameText.textContent = charData.name_jp;
            } else {
                nameText.textContent = charData.name;
            }
            nameText.className = 'name-text';
            nameText.dataset.persona3 = charData.persona3;
            nameText.dataset.persona4 = charData.persona4;
            nameText.dataset.persona5 = charData.persona5;

            // 스포일러 모드에서 미출시 캐릭터 태그 추가
            if (spoilerEnabled && currentLang !== 'kr') {
                // 원본 언어별 characterList에 없는 캐릭터를 미출시로 판단
                const originalCharacterList = window.originalLangCharacterList || [];
                const isUnreleased = !originalCharacterList.includes(characterName);

                // console.log(`Checking ${characterName}: originalList includes = ${originalCharacterList.includes(characterName)}, isUnreleased = ${isUnreleased}`);

                if (isUnreleased) {
                    const notReleasedTag = document.createElement('div');
                    notReleasedTag.className = 'not-released-tag';
                    const tagTexts = {
                        en: 'Not Released',
                        jp: '未リリース'
                    };
                    notReleasedTag.textContent = tagTexts[currentLang] || 'Not Released';
                    link.appendChild(notReleasedTag);
                    console.log(`Added Not Released tag for ${characterName}`);
                }
            }

            positionContainer.appendChild(positionIcon);
            link.appendChild(positionContainer);
            link.appendChild(img);
            link.appendChild(elementIcon);
            link.appendChild(nameText);
            card.appendChild(link);
            cardsContainer.appendChild(card);
        });

        // 필터 및 검색 기능 초기화
        initializeFiltersAndSearch(sortedCharacters);

        // 번역 적용 (데이터 로딩 후)
        await applyTranslations();

        // 초기화 완료
        isInitializing = false;
        isInitialized = true;
    } // initializePageContent 함수 종료

    // 필터 및 검색 기능 초기화
    function initializeFiltersAndSearch(sortedCharacters) {
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';

        // 영어/일본어일 때 태그 필터 숨기기
        /*
        if (currentLang === 'en' || currentLang === 'jp') {
            const tagFilterGroup = document.querySelector('.filter-group:last-child');
            if (tagFilterGroup) {
                tagFilterGroup.style.display = 'none';
            }
        }
        */

        // 필터 변경 이벤트 리스너
        const filterInputs = document.querySelectorAll('input[type="checkbox"]');
        filterInputs.forEach(input => {
            input.addEventListener('change', applyFilters);
        });

        const searchCount = document.querySelector('.search-count');
        const filterToggleBtn = document.querySelector('.filter-toggle-btn');
        const filterContent = document.querySelector('.filter-content');
        const filterResetBtn = document.querySelector('.filter-reset-btn');
        const checkboxes = document.querySelectorAll('.filter-options input[type="checkbox"]');

        if (filterContent) {
            filterContent.style.display = 'block';
        }

        // Filter toggle
        if (filterToggleBtn) {
            filterToggleBtn.addEventListener('click', () => {
                filterContent.style.display = filterContent.style.display === 'none' ? 'block' : 'none';
            });
            filterToggleBtn.style.display = 'none';
        }

        // Reset button
        if (filterResetBtn) {
            filterResetBtn.addEventListener('click', () => {
                checkboxes.forEach(cb => cb.checked = false);
                filterResetBtn.style.display = 'none';
                applyFilters();
            });
            filterResetBtn.style.display = 'none';
        }

        // Filter application function
        function applyFilters() {
            const selectedElements = Array.from(document.querySelectorAll('input[name="element"]:checked')).map(cb => cb.value);
            const selectedPositions = Array.from(document.querySelectorAll('input[name="position"]:checked')).map(cb => cb.value);
            const selectedRarities = Array.from(document.querySelectorAll('input[name="rarity"]:checked')).map(cb => parseInt(cb.value));
            const selectedTags = Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(cb => cb.value);

            let visibleCount = 0;

            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const element = card.dataset.element;
                const position = card.dataset.position;
                const rarity = parseInt(card.dataset.rarity);
                const isPersona5 = card.dataset.persona5 === 'true';
                const isPersona3 = card.dataset.persona3 === 'true';
                const isLimited = card.dataset.limit === 'true';
                const characterTags = card.dataset.tags || '';

                const elementMatch = selectedElements.length === 0 ||
                    selectedElements.includes(element) ||
                    (element === "질풍빙결" && (selectedElements.includes("질풍") || selectedElements.includes("빙결")));

                const positionMatch = selectedPositions.length === 0 || selectedPositions.includes(position);
                const rarityMatch = selectedRarities.length === 0 || selectedRarities.includes(rarity);

                const tagMatch = selectedTags.every(tag => {
                    switch (tag) {
                        case '페르소나5': return isPersona5;
                        case '페르소나3': return isPersona3;
                        case '한정': return isLimited;
                        case '통상': return !isLimited;
                        case 'TECHNICAL': return characterTags.includes('TECHNICAL') || characterTags.includes('스킬마스터');
                        case '추가효과': return characterTags.includes('추가 효과') || characterTags.includes('추가효과');
                        case '지속대미지': return characterTags.includes('지속 대미지') || characterTags.includes('화상') || characterTags.includes('주원');
                        case '화상': return characterTags.includes('화상') || (characterTags.includes('원소 이상') && !characterTags.includes('원소 이상 제거'));
                        case '풍습': return characterTags.includes('풍습') || (characterTags.includes('원소 이상') && !characterTags.includes('원소 이상 제거'));
                        case '감전': return characterTags.includes('감전') || (characterTags.includes('원소 이상') && !characterTags.includes('원소 이상 제거'));
                        case '동결': return characterTags.includes('동결') || (characterTags.includes('원소 이상') && !characterTags.includes('원소 이상 제거'));
                        case 'HP 소모': return characterTags.includes('HP 소모');
                        case '실드': return characterTags.includes('실드');
                        case '효과명중': return characterTags.includes('효과 명중');
                        case '방어력감소': return characterTags.includes('방어력 감소');
                        case '관통': return characterTags.includes('관통');
                        default: return false;
                    }
                });

                const shouldShow = elementMatch && positionMatch && rarityMatch && (selectedTags.length === 0 || tagMatch);
                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });

            // Update search count
            if (searchCount) {
                const countText = window.i18nFilteredCount || '전체';
                const countUnit = window.i18nCountUnit || '명';
                searchCount.textContent = `${countText} ${visibleCount}${countUnit}`;
            }
        }

        // 별칭 매핑
        const nicknameMap = {
            '유이': 'YUI',
            '라멘': '카노 슌',
            '욧샤': '사카모토 류지',
            '수모코': '노게 토모코·여름',
            '수토하': '아라이 모토하·여름',
            '왕왕루': '도겐자카 루우나',
            '얼탱': '아시야 마사키',
            '조커': '아마미야 렌',
            '의사': '키타자토 키라',
            '와가하이': '모르가나',
            '수나미': '미나미·여름',
            '수미유': '미유·여름',
            '수유': '미유·여름',
            '그새끼': '아케치 고로',
            '선생': '카타야마 쿠미',
            '에우떼르빼': '나가오 마나카',
            '화오링': '리 야오링·사자무',
            '불오링': '리 야오링·사자무',
            '5리코': '타네무라 리코·매화',
            '풍리코': '타네무라 리코·매화',
            '풍타뉴': '코토네 몽타뉴·백조',
            '백타뉴': '코토네 몽타뉴·백조',
            '3주': '유키 마코토',
            '센세': '카타야마 쿠미',
            '선생': '카타야마 쿠미'
        };

        // 검색 기능 구현
        const searchInput = document.getElementById('characterSearch');
        const dropdown = document.getElementById('searchDropdown');

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchValue = e.target.value.toLowerCase();
                if (dropdown) {
                    dropdown.innerHTML = '';

                    if (searchValue.length > 0) {
                        // characterData가 로드되었는지 확인
                        if (!window.characterData) {
                            console.error('Character data not loaded yet');
                            return;
                        }

                        // sortedCharacters 배열에서 검색
                        const matches = sortedCharacters.filter(characterName => {
                            if (!window.characterData[characterName]) {
                                console.warn(`No data found for character: ${characterName}`);
                                return false;
                            }

                            const charData = window.characterData[characterName];
                            const displayName = charData.name ? charData.name.toLowerCase() : '';
                            const originalName = characterName.toLowerCase();
                            const codeName = charData.codename ? charData.codename.toLowerCase() : '';

                            // 별칭 매칭도 포함
                            const nicknameMatch = Object.entries(nicknameMap).find(([nickname, realName]) =>
                                nickname.toLowerCase().includes(searchValue) && realName === charData.name
                            );

                            return displayName.includes(searchValue) ||
                                originalName.includes(searchValue) ||
                                codeName.includes(searchValue) ||
                                nicknameMatch !== undefined;
                        });

                        if (matches.length > 0) {
                            dropdown.style.display = 'block';
                            matches.forEach(name => {
                                if (!window.characterData[name]) return;

                                const div = document.createElement('div');
                                div.className = 'dropdown-item';
                                const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';
                                const char = window.characterData[name];
                                let displayName = char.name;
                                if (currentLang === 'en') {
                                    displayName = char.codename || char.name_en || char.name;
                                } else if (currentLang === 'jp') {
                                    displayName = char.name_jp || char.name;
                                }
                                div.textContent = displayName;
                                div.addEventListener('click', () => {
                                    searchInput.value = displayName;
                                    dropdown.style.display = 'none';
                                    filterBySearch(displayName.toLowerCase());
                                });
                                dropdown.appendChild(div);
                            });
                        } else {
                            dropdown.style.display = 'none';
                        }
                    } else {
                        dropdown.style.display = 'none';
                        filterBySearch('');
                    }
                }

                filterBySearch(searchValue);
            });
        }

        // Search filtering function
        function filterBySearch(searchValue) {
            if (!window.characterData) {
                console.error('Character data not loaded yet');
                return;
            }

            let visibleCount = 0;
            const cards = document.querySelectorAll('.card');

            cards.forEach(card => {
                const nameText = card.querySelector('.name-text');
                if (!nameText) return;

                const displayName = nameText.textContent;
                if (!displayName) return;

                const displayNameLower = displayName.toLowerCase();

                // characterData에서 해당 캐릭터 찾기
                const characterKey = sortedCharacters.find(name =>
                    window.characterData[name] &&
                    (window.characterData[name].name === displayName ||
                        window.characterData[name].codename === displayName ||
                        window.characterData[name].name_en === displayName ||
                        window.characterData[name].name_jp === displayName)
                );

                // 별칭 매칭 확인
                const nicknameMatch = Object.entries(nicknameMap).find(([nickname, realName]) =>
                    nickname.toLowerCase().includes(searchValue) && realName === displayName
                );

                // 코드네임도 검색 대상에 포함
                const charData = characterKey ? window.characterData[characterKey] : null;
                const codeNameMatch = charData && charData.codename &&
                    charData.codename.toLowerCase().includes(searchValue) ||
                    charData.name_en && charData.name_en.toLowerCase().includes(searchValue) ||
                    charData.name_jp && charData.name_jp.toLowerCase().includes(searchValue);

                const shouldShow = searchValue === '' ||
                    (characterKey && characterKey.toLowerCase().includes(searchValue)) ||
                    displayNameLower.includes(searchValue) ||
                    codeNameMatch ||
                    nicknameMatch !== undefined;

                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });

            // 검색 결과 수 업데이트
            if (searchCount) {
                const countText = window.i18nFilteredCount || '전체';
                const countUnit = window.i18nCountUnit || '명';
                searchCount.textContent = `${countText} ${visibleCount}${countUnit}`;
            }
        }
    } // initializePageContent 함수 종료

    // 번역 시스템 적용
    async function applyTranslations() {
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';
        if (currentLang === 'kr') return;

        try {
            // 번역 데이터 로드
            const translations = await TranslationLoader.loadTranslations('characters', currentLang);
            if (!translations) {
                console.warn('No translations found for', currentLang);
                return;
            }

            // console.log('Applying translations for', currentLang, translations);

            // 카드 업데이트
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const nameElement = card.querySelector('.name-text');
                if (!nameElement) return;

                const originalName = nameElement.textContent;
                const characterKey = Object.keys(characterData).find(key =>
                    characterData[key].name === originalName
                );

                if (characterKey && characterData[characterKey]) {
                    const char = characterData[characterKey];

                    // 영어일 때 코드네임 우선, 없으면 번역된 이름 사용
                    if (currentLang === 'en') {
                        if (char.codename) {
                            nameElement.textContent = char.codename;
                        } else if (char.name_en) {
                            nameElement.textContent = char.name_en;
                        }
                    } else if (currentLang === 'jp' && char.name_jp) {
                        nameElement.textContent = char.name_jp;
                    }

                    // 속성 아이콘 alt 텍스트 번역
                    const elementImg = card.querySelector('.element-icon');
                    if (elementImg && translations.elements && translations.elements[char.element]) {
                        elementImg.alt = translations.elements[char.element];
                        elementImg.title = translations.elements[char.element];
                    }
                }
            });

            // 필터 레이블 번역
            updateFilterLabels(translations, currentLang);

            // 검색 플레이스홀더 번역
            updateSearchPlaceholder(currentLang);

            // UI 텍스트 번역
            updateUITexts(currentLang);

        } catch (error) {
            console.warn('Translation application failed:', error);
        }
    }

    // 필터 레이블 번역
    function updateFilterLabels(translations, lang) {
        if (!translations) return;

        // 속성 필터 번역
        if (translations.elements) {
            const elementLabels = document.querySelectorAll('.filter-group:first-child .filter-options label span');
            elementLabels.forEach((span, index) => {
                const elementKey = span.textContent;
                if (translations.elements[elementKey]) {
                    span.textContent = translations.elements[elementKey];
                }
            });
        }

        // 직업 필터 번역 
        if (translations.positions) {
            const positionLabels = document.querySelectorAll('.filter-group:nth-child(2) .filter-options label');
            positionLabels.forEach(label => {
                const img = label.querySelector('img');
                if (img) {
                    const positionKey = img.alt;
                    if (translations.positions[positionKey]) {
                        img.alt = translations.positions[positionKey];
                        img.title = translations.positions[positionKey];
                    }
                }
            });
        }

        // 태그 필터 번역
        if (translations.tags) {
            const tagLabels = document.querySelectorAll('.filter-group:last-child .filter-options label span');
            tagLabels.forEach(span => {
                const tagKey = span.textContent;
                if (translations.tags[tagKey]) {
                    span.textContent = translations.tags[tagKey];
                }
            });
        }
    }

    // 검색 플레이스홀더 번역
    function updateSearchPlaceholder(lang) {
        const searchInput = document.getElementById('characterSearch');
        if (!searchInput) return;

        const placeholders = {
            'en': 'Search characters...',
            'jp': '怪盗検索...'
        };

        if (placeholders[lang]) {
            searchInput.placeholder = placeholders[lang];
        }
    }

    // UI 텍스트 번역
    function updateUITexts(lang) {
        if (lang === 'kr') return;

        // 기존 i18n 시스템 활용
        if (window.i18nData && window.i18nData[lang]) {
            const i18n = window.i18nData[lang];

            // 페이지 제목
            const pageTitle = document.getElementById('page-title');
            if (pageTitle && i18n.character_title) {
                pageTitle.textContent = i18n.character_title;
            }

            // 브레드크럼
            const navHome = document.getElementById('nav-home');
            const navCurrent = document.getElementById('nav-current');
            if (navHome && i18n.nav_home) navHome.textContent = i18n.nav_home;
            if (navCurrent && i18n.nav_character) navCurrent.textContent = i18n.nav_character;

            // 필터 그룹 제목들
            const filterGroups = document.querySelectorAll('.filter-group h3');
            const filterTitles = [i18n.filter_element, i18n.filter_position, i18n.filter_type, i18n.filter_tag];
            filterGroups.forEach((title, index) => {
                if (filterTitles[index]) {
                    title.textContent = filterTitles[index];
                }
            });
        }
    }

    // 스포일러 토글 초기화 함수
    function initializeSpoilerToggle() {
        const spoilerToggle = document.getElementById('spoilerToggle');
        const spoilerToggleText = document.getElementById('spoilerToggleText');

        if (!spoilerToggle || !spoilerToggleText) return;

        // 저장된 상태 복원
        const savedState = localStorage.getItem('spoilerToggle') === 'true';
        spoilerToggle.checked = savedState;

        // 언어별 텍스트 설정
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';
        const toggleTexts = {
            kr: '스포일러 보기',
            en: 'Show Spoilers',
            jp: 'スポイラー表示'
        };
        spoilerToggleText.textContent = toggleTexts[currentLang] || toggleTexts.kr;

        // 토글 이벤트 리스너
        spoilerToggle.addEventListener('change', function () {
            const isEnabled = this.checked;
            localStorage.setItem('spoilerToggle', isEnabled.toString());

            console.log('Spoiler toggle changed:', isEnabled);

            // 페이지 새로고침
            window.location.reload();
        });

        // EN/JP에서만 토글 표시 (KR에서는 숨김)
        const spoilerContainer = document.querySelector('.spoiler-toggle-container');
        if (spoilerContainer) {
            if (currentLang === 'kr') {
                spoilerContainer.style.display = 'none';
            } else {
                spoilerContainer.style.display = 'block';
            }
        }
    }

    // 페이지 로드 시 초기화 (통합된 초기화 함수)
    document.addEventListener('DOMContentLoaded', async () => {
        // console.log('DOMContentLoaded event fired');

        // 기본 초기화 작업
        Navigation.load('character'); // nav active
        VersionChecker.check();

        // SEO 설정 업데이트
        updateSEOContent();

        // 언어 라우터 초기화 및 콘텐츠 업데이트
        if (typeof LanguageRouter !== 'undefined') {
            // 이미 언어 파라미터가 있거나 직접 접근한 경우 리다이렉션 없이 진행
            const hasLangParam = window.location.search.includes('lang=');
            if (hasLangParam) {
                // 언어 파라미터가 있으면 바로 콘텐츠 로드
                updateLanguageContent().then(async () => {
                    await initializePageContent();
                });
            } else {
                // 언어 파라미터가 없으면 기본 한국어로 설정하고 콘텐츠 로드
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('lang', 'kr');
                window.history.replaceState({}, '', currentUrl);

                updateLanguageContent().then(async () => {
                    await initializePageContent();
                });
            }
        } else {
            updateLanguageContent();
            await initializePageContent();
        }

        // 스포일러 토글 초기화
        initializeSpoilerToggle();
    });

    // 추가 안전장치: window.onload에서도 체크
    window.addEventListener('load', async () => {
        // console.log('Window load event fired');
        if (!isInitialized) {
            // console.log('Page not initialized yet, running initialization...');
            await initializePageContent();
        } else {
            // console.log('Page already initialized, skipping...');
        }
    });

</script>