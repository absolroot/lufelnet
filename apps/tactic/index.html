---
layout: default
custom_css: [tactic]
custom_js: [tooltip, tactic/share, tactic/library-loader, tactic/import, tactic/export,  tactic/setwonder, tactic/setparty, tactic/partyimg, tactic/createAction, tactic/renderTurns, tactic/updateAuto, tactic/findPattern, tactic/capture]
custom_data: [/data/character_info.js, tooltip.js, tactic/pattern.js,  revelations/revelations.js, wonder/weapons.js, wonder/skills.js]
permalink: /tactic/
language: kr
title : íƒí‹± ë©”ì´ì»¤ - í˜ë¥´ì†Œë‚˜5 ë” íŒ¬í…€ X ë£¨í˜ë¥´ë„·
description: í˜ë¥´ì†Œë‚˜5 ë” íŒ¬í…€ X íƒí‹± ë©”ì´ì»¤
---
{% include supabase-config.html %}

  <!-- í˜ë¥´ì†Œë‚˜ ìˆœì„œ ë° ë¡œë” (window.personaFiles êµ¬ì„±) -->
  <script src="{{ site.baseurl }}/data/persona/order.js?v={{ site.time | date: '%s' }}"></script>
  <script src="{{ site.baseurl }}/assets/js/persona-loader.js?v={{ site.time | date: '%s' }}"></script>
  <script>
    if (typeof ensurePersonaFilesLoaded === 'function') {
      ensurePersonaFilesLoaded();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

    <div class="main-wrapper">
      <!-- navigation path -->
      <div class="navigation-path">
        <script>document.write(`<a href="../../?v=${APP_VERSION}">í™ˆ</a>`);</script>
        <span class="separator">/</span>
        <span class="current-page">íƒí‹± / íƒí‹± ë©”ì´ì»¤</span>
    </div>
    <div class="header-container">
      <div class="logo-container-tactic"> <!-- link to current page -->
        <!--
        <a href="../index.html">
          <img src="../img/logo/P5Xlogo.png" alt="Persona5X Logo" />
        </a>-->
        <div class="title-input-container">
          <input type="text" 
                 class="title-input" 
                 value="í˜ë¥´ì†Œë‚˜5X íƒí‹± ë©”ì´ì»¤" 
                 style="color: white;">
        </div>
      </div>
      <div class="top-buttons">
        <!-- KR List Toggle (Desktop) - placed just left of Export -->
        <label class="kr-toggle-container" title="Force party dropdown to use KR list">
          <input type="checkbox" id="forceKRListToggleDesktop" />
          <span class="kr-toggle-label">KR character list</span>
        </label>
        <button class="export-import-btn" onclick="exportData()">ë‚´ë³´ë‚´ê¸°</button>
        <button class="export-import-btn" onclick="importData()">ê°€ì ¸ì˜¤ê¸°</button>
        <!--<button class="export-import-btn" onclick="handleShare()">ê³µìœ í•˜ê¸°</button>-->
        <button class="export-import-btn capture-btn" onclick="captureAndDownload()">í™”ë©´ ìº¡ì²˜</button>
        <button class="export-import-btn toggle-ui-btn" onclick="toggleUI()"></button>
      </div>
      <!-- KR List Toggle (Mobile) - a new row under export/import -->
      <div class="kr-toggle-mobile">
        <label>
          <input type="checkbox" id="forceKRListToggleMobile" />
          <span class="kr-toggle-mobile-label">KR character list</span>
        </label>
      </div>
    </div>
    
    <!-- tab button (under header-container) development-->
    <!--
    <div class="tab-container">
      <button class="tab-button active" data-tab="tactic">íƒí‹± ì„¤ì •</button>
      <button class="tab-button" data-tab="simulator">ì‹œë®¬ë ˆì´í„°</button>
    </div>
    -->
    <!-- tab content area -->
    <div class="tab-content">
      <!-- tactic setting tab -->
      <div id="tactic" class="tab-pane active">
        <!-- top container: (1) wonder setting, (2) party selection -->
        <div id="top-container">
          <!-- wonder setting card -->
          <div class="card wonder-setting" id="wonder-config">
            <h2>ì›ë” ì„¤ì •</h2>
            <div class="weapon-container">
              <label>ë¬´ê¸°
                <input type="text" class="wonder-weapon-input" list="weapon-list" placeholder="ì„ íƒ ë˜ëŠ” ì…ë ¥" />
              </label>
              <datalist id="weapon-list">
                <!-- JavaScript will fill this -->
              </datalist>
            </div>
            <div class="persona-container">
              <label>í˜ë¥´ì†Œë‚˜1
                <input type="text" class="wonder-persona-input" data-persona-index="0" />
              </label>
              <div class="skill-inputs">
                <input type="text" class="persona-skill-input" data-persona-index="0" data-skill-slot="0" list="persona-skills-list" placeholder="ê³ ìœ ìŠ¤í‚¬" />
                <input type="text" class="persona-skill-input" data-persona-index="0" data-skill-slot="1" list="persona-skills-list" placeholder="ìŠ¤í‚¬ 2" />
                <input type="text" class="persona-skill-input" data-persona-index="0" data-skill-slot="2" list="persona-skills-list" placeholder="ìŠ¤í‚¬ 3" />
              </div>
            </div>
            <div class="persona-container">
              <label>í˜ë¥´ì†Œë‚˜2
                <input type="text" class="wonder-persona-input" data-persona-index="1" />
              </label>
              <div class="skill-inputs">
                <input type="text" class="persona-skill-input" data-persona-index="1" data-skill-slot="0" list="persona-skills-list" placeholder="ê³ ìœ ìŠ¤í‚¬" />
                <input type="text" class="persona-skill-input" data-persona-index="1" data-skill-slot="1" list="persona-skills-list" placeholder="ìŠ¤í‚¬ 2" />
                <input type="text" class="persona-skill-input" data-persona-index="1" data-skill-slot="2" list="persona-skills-list" placeholder="ìŠ¤í‚¬ 3" />
              </div>
            </div>
            <div class="persona-container">
              <label>í˜ë¥´ì†Œë‚˜3
                <input type="text" class="wonder-persona-input" data-persona-index="2" />
              </label>
              <div class="skill-inputs">
                <input type="text" class="persona-skill-input" data-persona-index="2" data-skill-slot="0" list="persona-skills-list" placeholder="ê³ ìœ ìŠ¤í‚¬" />
                <input type="text" class="persona-skill-input" data-persona-index="2" data-skill-slot="1" list="persona-skills-list" placeholder="ìŠ¤í‚¬ 2" />
                <input type="text" class="persona-skill-input" data-persona-index="2" data-skill-slot="2" list="persona-skills-list" placeholder="ìŠ¤í‚¬ 3" />
              </div>
            </div>
          </div>
          
          <!-- party selection card -->
          <div class="card" id="party-selection">
            <h2>ê´´ë„ë‹¨</h2>
            <div class="party-member" data-index="0">
              <div class="input-group">
                <label>ê´´ë„ 1</label>
                <select class="party-name">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì˜ì‹</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>ìˆœì„œ</label>
                <select class="party-order" style="width: 50px;">
                  <option value="1" selected>1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì£¼</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì¼ì›”ì„±ì§„</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
            <div class="party-member" data-index="1">
              <div class="input-group">
                <label>ê´´ë„ 2</label>
                <select class="party-name">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì˜ì‹</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>ìˆœì„œ</label>
                <select class="party-order" style="width: 50px;">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì£¼</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì¼ì›”ì„±ì§„</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
            <div class="party-member" data-index="2">
              <div class="input-group">
                <label>ê´´ë„ 3</label>
                <select class="party-name">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì˜ì‹</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>ìˆœì„œ</label>
                <select class="party-order" style="width: 50px;">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3" selected>3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì£¼</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì¼ì›”ì„±ì§„</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
            <div class="party-member" data-index="3">
              <div class="input-group">
                <label>ê´´ë„ 4</label>
                <select class="party-name">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì˜ì‹</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>ìˆœì„œ</label>
                <select class="party-order" style="width: 50px;">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4" selected>4</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì£¼</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì¼ì›”ì„±ì§„</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
            <div class="party-member" data-index="4">
              <div class="input-group">
                <label>í•´ëª… -</label>
                <select class="party-name">
                  <option value="">-</option>
                  <!-- supportParty ëª©ë¡ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                </select>
              </div>
              <div class="input-group">
                <label>ì˜ì‹</label>
                <select class="party-ritual" style="width: 50px;">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
              <div class="input-group">
                <label>ìˆœì„œ</label>
                <select class="party-order" style="width: 50px;">
                  <option value="-" selected>-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì£¼</label>
                <select class="main-revelation">
                  <option value="">-</option>
                </select>
              </div>
              <div class="input-group">
                <label>ì¼ì›”ì„±ì§„</label>
                <select class="sub-revelation" disabled>
                  <option value="">-</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <!-- container for party images -->
        <div class = "middle-contianer">
          <div class="party-images-container">
            <div class="party-images"></div>
          </div>
          <!--<div class="madeby">.</div>-->
        </div>

        <!-- turn area (6 turns) -->
        <div class="mobile-buttons">
          <button class="mobile-lock-btn" onclick="toggleTurnsLock()">ìˆœì„œ ì´ë™ ì ê¸ˆ</button>
          <button class="toggle-ui-btn" onclick="toggleUI()"></button>
        </div>
        <div id="turns">
          <!-- existing turn content -->
        </div>
      </div>

      
      </div>
    </div>

    <!-- SortableJS (drag and drop library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script defer src="{{ site.baseurl }}/i18n/service/i18n-adapter.js?v={{ site.time | date: '%s' }}"></script>
    <script>
      /* ========== Global data ========== */
      // Wonder persona 3 slots
      let wonderPersonas = ["","",""];
      
      // Party member info (5 members)
      let partyMembers = [
        { index: 0, name: "ì›ë”", order: "1", ritual: "" },
        { index: 1, name: "", order: "2", ritual: "" },
        { index: 2, name: "", order: "3", ritual: "" },
        { index: 3, name: "", order: "4", ritual: "" },
        { index: 4, name: "", order: "-", ritual: "" }
      ];
      
      // Turn data (6 turns). Each turn contains an actions array (auto+manual actions).
      let turns = [];
      for (let i = 0; i < 6; i++) {
        turns.push({
          turn: i + 1,
          actions: [
            /* Example: { type: 'auto', character: 'Wonder', action: '', wonderPersona: '' } */
          ]
        });
      }

      // í˜„ì¬ ì–¸ì–´ ê°ì§€ í•¨ìˆ˜
      function getCurrentLanguage() {
        if (typeof LanguageRouter !== 'undefined' && typeof LanguageRouter.getCurrentLanguage === 'function') {
          const routedLang = LanguageRouter.getCurrentLanguage();
          if (routedLang && ['kr', 'en', 'jp'].includes(routedLang)) {
            return routedLang;
          }
        }

        // URL íŒŒë¼ë¯¸í„° ì²´í¬
        const urlParams = new URLSearchParams(window.location.search);
        const urlLang = urlParams.get('lang');
        if (urlLang && ['kr', 'en', 'jp'].includes(urlLang)) {
          return urlLang;
        }
        
        // localStorage ì²´í¬
        const savedLang = localStorage.getItem('preferredLanguage');
        if (savedLang && ['kr', 'en', 'jp'].includes(savedLang)) {
          return savedLang;
        }
        
        // ê¸°ë³¸ê°’
        return 'kr';
      }

      function getI18nValue(key, fallback = '') {
        if (typeof window.t === 'function') {
          return window.t(key, fallback);
        }
        if (window.I18nService && typeof window.I18nService.t === 'function') {
          return window.I18nService.t(key, fallback);
        }
        return fallback;
      }

      function getTacticToggleLabels() {
        return {
          off: getI18nValue('toggleUiHide', 'ğŸ•¶ï¸ í¸ì§‘ UI ìˆ¨ê¹€'),
          on: getI18nValue('toggleUiShow', 'ğŸ” í¸ì§‘ UI í‘œì‹œ'),
          title: getI18nValue('toggleUiTitle', 'í¸ì§‘ UI í† ê¸€')
        };
      }

      window.getTacticToggleLabels = getTacticToggleLabels;

      // ì–¸ì–´ë³„ characters.jsë¥¼ ìƒŒë“œë°•ìŠ¤ì—ì„œ í‰ê°€í•´ ìˆœìˆ˜ ë°ì´í„°ë§Œ ì¶”ì¶œ
      async function fetchCharactersData(url) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const text = await res.text();
          const sandbox = {};
          const win = (new Function('window', `${text}\n; return window;`))(sandbox);
          const list = win.characterList || { mainParty: [], supportParty: [] };
          const data = win.characterData || {};
          return { characterList: list, characterData: data };
        } catch (e) {
          return null;
        }
      }

      // KR ë°ì´í„°ë¥¼ ê¸°ë³¸ìœ¼ë¡œ, ì–¸ì–´ ë°ì´í„°ê°€ ì œê³µí•˜ëŠ” í‘œì‹œìš© í•„ë“œë§Œ ë®ì–´ì”€
      function mergeCharacterData(krData, langData) {
        const mergedData = {};
        const currentLang = getCurrentLanguage();
        
        // KR ë°ì´í„°ì˜ ëª¨ë“  í‚¤ë¥¼ ë¨¼ì € ë³µì‚¬í•˜ê³ , ì–¸ì–´ë³„ name ì„¤ì •
        Object.keys(krData || {}).forEach(key => {
          mergedData[key] = { ...krData[key] };
          const krChar = krData[key];
          // ì–¸ì–´ë³„ name í•„ë“œ ì„¤ì • (kr ë°ì´í„°ì˜ name_en/name_jp ì‚¬ìš©)
          if (currentLang === 'en' && krChar.name_en) {
            mergedData[key].name = krChar.name_en;
          } else if (currentLang === 'jp' && krChar.name_jp) {
            mergedData[key].name = krChar.name_jp;
          }
          // krì¼ ë•ŒëŠ” ì›ë³¸ name ìœ ì§€ (ì´ë¯¸ ë³µì‚¬ë¨)
        });
        
        // langDataì˜ í‚¤ë¡œ ì¶”ê°€ í•„ë“œ ì—…ë°ì´íŠ¸ (role, tag, release_order ë“±)
        Object.keys(langData || {}).forEach(key => {
          const langChar = langData[key];
          if (!mergedData[key]) return; // krDataì— ì—†ëŠ” ìºë¦­í„°ëŠ” ë¬´ì‹œ
          if (langChar?.role) mergedData[key].role = langChar.role;
          if (langChar?.tag) mergedData[key].tag = langChar.tag;
          if (typeof langChar?.release_order !== 'undefined' && langChar.release_order !== 0) {
            mergedData[key].release_order = langChar.release_order;
          }
        });
        
        
        return mergedData;
      }

      // ì „ì—­ window.characterData/window.characterListë¥¼ ì–¸ì–´/í† ê¸€ì— ë§ê²Œ ì¤€ë¹„
      // setparty.jsì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì „ì—­ ë…¸ì¶œ
      let __ensureCharacterDataLoadedPromise = null;
      window.ensureCharacterDataLoaded = async function ensureCharacterDataLoaded() {
        // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ê¸°ë‹¤ë¦¼
        if (__ensureCharacterDataLoadedPromise) {
          return await __ensureCharacterDataLoadedPromise;
        }
        
        __ensureCharacterDataLoadedPromise = (async () => {
          const lang = getCurrentLanguage();
          let forceKR = false;
          try { forceKR = localStorage.getItem('forceKRList') === 'true'; } catch (_) {}
          const kr = await fetchCharactersData(`/data/character_info.js?v=${APP_VERSION}`);
          if (!kr) {
            __ensureCharacterDataLoadedPromise = null;
            return false;
          }
          if (lang === 'kr') {
            window.characterData = kr.characterData || {};
            window.characterList = kr.characterList || { mainParty: [], supportParty: [] };
            __ensureCharacterDataLoadedPromise = null;
            return true;
          }
          const langDataPath = (lang === 'en' || lang === 'jp')
            ? '/data/character_info_glb.js'
            : `/data/${lang}/characters/characters.js`;
          const lg = await fetchCharactersData(`${langDataPath}?v=${APP_VERSION}`);
          if (!lg) {
            window.characterData = kr.characterData || {};
            window.characterList = kr.characterList || { mainParty: [], supportParty: [] };
            __ensureCharacterDataLoadedPromise = null;
            return true;
          }
          const merged = mergeCharacterData(kr.characterData || {}, lg.characterData || {});
          window.characterData = merged;
          window.characterList = forceKR ? (kr.characterList || { mainParty: [], supportParty: [] })
                                         : (lg.characterList || { mainParty: [], supportParty: [] });
          __ensureCharacterDataLoadedPromise = null;
          return true;
        })();
        
        return await __ensureCharacterDataLoadedPromise;
      };

      function setTextNodePreserveChildren(element, text) {
        if (!element || text == null) return;
        const textNode = Array.from(element.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
        if (textNode) {
          textNode.nodeValue = text;
        } else {
          element.insertBefore(document.createTextNode(text), element.firstChild);
        }
      }

      function setLabelText(selector, key, fallback) {
        const label = document.querySelector(selector);
        if (!label) return;
        setTextNodePreserveChildren(label, getI18nValue(key, fallback));
      }

      function setInputPlaceholder(selector, key, fallback) {
        const input = document.querySelector(selector);
        if (!input) return;
        input.placeholder = getI18nValue(key, fallback);
      }

      function applyPartyRowLabels(index, firstLabelKey, firstLabelFallback) {
        const row = document.querySelector(`.party-member[data-index="${index}"]`);
        if (!row) return;
        const labels = row.querySelectorAll('.input-group > label');
        if (labels[0]) setTextNodePreserveChildren(labels[0], getI18nValue(firstLabelKey, firstLabelFallback));
        if (labels[1]) setTextNodePreserveChildren(labels[1], getI18nValue('labelRitual', 'ì˜ì‹'));
        if (labels[2]) setTextNodePreserveChildren(labels[2], getI18nValue('labelOrder', 'ìˆœì„œ'));
        if (labels[3]) setTextNodePreserveChildren(labels[3], getI18nValue('labelMain', 'ì£¼'));
        if (labels[4]) setTextNodePreserveChildren(labels[4], getI18nValue('labelSub', 'ì¼ì›”ì„±ì§„'));
      }

      function applyStaticI18nTexts() {
        const navHome = document.querySelector('.navigation-path a');
        if (navHome) navHome.textContent = getI18nValue('navHome', 'í™ˆ');

        const navCurrent = document.querySelector('.navigation-path .current-page');
        if (navCurrent) navCurrent.textContent = getI18nValue('navCurrent', 'íƒí‹± / íƒí‹± ë©”ì´ì»¤');

        const titleInput = document.querySelector('.title-input');
        if (titleInput) {
          const defaults = new Set([
            'í˜ë¥´ì†Œë‚˜5X íƒí‹± ë©”ì´ì»¤',
            'P5X Tactic Maker',
            'P5X ã‚¿ã‚¯ãƒ†ã‚£ãƒƒã‚¯ãƒ¡ãƒ¼ã‚«ãƒ¼'
          ]);
          if (!titleInput.value || defaults.has(titleInput.value.trim())) {
            titleInput.value = getI18nValue('pageTitle', 'í˜ë¥´ì†Œë‚˜5X íƒí‹± ë©”ì´ì»¤');
          }
        }

        const exportBtn = document.querySelector('button[onclick="exportData()"]');
        if (exportBtn) exportBtn.textContent = getI18nValue('buttonExport', 'ë‚´ë³´ë‚´ê¸°');
        const importBtn = document.querySelector('button[onclick="importData()"]');
        if (importBtn) importBtn.textContent = getI18nValue('buttonImport', 'ê°€ì ¸ì˜¤ê¸°');
        const captureBtn = document.querySelector('button.capture-btn');
        if (captureBtn) captureBtn.textContent = getI18nValue('buttonCapture', 'í™”ë©´ ìº¡ì²˜');
        const mobileLockBtn = document.querySelector('.mobile-lock-btn');
        if (mobileLockBtn) mobileLockBtn.textContent = getI18nValue('buttonLockOrder', 'ìˆœì„œ ì´ë™ ì ê¸ˆ');

        const krDesktopLabel = document.querySelector('.kr-toggle-label');
        const krMobileLabel = document.querySelector('.kr-toggle-mobile-label');
        const krDesktopWrap = document.querySelector('.kr-toggle-container');
        const krLabel = getI18nValue('krListLabel', 'KR character list');
        if (krDesktopLabel) krDesktopLabel.textContent = krLabel;
        if (krMobileLabel) krMobileLabel.textContent = krLabel;
        if (krDesktopWrap) krDesktopWrap.setAttribute('title', krLabel);

        setTextNodePreserveChildren(document.querySelector('#wonder-config h2'), getI18nValue('sectionWonder', 'ì›ë” ì„¤ì •'));
        setTextNodePreserveChildren(document.querySelector('#party-selection h2'), getI18nValue('sectionParty', 'ê´´ë„ë‹¨'));

        setLabelText('#wonder-config .weapon-container > label', 'labelWeapon', 'ë¬´ê¸°');
        setInputPlaceholder('#wonder-config .wonder-weapon-input', 'placeholderSelectOrInput', 'ì„ íƒ ë˜ëŠ” ì…ë ¥');

        setLabelText('#wonder-config .persona-container:nth-of-type(2) > label', 'labelPersona1', 'í˜ë¥´ì†Œë‚˜1');
        setLabelText('#wonder-config .persona-container:nth-of-type(3) > label', 'labelPersona2', 'í˜ë¥´ì†Œë‚˜2');
        setLabelText('#wonder-config .persona-container:nth-of-type(4) > label', 'labelPersona3', 'í˜ë¥´ì†Œë‚˜3');

        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="0"][data-skill-slot="0"]', 'placeholderUniqueSkill', 'ê³ ìœ ìŠ¤í‚¬');
        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="0"][data-skill-slot="1"]', 'placeholderSkill2', 'ìŠ¤í‚¬ 2');
        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="0"][data-skill-slot="2"]', 'placeholderSkill3', 'ìŠ¤í‚¬ 3');
        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="1"][data-skill-slot="0"]', 'placeholderUniqueSkill', 'ê³ ìœ ìŠ¤í‚¬');
        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="1"][data-skill-slot="1"]', 'placeholderSkill2', 'ìŠ¤í‚¬ 2');
        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="1"][data-skill-slot="2"]', 'placeholderSkill3', 'ìŠ¤í‚¬ 3');
        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="2"][data-skill-slot="0"]', 'placeholderUniqueSkill', 'ê³ ìœ ìŠ¤í‚¬');
        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="2"][data-skill-slot="1"]', 'placeholderSkill2', 'ìŠ¤í‚¬ 2');
        setInputPlaceholder('#wonder-config .persona-skill-input[data-persona-index="2"][data-skill-slot="2"]', 'placeholderSkill3', 'ìŠ¤í‚¬ 3');

        applyPartyRowLabels(0, 'labelThief1', 'ê´´ë„ 1');
        applyPartyRowLabels(1, 'labelThief2', 'ê´´ë„ 2');
        applyPartyRowLabels(2, 'labelThief3', 'ê´´ë„ 3');
        applyPartyRowLabels(3, 'labelThief4', 'ê´´ë„ 4');
        applyPartyRowLabels(4, 'labelSupport', 'í•´ëª… -');
        applyPartyRowLabels(5, 'labelThief5', 'ê´´ë„ 5');
      }

      

      // ì–¸ì–´ë³„ SEO ì„¤ì • í•¨ìˆ˜
      function updateSEOContent() {
          const fallbackTitle = document.title || 'íƒí‹± ë©”ì´ì»¤ - í˜ë¥´ì†Œë‚˜5 ë” íŒ¬í…€ X ë£¨í˜ë¥´ë„·';
          let metaDescription = document.querySelector('meta[name="description"]');
          const fallbackDescription = (metaDescription && metaDescription.getAttribute('content')) || '';
          const seoTitle = getI18nValue('seoTitle', fallbackTitle);
          const seoDescription = getI18nValue('seoDescription', fallbackDescription);

          document.title = seoTitle;

          metaDescription = document.querySelector('meta[name="description"]');
          if (!metaDescription) {
              metaDescription = document.createElement('meta');
              metaDescription.name = 'description';
              document.head.appendChild(metaDescription);
          }
          metaDescription.setAttribute('content', seoDescription);
          
          let ogTitle = document.querySelector('meta[property="og:title"]');
          if (!ogTitle) {
              ogTitle = document.createElement('meta');
              ogTitle.setAttribute('property', 'og:title');
              document.head.appendChild(ogTitle);
          }
          ogTitle.setAttribute('content', seoTitle);
          
          let ogDescription = document.querySelector('meta[property="og:description"]');
          if (!ogDescription) {
              ogDescription = document.createElement('meta');
              ogDescription.setAttribute('property', 'og:description');
              document.head.appendChild(ogDescription);
          }
          ogDescription.setAttribute('content', seoDescription);
      }




      // ëª¨ë°”ì¼ í† ê¸€ ë²„íŠ¼ ë¼ë²¨ ì„¤ì • (ë‹¤êµ­ì–´)
      function updateToggleUILabels() {
        const labels = getTacticToggleLabels();
        const mobileToggleBtn = document.querySelector('.mobile-buttons .toggle-ui-btn');
        if (mobileToggleBtn) {
          mobileToggleBtn.setAttribute('data-label', labels.off);
          mobileToggleBtn.setAttribute('data-label-active', labels.on);
        }

        // ë°ìŠ¤í¬í†± í† ê¸€ ë²„íŠ¼ì€ ìŠ¤ìœ„ì¹˜í˜•(í…ìŠ¤íŠ¸ ì—†ìŒ)ì´ì§€ë§Œ ì ‘ê·¼ì„±/íŒíŠ¸ë¥¼ ìœ„í•´ title ì œê³µ
        const desktopToggleBtn = document.querySelector('.header-container .toggle-ui-btn');
        if (desktopToggleBtn) {
          desktopToggleBtn.setAttribute('title', labels.title);
        }
      }

      // DOM is loaded, initialize initial settings
      document.addEventListener("DOMContentLoaded", async () => {
        const currentLang = getCurrentLanguage();
        if (typeof initPageI18n === 'function') {
          await initPageI18n('tactic');
          if (typeof setLang === 'function') {
            await setLang(currentLang);
          }
        } else if (window.I18nService && typeof window.I18nService.init === 'function') {
          await window.I18nService.init('tactic', currentLang);
        }

        // ë¨¼ì € UI í…ìŠ¤íŠ¸/ë ˆì´ë¸”ì„ í˜„ì¬ ì–¸ì–´ì— ë§ê²Œ ë²ˆì—­ (ë°ì´í„° ë¡œë”©ê³¼ ë¶„ë¦¬)
        applyStaticI18nTexts();
        updateToggleUILabels();
        // CSSì—ì„œ ì–¸ì–´ë³„ ìŠ¤íƒ€ì¼ ë¶„ê¸°ë¥¼ ìœ„í•´ <html>ì— data-lang ì„¤ì •
        try { document.documentElement.setAttribute('data-lang', getCurrentLanguage()); } catch(_) {}

        // ì–¸ì–´ë³„ ìºë¦­í„° ë°ì´í„° ì¤€ë¹„ (ì „ì—­ ì£¼ì…)
        await ensureCharacterDataLoaded();

        // Initialize KR list toggle UI (desktop + mobile)
        (function initKRListToggle(){
          const currentLang = getCurrentLanguage();
          const desktopWrap = document.querySelector('.kr-toggle-container');
          const mobileWrap = document.querySelector('.kr-toggle-mobile');
          const desktopChk = document.getElementById('forceKRListToggleDesktop');
          const mobileChk = document.getElementById('forceKRListToggleMobile');

          // Hide entirely when KR
          const hideForKR = currentLang === 'kr';
          if (desktopWrap) desktopWrap.style.display = hideForKR ? 'none' : '';
          if (mobileWrap) mobileWrap.style.display = hideForKR ? 'none' : '';

          // Show only one depending on viewport
          function applyViewportVisibility() {
            if (hideForKR) return; // already hidden
            const isMob = (window.innerWidth < 1200);
            if (desktopWrap) desktopWrap.style.display = isMob ? 'none' : '';
            if (mobileWrap) mobileWrap.style.display = isMob ? '' : 'none';
          }
          applyViewportVisibility();
          window.addEventListener('resize', applyViewportVisibility);

          // Load state
          let saved = false;
          try { saved = localStorage.getItem('forceKRList') === 'true'; } catch(_) {}
          if (desktopChk) desktopChk.checked = saved;
          if (mobileChk) mobileChk.checked = saved;

          async function applyChange(val){
            try { localStorage.setItem('forceKRList', String(val)); } catch(_) {}
            // Close any open dropdowns by blurring focused input to refresh on next open
            if (document.activeElement && document.activeElement.blur) {
              document.activeElement.blur();
            }
            // Live refresh party dropdowns: ensure translations ready first
            try {
              // ì „ì—­ characterListë¥¼ í† ê¸€ ìƒíƒœì— ë§ì¶° ê°±ì‹ 
              await ensureCharacterDataLoaded();
              // characterData ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
              if (typeof window.notifyCharacterDataReady === 'function') {
                window.notifyCharacterDataReady();
              }
              if (typeof setupTranslations === 'function') {
                setupTranslations()
                  .then(() => { try { if (typeof setupPartySelection === 'function') setupPartySelection(); } catch(_) {} })
                  .catch(() => { try { if (typeof setupPartySelection === 'function') setupPartySelection(); } catch(_) {} });
              } else {
                if (typeof setupPartySelection === 'function') { setupPartySelection(); }
              }
            } catch(_) {}
          }

          // Sync handlers
          if (desktopChk) desktopChk.addEventListener('change', (e)=>{
            const v = e.target.checked;
            if (mobileChk) mobileChk.checked = v;
            applyChange(v);
          });
          if (mobileChk) mobileChk.addEventListener('change', (e)=>{
            const v = e.target.checked;
            if (desktopChk) desktopChk.checked = v;
            applyChange(v);
          });
        })();

        // Initialize navigation (guarded)
        try { if (typeof Navigation !== 'undefined' && Navigation.load) { Navigation.load('tactic'); } } catch(_) {}
        try { if (typeof VersionChecker !== 'undefined' && VersionChecker.check) { VersionChecker.check(); } } catch(_) {}
        updateSEOContent();

        function isMobile() {
          return window.innerWidth < 1200;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const sharedData = urlParams.get('data');
        const libraryParam = urlParams.get('library');
        
        // ë²ˆì—­ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
        async function loadTranslationData() {
          const currentLang = getCurrentLanguage();
          if (currentLang !== 'kr') {
            // setparty.jsì˜ setupTranslations í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ í˜¸ì¶œ
            if (typeof setupTranslations === 'function') {
              await setupTranslations();
            }
          }
        }
        
        if (sharedData) {
          // ë²ˆì—­ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•œ í›„ ê³µìœ  ë°ì´í„° ì²˜ë¦¬
          loadTranslationData().then(() => {
            const decodedData = processSharedData(sharedData);

            if (isMobile()) {
              const lockBtn = document.querySelector('.mobile-lock-btn');
              const turnsContainer = document.getElementById('turns');
              if (lockBtn && turnsContainer) {
                lockBtn.classList.add('active');
                turnsContainer.classList.add('turns-locked');
                localStorage.setItem('turnsLocked', true);
              }
            }
            
            // If shared data, set UI to hidden state by default (guarded)
            const containerEl = document.querySelector('.container');
            if (containerEl) { containerEl.classList.add('hide-ui'); }
            const desktopToggleBtn = document.querySelector('.header-container .toggle-ui-btn');
            const mobileToggleBtn = document.querySelector('.mobile-buttons .toggle-ui-btn');
            if (desktopToggleBtn) desktopToggleBtn.classList.add('active');
            if (mobileToggleBtn) mobileToggleBtn.classList.add('active');

            //console.log(decodedData);

            if (decodedData) {
              // Add title setting
              document.querySelector('.title-input').value = decodedData.title;
              
              // Set Wonder persona data
              wonderPersonas = decodedData.w;
              
              // Set Wonder persona data
              const wonderInputs = document.querySelectorAll(".wonder-persona-input");
              wonderInputs.forEach((input, idx) => {
                input.value = wonderPersonas[idx] || "";
              });

              // Set Wonder weapon
              document.querySelector(".wonder-weapon-input").value = decodedData.weapon;

              // Set persona skills
              const skillInputs = document.querySelectorAll(".persona-skill-input");
              let normalSkillIndex = 0;  // Normal skill index

              skillInputs.forEach((input, index) => {
                  // Unique skill slot
                  if (index % 3 === 0) {
                      const personaIndex = Math.floor(index / 3);
                      const selectedPersona = decodedData.w[personaIndex];
                      try {
                          const store = (typeof window !== 'undefined' && window.personaFiles && Object.keys(window.personaFiles).length)
                            ? window.personaFiles
                            : (typeof personaData !== 'undefined' ? personaData : (window.persona && window.persona.personaData) || {});
                          if (selectedPersona && store[selectedPersona] && store[selectedPersona].uniqueSkill) {
                              input.value = store[selectedPersona].uniqueSkill.name;
                              input.disabled = true;
                              input.classList.add('unique-skill');
                          }
                      } catch (_) { /* noop */ }
                  } 
                  // Normal skill slot
                  else {
                      if (decodedData.personaSkills[normalSkillIndex]) {
                          input.value = decodedData.personaSkills[normalSkillIndex];
                      }
                      normalSkillIndex++;
                  }
              });
              
              // Restore partyMembers data
              decodedData.p.forEach((p, idx) => {
                partyMembers[idx].name = p.name;
                partyMembers[idx].order = p.order;
                partyMembers[idx].ritual = p.ritual;
                
                // Update party member name input field
                const partyDiv = document.querySelector(`.party-member[data-index="${idx}"]`);
                if (partyDiv) {
                  const nameInput = partyDiv.querySelector(".party-name-input");
                  const orderSelect = partyDiv.querySelector(".party-order");
                  const ritualSelect = partyDiv.querySelector(".party-ritual");
                  const mainRevSelect = partyDiv.querySelector(".main-revelation");
                  const subRevSelect = partyDiv.querySelector(".sub-revelation");
                  
                  if (nameInput) nameInput.value = p.name || "";
                  if (orderSelect) orderSelect.value = p.order || "";
                  if (ritualSelect) ritualSelect.value = p.ritual || "0";
                  
                  // Set revelation
                  if (mainRevSelect && p.mainRev) {
                    mainRevSelect.value = p.mainRev;
                    // When main revelation is selected, activate sub revelation
                    if (p.mainRev && revelationData.main[p.mainRev]) {
                      subRevSelect.disabled = false;
                      // Set sub revelation options
                      subRevSelect.innerHTML = '<option value="">-</option>';
                      revelationData.main[p.mainRev].forEach(subRev => {
                        const opt = document.createElement("option");
                        opt.value = subRev;
                        opt.textContent = subRev;
                        subRevSelect.appendChild(opt);
                      });
                      // Set sub revelation value
                      if (p.subRev) {
                        subRevSelect.value = p.subRev;
                      }
                    }
                  }
                  
                  // If Wonder, disable ritual and revelation
                  if (p.n === "ì›ë”") {
                    if (ritualSelect) {
                      ritualSelect.disabled = true;
                      ritualSelect.value = "0";
                    }
                    if (mainRevSelect) mainRevSelect.disabled = true;
                    if (subRevSelect) subRevSelect.disabled = true;
                  }
                }
              });
              
              // Restore turn data
              turns = decodedData.t;
              
              // Default UI settings
              setupWonderConfig();
              try {
                if (typeof setupTranslations === 'function') {
                  setupTranslations()
                    .then(() => { try { setupPartySelection(); } catch(_) {} })
                    .catch(() => { try { setupPartySelection(); } catch(_) {} });
                } else {
                  setupPartySelection();
                }
              } catch(_) { setupPartySelection(); }

              // ë²ˆì—­ ì ìš© (ê³µìœ  ë°ì´í„° ë¡œë“œ í›„)
              const currentLang = getCurrentLanguage();
              if (currentLang !== 'kr') {
                // ì›ë” ë¬´ê¸° ë²ˆì—­ ì ìš©
                const weaponInput = document.querySelector('.wonder-weapon-input');
                if (weaponInput && weaponInput.value) {
                  // ë²ˆì—­ëœ ë¬´ê¸° ì´ë¦„ìœ¼ë¡œ í‘œì‹œí•˜ë˜, ì‹¤ì œ ê°’ì€ í•œêµ­ì–´ ìœ ì§€
                  const weaponName = weaponInput.value;
                  const inputContainer = weaponInput.closest('.input-container');
                  if (inputContainer && matchWeapons[weaponName]) {
                    const weapon = matchWeapons[weaponName];
                    let displayName = weaponName;
                    if (currentLang === 'en' && weapon.name_en) {
                      displayName = weapon.name_en;
                    } else if (currentLang === 'jp' && weapon.name_jp) {
                      displayName = weapon.name_jp;
                    }
                    inputContainer.setAttribute('data-display-text', displayName);
                    inputContainer.classList.add('show-translation');
                  }
                }

                // í˜ë¥´ì†Œë‚˜ ê³ ìœ  ìŠ¤í‚¬ ë²ˆì—­ ì ìš©
                const skillInputs = document.querySelectorAll('.persona-skill-input');
                skillInputs.forEach((input, index) => {
                  if (index % 3 === 0 && input.value) { // ê³ ìœ  ìŠ¤í‚¬ ìŠ¬ë¡¯
                    const personaIndex = Math.floor(index / 3);
                    const selectedPersona = decodedData.w[personaIndex];
                    const store = (typeof window !== 'undefined' && window.personaFiles && Object.keys(window.personaFiles).length)
                      ? window.personaFiles
                      : (typeof personaData !== 'undefined' ? personaData : (window.persona && window.persona.personaData) || {});
                    if (selectedPersona && store[selectedPersona]) {
                      const persona = store[selectedPersona];
                      const u = persona.uniqueSkill || {};
                      let displayName = input.value;
                      if (currentLang === 'en' && u.name_en) {
                        displayName = u.name_en;
                      } else if (currentLang === 'jp' && u.name_jp) {
                        displayName = u.name_jp;
                      }
                      const inputContainer = input.closest('.input-container');
                      if (inputContainer) {
                        inputContainer.setAttribute('data-display-text', displayName);
                        inputContainer.classList.add('show-translation');
                      }
                    }
                  }
                });

                // íŒŒí‹°ì› ìºë¦­í„° ì´ë¦„ ë²ˆì—­ ì ìš©
                document.querySelectorAll('.party-name-input').forEach(input => {
                  if (input.value) {
                    const charName = input.value;
                    const inputContainer = input.closest('.input-container');
                    // window.characterDataë§Œ ì‚¬ìš© (ë³‘í•©ëœ ë°ì´í„°, ì „ì—­ characterDataëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
                    const charData = (typeof window !== 'undefined' && window.characterData) ? window.characterData : null;
                    if (inputContainer && charData && charData[charName]) {
                      const char = charData[charName];
                      // ë³‘í•©ëœ ë°ì´í„°ì˜ name í•„ë“œ ìš°ì„  ì‚¬ìš© (ì´ë¯¸ ì–¸ì–´ë³„ë¡œ ì„¤ì •ë¨)
                      let displayName = (char.name && char.name !== charName) ? char.name : charName;
                      // í´ë°±: name í•„ë“œê°€ ì—†ê±°ë‚˜ ì›ë³¸ê³¼ ê°™ìœ¼ë©´ name_en/name_jp í™•ì¸
                      if (displayName === charName) {
                        if (currentLang === 'en' && char.name_en) {
                          displayName = char.name_en;
                        } else if (currentLang === 'jp' && char.name_jp) {
                          displayName = char.name_jp;
                        }
                      }
                      inputContainer.setAttribute('data-display-text', displayName);
                      inputContainer.classList.add('show-translation');
                    }
                  }
                });
              }

              // Reset revelation values
              decodedData.p.forEach((p, idx) => {
                const partyDiv = document.querySelector(`.party-member[data-index="${idx}"]`);
                if (partyDiv && p.mainRev) {
                  const mainRevSelect = partyDiv.querySelector(".main-revelation");
                  const subRevSelect = partyDiv.querySelector(".sub-revelation");
                  
                  if (mainRevSelect) {
                    mainRevSelect.value = p.mainRev;
                    
                    if (revelationData.main[p.mainRev]) {
                      subRevSelect.disabled = false;
                      subRevSelect.innerHTML = '<option value="">-</option>';
                      revelationData.main[p.mainRev].forEach(subRev => {
                        const opt = document.createElement("option");
                        opt.value = subRev;
                        opt.textContent = subRev;
                        subRevSelect.appendChild(opt);
                      });
                      
                      // ê³„ì‹œ ì˜µì…˜ ìƒì„± í›„ ë²ˆì—­ ì ìš©
                      if (currentLang !== 'kr') {
                        for (const option of subRevSelect.options) {
                          if (option.value) {
                            // ë²ˆì—­ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë²ˆì—­ ì ìš©
                            if (window.languageData && window.languageData[currentLang] && window.languageData[currentLang].revelationMapping) {
                              option.textContent = window.languageData[currentLang].revelationMapping[option.value] || option.value;
                            }
                          }
                        }
                      }
                      
                      if (p.subRev) {
                        subRevSelect.value = p.subRev;
                      }
                    }
                  }
                }
              });

              // ê³„ì‹œ ë²ˆì—­ ì ìš© (ê³µìœ  ë°ì´í„° ë¡œë“œ í›„)
              if (currentLang !== 'kr') {
                // ê³„ì‹œ ë²ˆì—­ í•¨ìˆ˜
                function getRevelationDisplayName(revName) {
                  if (!window.languageData || !window.languageData[currentLang] || !window.languageData[currentLang].revelationMapping) {
                    return revName;
                  }
                  const translated = window.languageData[currentLang].revelationMapping[revName] || revName;
                  return translated;
                }

                
                // ê³„ì‹œ ë²ˆì—­ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê°•ì œë¡œ ë¡œë“œ ì‹œë„
                if (!window.languageData || !window.languageData[currentLang] || !window.languageData[currentLang].revelationMapping) {
                  // setparty.jsì˜ setupTranslations í•¨ìˆ˜ í˜¸ì¶œ
                  if (typeof setupTranslations === 'function') {
                    setupTranslations().then(() => {
                      // ë²ˆì—­ ë°ì´í„° ë¡œë“œ í›„ ë‹¤ì‹œ ì‹œë„
                      document.querySelectorAll('.main-revelation, .sub-revelation').forEach(select => {
                        for (const option of select.options) {
                          if (option.value) {
                            option.textContent = getRevelationDisplayName(option.value);
                          }
                        }
                      });
                    });
                  }
                } else {
                  // ëª¨ë“  ê³„ì‹œ ì„ íƒê¸°ì˜ ì˜µì…˜ í…ìŠ¤íŠ¸ ë²ˆì—­
                  document.querySelectorAll('.main-revelation, .sub-revelation').forEach(select => {
                    for (const option of select.options) {
                      if (option.value) {
                        option.textContent = getRevelationDisplayName(option.value);
                      }
                    }
                  });
                }
              }

              // characterData ì¤€ë¹„ í›„ ë Œë”ë§
              const renderAfterDataReady = () => {
                const charData = window.characterData || (typeof characterData !== 'undefined' ? characterData : null);
                const currentLang = (typeof getCurrentLanguage === 'function') ? getCurrentLanguage() : 'kr';
                if (currentLang === 'kr' || (charData && (charData['ì›ë”'] || charData['ë Œ'] || charData['ë ˆì˜¤']))) {
                  updatePartyImages();
                  renderTurns();
                } else {
                  // characterData ëŒ€ê¸° í›„ ì¬ì‹œë„
                  setTimeout(renderAfterDataReady, 200);
                }
              };
              renderAfterDataReady();
              
              // Restore action data for each turn
              turns.forEach((turn, turnIndex) => {
                const turnContainer = document.querySelector(`.turn-container[data-turn-index="${turnIndex}"]`);
                if (!turnContainer) return;

                const actionsList = turnContainer.querySelector('.actions');
                if (!actionsList) return;

                turn.actions.forEach((action, actionIndex) => {
                  const actionItem = actionsList.children[actionIndex]; 
                  if (!actionItem) return;

                  // Select character
                  const charSelect = actionItem.querySelector('.action-character');
                  if (charSelect) {
                    // ì°¸ê³ ì‚¬í•­ ì˜µì…˜ì´ ì—†ìœ¼ë©´ ì¶”ê°€
                    const hasReferenceOption = Array.from(charSelect.options).some(opt => opt.value === '');
                    if (!hasReferenceOption) {
                      const referenceText = getI18nValue('uiReference', 'ì°¸ê³ ì‚¬í•­');
                      const refOption = document.createElement('option');
                      refOption.value = '';
                      refOption.textContent = referenceText;
                      charSelect.insertBefore(refOption, charSelect.firstChild);
                    }
                    charSelect.value = action.character || '';
                  }

                  // Select Wonder persona or skill
                  if (action.character === "ì›ë”") {
                    const personaSelect = actionItem.querySelector('.wonder-persona-select');
                    if (personaSelect) {
                      personaSelect.value = action.wonderPersona;
                    }
                  } else {
                    const skillSelect = actionItem.querySelector('.action-skill');
                    if (skillSelect) {
                      skillSelect.value = action.action;
                    }
                  }

                  // Input memo
                  const memoInput = actionItem.querySelector('.action-memo');
                  if (memoInput) {
                    memoInput.value = action.memo || "";
                  }
                });
              });
              
              // Update auto actions last
              updateAutoActions();
              
            } 
          });
        } else {
          setupWonderConfig();
          try {
            if (typeof setupTranslations === 'function') {
              setupTranslations()
                .then(async () => {
                  try {
                    if (typeof setupPartySelection === 'function') setupPartySelection();
                  } catch(_) {}
                  // ìºë¦­í„°/ê³„ì‹œ ë²ˆì—­ ë°ì´í„°ê°€ ì¤€ë¹„ëœ ì´í›„ íŒŒí‹° ì´ë¦„ ë²ˆì—­ì„ í•œ ë²ˆ ë” ì ìš©
                  try {
                    if (typeof initializePartyTranslations === 'function') await initializePartyTranslations();
                  } catch(_) {}
                })
                .catch(async () => {
                  try {
                    if (typeof setupPartySelection === 'function') setupPartySelection();
                  } catch(_) {}
                  try {
                    if (typeof initializePartyTranslations === 'function') await initializePartyTranslations();
                  } catch(_) {}
                });
            } else {
              if (typeof setupPartySelection === 'function') { setupPartySelection(); }
              try {
                if (typeof initializePartyTranslations === 'function') await initializePartyTranslations();
              } catch(_) {}
            }
          } catch(_) {
            if (typeof setupPartySelection === 'function') { setupPartySelection(); }
            try {
              if (typeof initializePartyTranslations === 'function') await initializePartyTranslations();
            } catch(_) {}
          }
          updateAutoActions();
          // characterData ì¤€ë¹„ í›„ ë Œë”ë§
          const renderAfterDataReady = () => {
            const charData = window.characterData || (typeof characterData !== 'undefined' ? characterData : null);
            const currentLang = (typeof getCurrentLanguage === 'function') ? getCurrentLanguage() : 'kr';
            if (currentLang === 'kr' || (charData && (charData['ì›ë”'] || charData['ë Œ'] || charData['ë ˆì˜¤']))) {
              updatePartyImages();
              renderTurns();
            } else {
              // characterData ëŒ€ê¸° í›„ ì¬ì‹œë„
              setTimeout(renderAfterDataReady, 200);
            }
          };
          renderAfterDataReady();

          // ë°ì´í„°ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ë„ ì—†ëŠ” ìˆœìˆ˜ ì§„ì… ì‹œ, í¸ì§‘ UIë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë³´ì´ê³  í† ê¸€ ë²„íŠ¼ ë¹„í™œì„±í™”
          if (!libraryParam) {
            const containerEl = document.querySelector('.container');
            if (containerEl) containerEl.classList.remove('hide-ui');
            const desktopToggleBtn = document.querySelector('.header-container .toggle-ui-btn');
            const mobileToggleBtn = document.querySelector('.mobile-buttons .toggle-ui-btn');
            if (desktopToggleBtn) desktopToggleBtn.classList.remove('active');
            if (mobileToggleBtn) mobileToggleBtn.classList.remove('active');
            try { localStorage.setItem('uiHidden', false); } catch(_) {}
          }
        }

        // Add skill list to datalist
        const skillsList = document.getElementById('persona-skills-list');
        
        // Add all skills from personaSkillList to datalist
        Object.keys(personaSkillList).forEach(skillName => {
          const option = document.createElement('option');
          option.value = skillName;
          skillsList.appendChild(option);
        });

        // Select searchable dropdown elements
        const searchableInputs = document.querySelectorAll('input[list]');
        
        searchableInputs.forEach(input => {
          // Handle dropdown arrow click with mousedown event
          input.addEventListener('mousedown', function(e) {
            // Detect dropdown arrow click (right 20px area of input field)
            if (e.offsetX > this.offsetWidth - 20) {
              // Clear value and keep focus
              this.value = '';
            }
          });
        });

        const inputFields = document.querySelectorAll('input[type="text"], textarea');
        let lastScrollPosition = 0;

        inputFields.forEach(field => {
            // Use only focus event
            field.addEventListener('focus', function() {
                // Allow natural keyboard display without interfering with default behavior
                setTimeout(() => {
                    const fieldRect = this.getBoundingClientRect();
                    const offset = fieldRect.top - 150;
                    
                    window.scrollTo({
                        top: window.scrollY + offset,
                        behavior: 'auto'
                    });
                }, 300);
            });
        });

        // Initialize keyboard detection on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Update viewport meta tag
            const meta = document.querySelector('meta[name="viewport"]');
            if (meta) {
                meta.setAttribute('content', 
                    'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover'
                );
            }
        });

        // í™”ë©´ í¬ê¸°ì— ë”°ë¼ ìº¡ì²˜ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì„¤ì •
        function updateCaptureButtonVisibility() {
          const captureBtn = document.querySelector('.capture-btn');
          if (captureBtn) {
            if (window.innerWidth <= 1440) {
              captureBtn.style.display = 'none';
            } else {
              captureBtn.style.display = '';
            }
          }
        }
        
        // ì´ˆê¸° ë¡œë“œ ì‹œ ì‹¤í–‰
        updateCaptureButtonVisibility();
        
        // í™”ë©´ í¬ê¸°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì‹¤í–‰
        window.addEventListener('resize', updateCaptureButtonVisibility);

      });


      // Basic URL function
      function getBaseUrl() {
        // Return the base URL of the current page (excluding query parameters)
        return window.location.href.split('?')[0];
      }


      // UI toggle
      function toggleUI() {
        const container = document.querySelector('.container');
        const desktopToggleBtn = document.querySelector('.header-container .toggle-ui-btn');
        const mobileToggleBtn = document.querySelector('.mobile-buttons .toggle-ui-btn');
        
        container.classList.toggle('hide-ui');
        
        // Handle both desktop and mobile buttons
        if (desktopToggleBtn) desktopToggleBtn.classList.toggle('active');
        if (mobileToggleBtn) mobileToggleBtn.classList.toggle('active');
        
        // Save toggle state
        localStorage.setItem('uiHidden', container.classList.contains('hide-ui'));
      }

      // Restore previous state on page load
      document.addEventListener('DOMContentLoaded', () => {
        const uiHidden = localStorage.getItem('uiHidden') === 'true';
        const desktopToggleBtn = document.querySelector('.header-container .toggle-ui-btn');
        const mobileToggleBtn = document.querySelector('.mobile-buttons .toggle-ui-btn');
        
        if (uiHidden) {
          document.querySelector('.container').classList.add('hide-ui');
          if (desktopToggleBtn) desktopToggleBtn.classList.add('active');
          if (mobileToggleBtn) mobileToggleBtn.classList.add('active');
        }

        /* ========================
           ê³„ì‹œ ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
           - ì›ë³¸ select(.main-revelation, .sub-revelation)ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€(í´ë˜ìŠ¤ëª… ë¶ˆë³€)
           - UIë§Œ ì»¤ìŠ¤í…€, ì´ë¯¸ì§€ í‘œì‹œ ë° ë‹¤êµ­ì–´ í‘œì‹œ ìœ ì§€(getRevelationDisplayName ì‚¬ìš©)
        =========================*/
        (function initRevelationCustomDropdowns(){
          // ìŠ¤íƒ€ì¼ì€ assets/css/tactic.cssì— ì •ì˜ë¨

          const BASE = (typeof BASE_URL !== 'undefined' && BASE_URL) ? BASE_URL : '';

          function getRevDisplayText(value){
            try { return (typeof getRevelationDisplayName === 'function') ? getRevelationDisplayName(value) : value; } catch(_) { return value; }
          }

          function buildOptions(select, listEl){
            listEl.innerHTML = '';
            for (const opt of select.options) {
              const val = opt.value;
              const text = val ? getRevDisplayText(val) : '-';
              const item = document.createElement('div');
              item.className = 'rev-option';
              if (val) {
                const img = document.createElement('img');
                img.src = `${BASE}/assets/img/revelation/${val}.webp`;
                img.alt = '';
                img.onerror = function(){ this.style.display = 'none'; };
                item.appendChild(img);
              }
              const span = document.createElement('span');
              span.textContent = text;
              item.appendChild(span);
              item.addEventListener('click', () => {
                select.value = val;
                // change ì´ë²¤íŠ¸ ì „íŒŒ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                select.dispatchEvent(new Event('change', { bubbles: true }));
                updateDisplay(select);
                listEl.classList.remove('active');
              });
              listEl.appendChild(item);
            }
          }

          function updateDisplay(select){
            const wrap = select.closest('.rev-select-wrap');
            if (!wrap) return;
            const disp = wrap.querySelector('.rev-display');
            if (!disp) return;
            const current = select.value;
            const text = current ? getRevDisplayText(current) : '-';
            disp.innerHTML = '';
            if (current) {
              const img = document.createElement('img');
              img.src = `${BASE}/assets/img/revelation/${current}.webp`;
              img.alt = '';
              img.onerror = function(){ this.style.display = 'none'; };
              disp.appendChild(img);
            }
            const span = document.createElement('span');
            span.textContent = text;
            disp.appendChild(span);

            // disabled ìƒíƒœ ë°˜ì˜
            disp.style.opacity = select.disabled ? '0.6' : '1';
            disp.style.pointerEvents = select.disabled ? 'none' : 'auto';
          }

          function enhanceSelect(select){
            if (!select || select.closest('.rev-select-wrap')) return; // ì¤‘ë³µ ë°©ì§€
            const group = select.closest('.input-group') || select.parentElement;
            if (!group) return;

            const wrap = document.createElement('div');
            wrap.className = 'rev-select-wrap';

            const display = document.createElement('div');
            display.className = 'rev-display';

            const list = document.createElement('div');
            list.className = 'rev-options';

            // í´ë¦­ í† ê¸€
            display.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (select.disabled) return;
              // ìš°ì„  ì „ì—­ í¬íƒˆ ì‚¬ìš© (ì¼ê´€ëœ UI)
              if (typeof openPortal === 'function') {
                try { select.blur(); } catch(_) {}
                const type = select.classList.contains('main-revelation') ? 'rev-main' : 'rev-sub';
                const ctx = type === 'rev-sub' ? { mainForSub: (group.querySelector('select.main-revelation') || {}).value } : {};
                openPortal(type, select, {
                  ...ctx,
                  onSelect: (value /* KR */) => {
                    select.value = value;
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                    // í¬íƒˆ ë‚´ë¶€ì—ì„œ ë‹«í˜ ì²˜ë¦¬ë¨
                  }
                });
                return;
              }
              // í¬íƒˆì´ ì—†ë‹¤ë©´ ê¸°ì¡´ ë¡œì»¬ ëª©ë¡ í† ê¸€ë¡œ í´ë°±
              const isActive = list.classList.contains('active');
              document.querySelectorAll('.rev-options.active').forEach(el => el.classList.remove('active'));
              if (!isActive) list.classList.add('active');
            });
            document.addEventListener('click', () => list.classList.remove('active'));

            // êµ¬ì„± ì‚½ì…: label ë‹¤ìŒì— wrapì„ ë„£ê³  select ì´ë™
            const label = group.querySelector('label');
            if (label && label.nextSibling) group.insertBefore(wrap, label.nextSibling); else group.appendChild(wrap);
            wrap.appendChild(display);
            wrap.appendChild(list);
            wrap.appendChild(select); // ì›ë³¸ select ìœ ì§€(í´ë˜ìŠ¤/ì´ë²¤íŠ¸ ê·¸ëŒ€ë¡œ)

            // ì´ˆê¸° í‘œì‹œ/ì˜µì…˜ êµ¬ì„±
            updateDisplay(select);
            buildOptions(select, list);

            // select ë³€ê²½ ì‹œ í‘œì‹œ ê°±ì‹ 
            select.addEventListener('change', () => updateDisplay(select));

            // ì˜µì…˜ ë³€í™” ê°ì§€ (ì£¼ ë³€ê²½ í›„ ì¼ì›”ì„±ì§„ ì˜µì…˜ ê°±ì‹  ëŒ€ì‘)
            const mo = new MutationObserver(() => {
              buildOptions(select, list);
              updateDisplay(select);
            });
            mo.observe(select, { childList: true });

            // disabled/ê°’ ë³€í™”ë„ ì£¼ê¸°ì ìœ¼ë¡œ ë™ê¸°í™” (ì €ë¹ˆë„ í´ë§)
            let lastDisabled = select.disabled;
            let lastValue = select.value;
            setInterval(() => {
              let need = false;
              if (select.disabled !== lastDisabled) {
                lastDisabled = select.disabled;
                need = true;
              }
              if (select.value !== lastValue) {
                lastValue = select.value;
                need = true;
              }
              if (need) updateDisplay(select);
            }, 300);
          }

          function initAll(){
            document.querySelectorAll('select.main-revelation, select.sub-revelation').forEach(enhanceSelect);
          }

          // ì´ˆê¸° ì‹œë„: DOMContentLoaded ì§í›„ + ì•½ê°„ ì§€ì—° í›„ ì¬ì‹œë„(ë™ì  ì˜µì…˜ ì±„ì›€ ëŒ€ë¹„)
          initAll();
          setTimeout(initAll, 400);
          setTimeout(initAll, 1000);
        })();

      });

      function toggleTurnsLock() {
        const lockBtn = document.querySelector('.mobile-lock-btn');
        const turnsContainer = document.getElementById('turns');
        
        lockBtn.classList.toggle('active');
        turnsContainer.classList.toggle('turns-locked');
        
        // Save lock state
        localStorage.setItem('turnsLocked', turnsContainer.classList.contains('turns-locked'));

        renderTurns();
      }

      // Restore previous lock state on page load
      document.addEventListener('DOMContentLoaded', () => {
        const turnsLocked = localStorage.getItem('turnsLocked') === 'true';
        const lockBtn = document.querySelector('.mobile-lock-btn');
        const turnsContainer = document.getElementById('turns');
        
        // PC í™˜ê²½(1200px ì´ìƒ)ì—ì„œëŠ” ì ê¸ˆ í•´ì œ
        if (window.innerWidth >= 1200) {
          if (turnsLocked) {
            localStorage.setItem('turnsLocked', false);
          }
          if (lockBtn) lockBtn.classList.remove('active');
          if (turnsContainer) turnsContainer.classList.remove('turns-locked');
        } else if (turnsLocked) {
          // ëª¨ë°”ì¼ì—ì„œëŠ” ì´ì „ ì ê¸ˆ ìƒíƒœ ìœ ì§€
          if (lockBtn) lockBtn.classList.add('active');
          if (turnsContainer) turnsContainer.classList.add('turns-locked');
        }

        // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œì—ë„ ì ìš©
        window.addEventListener('resize', () => {
          if (window.innerWidth >= 1200) {
            if (lockBtn) lockBtn.classList.remove('active');
            if (turnsContainer) turnsContainer.classList.remove('turns-locked');
            localStorage.setItem('turnsLocked', false);
          }
        });
      });

    </script>
    <script>
      // Mobile/PC accordion for Wonder and Party cards
      (function(){
        const svgArrow = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        const isMobile = () => window.innerWidth <= 1200;
        const sections = {};

        function initSection(cardId){
          const card = document.getElementById(cardId);
          if(!card) return;
          const header = card.querySelector('h2');
          if(!header) return;
          const bodyEls = Array.from(card.children).filter(el => el.tagName && el.tagName.toLowerCase() !== 'h2');
          if(!header.querySelector('.accordion-arrow')){
            const arrow = document.createElement('span');
            arrow.className = 'accordion-arrow';
            arrow.innerHTML = svgArrow;
            arrow.style.display = 'inline-flex';
            arrow.style.marginLeft = '8px';
            arrow.style.transition = 'transform .15s ease';
            header.style.display = 'flex';
            header.style.alignItems = 'center';
            header.appendChild(arrow);
            sections[cardId] = { card, header, bodyEls, arrow, collapsed: false, userToggled: false };

            const apply = (s) => {
              s.bodyEls.forEach(el => el.style.display = s.collapsed ? 'none' : '');
              s.arrow.style.transform = s.collapsed ? 'rotate(180deg)' : 'rotate(0deg)';
            };

            const syncWithViewport = () => {
              // Only set default based on viewport if user hasn't interacted yet.
              if (!sections[cardId].userToggled) {
                if (window.__forceAccordionCollapse === true) {
                  sections[cardId].collapsed = true;
                } else if (isMobile()) {
                  sections[cardId].collapsed = true;
                } else {
                  sections[cardId].collapsed = false;
                }
              }
              apply(sections[cardId]);
            };

            // initial
            syncWithViewport();

            header.addEventListener('click', () => {
              if (!isMobile()) {
                // Desktop: toggle both together
                const targetState = !sections[cardId].collapsed;
                Object.values(sections).forEach(s => { s.collapsed = targetState; s.userToggled = true; apply(s); });
              } else {
                // Mobile: toggle this only
                sections[cardId].collapsed = !sections[cardId].collapsed;
                sections[cardId].userToggled = true;
                apply(sections[cardId]);
              }
            });

            window.addEventListener('resize', syncWithViewport);

            // expose global controller
            if (typeof window.setAccordionCollapsed !== 'function') {
              window.setAccordionCollapsed = function(collapsed){
                Object.values(sections).forEach(s => { s.collapsed = !!collapsed; s.userToggled = true; apply(s); });
              };
            }
          }
        }

        document.addEventListener('DOMContentLoaded', function(){
          initSection('wonder-config');
          initSection('party-selection');
          // If forced collapse was set before init, apply once
          if (window.__forceAccordionCollapse === true && typeof window.setAccordionCollapsed === 'function') {
            window.setAccordionCollapsed(true);
          }
        });
      })();
    </script>

  <!-- datalist --> 
  <datalist id="persona-skills-list">
    <!-- JavaScript will fill this -->
  </datalist>
