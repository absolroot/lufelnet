---
layout: default
custom_css: [cha_detail, cha_detail_img, tactic-posts, tactic-share]
custom_js: [character/cha_detail, tooltip, detail/dot-carousel, marked.min, character/cha_stats,
character/character-i18n, character/helpmodal]
custom_data: [characters/characters.js, revelations/revelations.js, characters/character_ritual.js,
characters/character_skills.js, characters/character_weapon.js, characters/character_operation.js,
characters/character_party.js, tooltip.js, wonder/persona.js, wonder/weapons.js, characters/character_review.js]
permalink: /character.html
language: kr
title : 괴도 육성 가이드 - 페르소나5 더 팬텀 X 루페르넷
---

{% include supabase-config.html %}

<div class="main-wrapper">

    <!-- 상단 섹션: 이미지와 기본 정보 -->
    <div class="character-header">

        <!-- 좌측: 캐릭터 정보 -->
        <div class="character-info">
            <!-- 네비게이션 경로 -->
            <div class="navigation-path">
                <script>
                    // 현재 언어 확인
                    function getCurrentLanguage() {
                        const urlParams = new URLSearchParams(window.location.search);
                        const langParam = urlParams.get('lang');
                        if (langParam) return langParam;

                        const path = window.location.pathname;
                        if (path.includes('/kr/')) return 'kr';
                        if (path.includes('/en/')) return 'en';
                        if (path.includes('/jp/')) return 'jp';
                        return 'kr';
                    }

                    const currentLang = getCurrentLanguage();
                    let homeText = '홈';
                    let characterText = '괴도';

                    if (currentLang === 'en') {
                        homeText = 'Home';
                        characterText = 'Characters';
                    } else if (currentLang === 'jp') {
                        homeText = 'ホーム';
                        characterText = '怪盗';
                    }

                    document.write(`<a href="../../?v=${APP_VERSION}">${homeText}</a>`);
                </script>
                <span class="separator">/</span>
                <script>document.write(`<a href="/character/?v=${APP_VERSION}">${characterText}</a>`);</script>
                <span class="separator">/</span>
                <span class="current-page"></span>
            </div>
            <div class="name-section">
                <div class="name-row">
                    <h1 class="character-name">Character Name</h1>
                    <div class="icon-group">
                        <div class="element-icons"></div>
                        <div class="position-icon"></div>
                    </div>
                </div>
                <div class="name-row2">
                    <div class="rarity-section"></div>
                    <div class="chracter-role"></div>
                </div>
                <div class="sub-info">
                    <p class="code-name">코드네임: </p>
                    <p class="sees" style="font-weight: bold; display: none;">S.E.E.S</p>
                    <p class="persona-name">페르소나: </p>
                </div>
            </div>
            <div class="basic-info">

                <div class="info-row">
                    <div class="elements-container">
                        <img src="{{ site.baseurl }}/assets/img/character-detail/elements.png" alt="elements"
                            class="elements-sprite">
                        <div class="resistance-overlay">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/elements-resi.png" alt="resistance"
                                class="resistance-icon">
                        </div>
                        <div class="weakness-overlay">
                            <img src="{{ site.baseurl }}/assets/img/character-detail/elements-weak.png" alt="weakness"
                                class="weakness-icon">
                        </div>
                    </div>
                </div>
                <div class="character-description">
                    <div class="chracter-tag"></div>
                </div>
            </div>
        </div>

        <!-- 우측: 캐릭터 이미지 -->
        <div class="character-images">
            <div class="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="" alt="괴도 이미지" class="thief-image">
                    </div>
                    <div class="carousel-item">
                        <img src="" alt="페르소나 이미지" class="persona-image">
                    </div>
                </div>
                <div class="carousel-dots">
                    <span class="dot active" data-index="0"></span>
                    <span class="dot" data-index="1"></span>
                </div>
            </div>
        </div>
    </div>


    <!-- 리뷰 섹션 -->
    <div class="review-card card-style">
        <h2>요약</h2>
        <div class="review-content" id="character-review">
            <!-- 리뷰 내용이 여기에 동적으로 로드됩니다 -->
        </div>
    </div>

    <!-- 세팅 섹션 -->
    <div class="settings-card card-style">
        <h2>추천 세팅</h2>
        <div class="settings-content">


            <!-- 계시 섹션 -->
            <div class="setting-group revelation-settings">
                <div class="setting-section">
                    <h3>계시 <span class="help-icon" onclick="showHelpModal('revelation')">?</span></h3>
                    <div class="revelation-set">
                        <div class="main-revelation">
                            <span class="label">주
                                <img src="{{ site.baseurl }}/assets/img/revelation/icon-주.png" alt="주"
                                    class="option-icon">
                            </span>
                            <span class="value"></span>
                        </div>
                        <div class="sub-revelation">
                            <span class="label">일월성진</span>
                            <span class="value"></span>
                        </div>
                    </div>
                </div>
                <div class="setting-section">
                    <h3>주 옵션 <span class="help-icon" onclick="showHelpModal('main-option')">?</span></h3>
                    <div class="main-options">
                        <div class="option-row">
                            <span class="label">
                                일 <img src="{{ site.baseurl }}/assets/img/revelation/icon-일.png" alt="일"
                                    class="option-icon">
                            </span>
                            <span class="value">생명</span>
                        </div>
                        <div class="option-row">
                            <span class="label">
                                월 <img src="{{ site.baseurl }}/assets/img/revelation/icon-월.png" alt="월"
                                    class="option-icon">
                            </span>
                            <span class="value"></span>
                        </div>
                        <div class="option-row">
                            <span class="label">
                                성 <img src="{{ site.baseurl }}/assets/img/revelation/icon-성.png" alt="성"
                                    class="option-icon">
                            </span>
                            <span class="value"></span>
                        </div>
                        <div class="option-row">
                            <span class="label">
                                진 <img src="{{ site.baseurl }}/assets/img/revelation/icon-진.png" alt="진"
                                    class="option-icon">
                            </span>
                            <span class="value"></span>
                        </div>
                    </div>
                </div>
                <div class="setting-section">
                    <h3>부 옵션 <span class="help-icon" onclick="showHelpModal('sub-option')">?</span></h3>
                    <div class="sub-options">
                        <div class="option-row">
                            <span class="priority">1순위</span>
                            <span class="value"></span>
                        </div>
                        <div class="option-row">
                            <span class="priority">2순위</span>
                            <span class="value"></span>
                        </div>
                        <div class="option-row">
                            <span class="priority">3순위</span>
                            <span class="value"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 스탯 요구사항 섹션 -->
            <div class="setting-group stats-requirements">
                <div class="setting-section">
                    <h3>권장 육성 스탯 <span class="help-icon" onclick="showHelpModal('recommended-stats')">?</span></h3>
                    <div class="stat-levels">
                        <div class="stat-level">
                            <span class="label">LV10</span>
                            <span class="value"></span>
                        </div>
                        <div class="stat-level">
                            <span class="label">LV12</span>
                            <span class="value"></span>
                        </div>
                        <div class="stat-level">
                            <span class="label">LV12+5</span>
                            <span class="value"></span>
                        </div>
                        <div class="stat-level">
                            <span class="label">LV13</span>
                            <span class="value"></span>
                        </div>
                        <div class="stat-level">
                            <span class="label">LV13+5</span>
                            <span class="value"></span>
                        </div>
                    </div>
                </div>
                <div class="setting-section">
                    <h3>전투 진입 시 + <span class="help-icon" onclick="showHelpModal('battle-entry')">?</span></h3>
                    <p class="battle-plus-stats"></p>
                </div>
            </div>


            <!-- 스킬&심상 섹션 -->
            <div class="setting-group skill-mind-settings">
                <div class="setting-section">
                    <h3>스킬 <span class="help-icon" onclick="showHelpModal('skill')">?</span></h3>
                    <div class="skill-levels">
                        <div class="skill-level">
                            <span class="label">스킬 1</span>
                            <span class="value"></span>
                        </div>
                        <div class="skill-level">
                            <span class="label">스킬 2</span>
                            <span class="value"></span>
                        </div>
                        <div class="skill-level">
                            <span class="label">스킬 3</span>
                            <span class="value"></span>
                        </div>
                        <div class="skill-level">
                            <span class="label" data-text="highlight">하이라이트</span>
                            <span class="value"></span>
                        </div>
                    </div>
                </div>
                <div class="setting-section">
                    <h3>심상 (LV 5) <span class="help-icon" onclick="showHelpModal('mind-lv5')">?</span></h3>
                    <div class="mind-settings">
                        <div class="mind-stats">
                            <div class="stat-row">
                                <span class="label">진급강화 1</span>
                                <span class="value"></span>
                                <span class="skill-item"></span>
                            </div>
                            <div class="stat-row">
                                <span class="label">진급강화 2</span>
                                <span class="value"></span>
                                <span class="skill-item"></span>
                            </div>
                        </div>
                        <div class="mind-skills">
                            <div class="skill-row">
                                <span class="label">스킬깨달음 1</span>
                                <span class="value"></span>
                                <span class="skill-item"></span>
                            </div>
                            <div class="skill-row">
                                <span class="label">스킬깨달음 2</span>
                                <span class="value"></span>
                                <span class="skill-item"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 운영 섹션 -->
            <div class="setting-group operation-settings">
                <div class="setting-section">
                    <h3>추천 운영 <span class="help-icon" onclick="showHelpModal('recommended-operation')">?</span></h3>
                    <div class="operation-levels">
                        <!-- 운영 내용이 여기에 동적으로 추가됨 -->
                    </div>
                </div>
                <div class="setting-section">
                    <h3>참고사항</h3>
                    <div class="operation-notes">
                        <!-- 참고 사항 내용이 여기에 동적으로 추가됨 -->
                    </div>
                </div>
            </div>
        </div>
        <div style="height: 48px;"></div>
        <!-- 광고 (기본적으로 표시) -->
        <div id="ad-unit-1" class="ad-unit">
            <ins class="adsbygoogle" style="display:block;" data-ad-format="fluid" data-ad-layout-key="-gc+3r+68-9q-29"
                data-ad-client="ca-pub-5862324369257695" data-ad-slot="5373524213"></ins>
        </div>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
        <div id="ad-unit-p5-1" class="ad-unit">
            <ins class="adsbygoogle" style="display:block;" data-ad-format="fluid" data-ad-layout-key="-gc+3r+68-9q-29"
                data-ad-client="ca-pub-5862324369257695" data-ad-slot="8118051131"></ins>
        </div>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
        <div id="ad-unit-p3-1" class="ad-unit">
            <ins class="adsbygoogle" style="display:block;" data-ad-format="fluid" data-ad-layout-key="-gc+3r+68-9q-29"
                data-ad-client="ca-pub-5862324369257695" data-ad-slot="2039727945"></ins>
        </div>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <!-- 스킬 섹션 -->
    <div class="skills-card card-style drag-me">
        <h2>스킬</h2>
        <div class="skills-grid">
        </div>
    </div>

    <!-- 의식 섹션 -->
    <div class="ritual-card card-style drag-me">
        <div class="ritual-header">
            <h2>의식</h2>
        </div>
        <div class="ritual-grid">
            <div class="ritual-item" data-ritual="0">
                <div class="ritual-header-content">
                    <img src="{{ site.baseurl }}/assets/img/character-detail/ritual0.png" alt="의식 0"
                        class="ritual-image active">
                    <h3 class="ritual-title"></h3>
                </div>
                <p class="ritual-description"></p>
            </div>
            <div class="ritual-item" data-ritual="1">
                <div class="ritual-header-content">
                    <img src="{{ site.baseurl }}/assets/img/character-detail/ritual1.png" alt="의식 1"
                        class="ritual-image">
                    <h3 class="ritual-title"></h3>
                </div>
                <p class="ritual-description"></p>
            </div>
            <div class="ritual-item" data-ritual="2">
                <div class="ritual-header-content">
                    <img src="{{ site.baseurl }}/assets/img/character-detail/ritual2.png" alt="의식 2"
                        class="ritual-image">
                    <h3 class="ritual-title"></h3>
                </div>
                <p class="ritual-description"></p>
            </div>
            <div class="ritual-item" data-ritual="3">
                <div class="ritual-header-content">
                    <img src="{{ site.baseurl }}/assets/img/character-detail/ritual3.png" alt="의식 3"
                        class="ritual-image">
                    <h3 class="ritual-title"></h3>
                </div>
                <p class="ritual-description"></p>
            </div>
            <div class="ritual-item" data-ritual="4">
                <div class="ritual-header-content">
                    <img src="{{ site.baseurl }}/assets/img/character-detail/ritual4.png" alt="의식 4"
                        class="ritual-image">
                    <h3 class="ritual-title"></h3>
                </div>
                <p class="ritual-description"></p>
            </div>
            <div class="ritual-item" data-ritual="5">
                <div class="ritual-header-content">
                    <img src="{{ site.baseurl }}/assets/img/character-detail/ritual5.png" alt="의식 5"
                        class="ritual-image">
                    <h3 class="ritual-title"></h3>
                </div>
                <p class="ritual-description"></p>
            </div>
            <div class="ritual-item" data-ritual="6">
                <div class="ritual-header-content">
                    <img src="{{ site.baseurl }}/assets/img/character-detail/ritual6.png" alt="의식 6"
                        class="ritual-image">
                    <h3 class="ritual-title"></h3>
                </div>
                <p class="ritual-description"></p>
            </div>
        </div>
    </div>


    <!-- 스텟 섹션 -->
    <div class="stats-card card-style">
        <h2>스탯</h2>
        <div class="setting-group stats-settings" style="display:flex; gap:40px; align-items:stretch;">
            <!-- 기초 스탯 (왼쪽 3/4) -->
            <div class="setting-section" style="flex:1; display:flex; flex-direction:column;">
                <h3>기초 스탯</h3>
                <div class="stats-main">
                    <div class="stats-grid">
                        <div class="stat-row">
                            <span class="label">생명</span>
                            <span class="value"></span>
                        </div>
                        <div class="stat-row">
                            <span class="label">공격력</span>
                            <span class="value"></span>
                        </div>
                        <div class="stat-row">
                            <span class="label">방어력</span>
                            <span class="value"></span>
                        </div>
                        <div class="stat-row">
                            <span class="label">속도</span>
                            <span class="value"></span>
                        </div>
                        <!--
                        <div class="stat-row">
                            <span class="label">크리티컬 확률</span>
                            <span class="value"></span>
                        </div>
                        <div class="stat-row">
                            <span class="label">크리티컬 효과</span>
                            <span class="value"></span>
                        </div>-->
                    </div>
                </div>
            </div>
            <!-- 잠재력 LV 7 (오른쪽 1/4) -->
            <div class="setting-section" style="flex:1; display:flex; flex-direction:column;">
                <h3>잠재력 LV 7</h3>
                <div class="stats-awake" style="display:flex; flex-direction:column; gap:8px;">
                    <h3 class="awake-title" style="display:none;">잠재력 Lv7</h3>
                    <div class="awake-row" style="display:flex; gap:8px;">
                        <span class="label"></span>
                        <span class="value"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 무기 섹션 -->
    <div class="weapons-card card-style drag-me">
        <h2>전용 무기</h2>
        <div class="weapon-enhancement-buttons">
            <button class="enhancement-btn active" data-stage="mixed">5성 개조0 / 4성 개조6</button>
            <button class="enhancement-btn" data-stage="all">전체</button>
            <div class="enhancement-stages">
                <button class="enhancement-btn" data-stage="0">0</button>
                <button class="enhancement-btn" data-stage="1">1</button>
                <button class="enhancement-btn" data-stage="2">2</button>
                <button class="enhancement-btn" data-stage="3">3</button>
                <button class="enhancement-btn" data-stage="4">4</button>
                <button class="enhancement-btn" data-stage="5">5</button>
                <button class="enhancement-btn" data-stage="6">6</button>
            </div>
        </div>
        <div class="weapons-container">
            <!-- 무기들이 여기에 동적으로 추가됨 -->
        </div>

        <div style="height: 30px;"></div>
        <!-- 광고 (기본적으로 표시) -->
        <div id="ad-unit-2" class="ad-unit">
            <ins class="adsbygoogle" style="display:block;" data-ad-format="fluid" data-ad-layout-key="-gc+3r+68-9q-29"
                data-ad-client="ca-pub-5862324369257695" data-ad-slot="5373524213"></ins>
        </div>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>

        <div id="ad-unit-p5-2" class="ad-unit">
            <ins class="adsbygoogle" style="display:block;" data-ad-format="fluid" data-ad-layout-key="-gc+3r+68-9q-29"
                data-ad-client="ca-pub-5862324369257695" data-ad-slot="8118051131"></ins>
        </div>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>

        <div id="ad-unit-p3-2" class="ad-unit">
            <ins class="adsbygoogle" style="display:block;" data-ad-format="fluid" data-ad-layout-key="-gc+3r+68-9q-29"
                data-ad-client="ca-pub-5862324369257695" data-ad-slot="2039727945"></ins>
        </div>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
        <div style="height: 10px;"></div>
    </div>



    <!-- 추천 페르소나와 파티 섹션 -->
    <div id="recommended-sections" style="display: none;">
        <!-- 추천 페르소나 -->
        <div class="recommended-persona-card card-style">
            <h2>추천 페르소나</h2>
            <div id="recommended-persona-content" class="recommended-persona-content">
                <!-- 페르소나 내용이 여기에 동적으로 추가됨 -->
            </div>
        </div>

        <!-- 추천 파티 -->
        <div class="recommended-party-card card-style">
            <h2>추천 파티</h2>
            <div id="recommended-party-content" class="recommended-party-content">
                <!-- 파티 내용이 여기에 동적으로 추가됨 -->
            </div>
        </div>
    </div>

    <!-- 택틱 예시 섹션 -->
    <!--
    <div id="character-tactic-examples" class="card-style" style="display:block;">
        <div class="card-title-row">
            <h2 id="tactic-examples-title" style="margin:0;">택틱 예시</h2>
            <!-- 원래 카드 내 3개 프리뷰 로딩은 egress 비용 때문에 비활성화 -->
    <!--<a id="tactic-examples-more" href="/tactic/tactics.html" style="font-size:13px; text-decoration:none; color:#fff; opacity:0.8;">+ 더보기</a>
        </div>
        <!-- egress 절감을 위해 목록 비활성화: 링크로 이동하여 필터 적용된 결과를 보도록 안내 -->
    <!--<div id="tactic-examples-cta" style="margin-top:12px; font-size:14px; color:#bdbdbd;">
            <script>
                (function(){
                    try {
                        var name = new URLSearchParams(window.location.search).get('name') || '';
                        var link = document.getElementById('tactic-examples-more');
                        if (link && name) {
                            var url = new URL(link.getAttribute('href'), window.location.origin);
                            url.searchParams.set('char', name);
                            link.setAttribute('href', url.toString());
                        }
                    } catch(_) {}
                })();
            </script>
            <span>아래 링크에서 이 캐릭터로 필터된 택틱을 확인하세요.</span>
        </div>
        <!-- <div id="tactic-examples-list" class="posts-list" style="margin-top:12px;"></div> -->
    <!--</div>-->

    <!-- 최하단 광고-->
    <div style="height: 24px;"></div>

    <div id="ad-unit-bottom" class="AD-bottom"
        style="text-align: center; align-items: center; display: flex; justify-content: center;">
        <ins class="adsbygoogle" style="display:inline-block;width:970px;height:90px"
            data-ad-client="ca-pub-5862324369257695" data-ad-slot="9244892982"></ins>
    </div>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    <div style="height: 12px;"></div>
    <!---->
    <style>
        @media (max-width: 1440px) {
            .AD-bottom {
                display: none !important;
            }
        }
    </style>

    <script>
        function showAdAndPush(id) {
            const el = document.getElementById(id);
            if (!el) return;

            el.style.display = 'block';

            const checkAndPush = () => {
                const ins = el.querySelector('.adsbygoogle');

                if (!ins) return;

                // adsbygoogle이 화면에 제대로 포함되어 있고, 최소 width 확보됐는지 확인
                const isVisible = ins.offsetParent !== null;
                const widthOk = ins.offsetWidth >= 250;

                if (isVisible && widthOk) {
                    try {
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    } catch (e) {
                        console.warn("광고 푸시 중 오류 발생:", e, 'id:', id);
                    }
                } else {
                    // 100ms 후 재시도 (최대 10회)
                    if (!ins.__retryCount) ins.__retryCount = 0;
                    if (ins.__retryCount < 10) {
                        ins.__retryCount++;
                        setTimeout(checkAndPush, 100);
                    } else {
                        console.warn(`${id} 광고 푸시 실패: width=${ins.offsetWidth}, visible=${isVisible}`);
                    }
                }
            };

            // 첫 시도
            requestAnimationFrame(checkAndPush);
        }

        // push 광고 
        function pushAdUnitsForCharacter(characterName) {
            const character = characterData[characterName];
            if (!character) return;

            try {
                // 조건에 따라 특정 광고 DOM만 표시 + push 실행
                if (character.persona5) {
                    //showAdAndPush('ad-unit-p5-1');
                    //showAdAndPush('ad-unit-p5-2');

                    const adsToHide = document.querySelectorAll('.ad-unit:not([id^="ad-unit-p5-"])');
                    adsToHide.forEach(ad => {
                        if (ad && ad.style) {
                            ad.style.display = 'none';
                        }
                    });
                } else if (character.persona3) {
                    //showAdAndPush('ad-unit-p3-1');
                    //showAdAndPush('ad-unit-p3-2');

                    const adsToHide = document.querySelectorAll('.ad-unit:not([id^="ad-unit-p3-"])');
                    adsToHide.forEach(ad => {
                        if (ad && ad.style) {
                            ad.style.display = 'none';
                        }
                    });
                } else {
                    //showAdAndPush('ad-unit-1');
                    //showAdAndPush('ad-unit-2');

                    const p5AdsToHide = document.querySelectorAll('[id^="ad-unit-p5-"]');
                    const p3AdsToHide = document.querySelectorAll('[id^="ad-unit-p3-"]');

                    p5AdsToHide.forEach(ad => {
                        if (ad && ad.style) {
                            ad.style.display = 'none';
                        }
                    });
                    p3AdsToHide.forEach(ad => {
                        if (ad && ad.style) {
                            ad.style.display = 'none';
                        }
                    });
                }
            } catch (error) {
                console.warn('광고 푸시 중 오류 발생:', error);
            }
        }

        const characterName = new URLSearchParams(window.location.search).get('name');
        if (characterName) {
            // Update ads based on character's persona3, persona5 property
            pushAdUnitsForCharacter(characterName);

            // 광고 업데이트 후 툴팁 다시 적용
            setTimeout(() => {
                if (typeof addTooltips === 'function') {
                    addTooltips();
                }
            }, 200);

            // 광고 흰 박스 숨김
            setTimeout(() => {
                document.querySelectorAll(".adsbygoogle").forEach(el => {
                    const status = el.getAttribute("data-ad-status");
                    const adslot = el.getAttribute("data-ad-slot");
                    //console.log("google status", status);
                    //console.log("google adslot", adslot);
                    if (status === "unfilled" || el.querySelector("iframe") === null) {
                        el.style.display = "none";
                    }
                });
            }, 2000);  // 광고 로딩 기다렸다가 1.5초 후 검사

            /*
            document.querySelectorAll(".adsbygoogle").forEach((adEl) => {
                observer.observe(adEl, { attributes: true });
            });*/
        }
    </script>
</div>



<!-- 스크립트 ----------------------------------------------------------------------->

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        // 안전 실행 유틸리티: 개별 블록에서 오류가 나도 전체 흐름을 막지 않음
        const safeRun = (name, fn) => { try { return fn && fn(); } catch (e) { console.warn(`[SAFE:${name}]`, e); } };
        const safeAwait = async (name, promise) => { try { return await promise; } catch (e) { console.warn(`[SAFE:${name}]`, e); return undefined; } };
        const safeAddEvent = (el, evt, handler, name = 'event') => {
            try {
                if (el && el.addEventListener) {
                    el.addEventListener(evt, (...args) => { try { handler && handler(...args); } catch (e) { console.warn(`[SAFE:${name}:${evt}]`, e); } });
                }
            } catch (e) { console.warn(`[SAFE:addEvent:${name}]`, e); }
        };

        safeRun('Navigation.load', () => Navigation.load('character', 1));
        safeRun('VersionChecker.check', () => VersionChecker.check());

        // Get character name from URL
        const urlParams = new URLSearchParams(window.location.search);
        const characterName = urlParams.get('name');
        // 이미지 로딩 완료 시에만 표시되도록 data-loaded 세팅
        try {
            const fallbackSrc = `{{ site.baseurl }}/assets/img/character-detail/character_bg.png`;
            const thiefImg = document.querySelector('.thief-image');
            const personaImg = document.querySelector('.persona-image');

            const wireImage = (imgEl) => {
                if (!imgEl) return;
                // 로딩 우선순위 및 디코딩 힌트
                try { imgEl.setAttribute('loading', 'eager'); } catch (_) { }
                try { imgEl.setAttribute('decoding', 'sync'); } catch (_) { }
                try { imgEl.setAttribute('fetchpriority', 'high'); } catch (_) { }
                imgEl.addEventListener('load', () => {
                    try { imgEl.setAttribute('data-loaded', 'true'); } catch (_) { }
                });
                imgEl.addEventListener('error', () => {
                    try {
                        // 실패 시 플레이스홀더 이미지로 대체하고 강제로 표시
                        imgEl.src = fallbackSrc;
                        imgEl.setAttribute('data-loaded', 'true');
                    } catch (_) { }
                });
                // 캐시된 이미지 즉시 처리
                if (imgEl.complete && imgEl.naturalWidth > 0) {
                    imgEl.setAttribute('data-loaded', 'true');
                } else {
                    // 일부 모바일 브라우저에서 load 이벤트 누락 대비 가드
                    setTimeout(() => {
                        if (!imgEl.hasAttribute('data-loaded')) {
                            imgEl.setAttribute('data-loaded', 'true');
                        }
                    }, 1500);
                }
                // 최종 보증: 비동기 프리페치 후 DOM에 재주입 (레이스 대비)
                setTimeout(() => {
                    try {
                        if (imgEl.naturalWidth === 0) {
                            const tmp = new Image();
                            tmp.onload = () => {
                                try {
                                    imgEl.src = tmp.src;
                                    imgEl.setAttribute('data-loaded', 'true');
                                } catch (_) { }
                            };
                            tmp.onerror = () => {
                                try {
                                    imgEl.src = fallbackSrc;
                                    imgEl.setAttribute('data-loaded', 'true');
                                } catch (_) { }
                            };
                            tmp.src = imgEl.currentSrc || imgEl.src;
                        }
                    } catch (_) { }
                }, 800);
            };

            wireImage(thiefImg);
            wireImage(personaImg);
        } catch (_) { }

        // 언어별 데이터 파일 동적 로드
        async function loadLanguageData() {
            if (currentLang !== 'kr') {
                const langPath = currentLang === 'en' ? 'en' : 'jp';
                const basePath = '{{ site.baseurl }}/data/' + langPath + '/characters/';

                try {
                    const scripts = [
                        { name: 'skills', src: basePath + 'character_skills.js?v=' + APP_VERSION, varName: langPath + 'CharacterSkillsData' },
                        { name: 'ritual', src: basePath + 'character_ritual.js?v=' + APP_VERSION, varName: langPath + 'CharacterRitualData' },
                        { name: 'weapon', src: basePath + 'character_weapon.js?v=' + APP_VERSION, varName: langPath + 'CharacterWeaponData' }
                    ];

                    await new Promise((resolve) => {
                        let loadedCount = 0;
                        let errorCount = 0;
                        const totalScripts = scripts.length;

                        // Timeout fallback to prevent hanging
                        const timeoutId = setTimeout(() => {
                            console.warn('Language data loading timed out');
                            resolve();
                        }, 10000);

                        scripts.forEach(scriptInfo => {
                            const script = document.createElement('script');
                            script.src = scriptInfo.src;

                            script.onload = () => {
                                // 스크립트 로드 후 변수가 정의될 때까지 대기
                                const checkInterval = setInterval(() => {
                                    if (typeof window[scriptInfo.varName] !== 'undefined') {
                                        clearInterval(checkInterval);
                                        loadedCount++;
                                        console.log('Loaded:', scriptInfo.varName);
                                        checkCompletion();
                                    }
                                }, 50);

                                // 최대 2초 대기
                                setTimeout(() => {
                                    clearInterval(checkInterval);
                                    if (typeof window[scriptInfo.varName] === 'undefined') {
                                        console.warn('Variable not defined after timeout:', scriptInfo.varName);
                                        errorCount++;
                                        checkCompletion();
                                    }
                                }, 2000);
                            };

                            script.onerror = (e) => {
                                console.error('Failed to load script:', scriptInfo.src, e);
                                errorCount++;
                                checkCompletion();
                            };

                            document.head.appendChild(script);
                        });

                        function checkCompletion() {
                            if (loadedCount + errorCount === totalScripts) {
                                clearTimeout(timeoutId);
                                console.log('All scripts loaded. Loaded:', loadedCount, 'Errors:', errorCount);
                                resolve();
                            }
                        }
                    });

                    // After loading, call fillSkillsInfo
                    setTimeout(() => {
                        if (typeof fillSkillsInfo === 'function') {
                            fillSkillsInfo(characterName);
                        }
                    }, 100);

                } catch (e) {
                    console.error('Error in loadLanguageData:', e);
                }
            }
        }

        if (!characterName || !characterData[characterName]) {
            console.error('Character not found');
            return;
        }

        // 이미지 우선 로딩: 다국어 데이터 로드와 상관없이 즉시 표시되도록 선행 주입
        try {
            const basicCharacter = characterData[characterName];
            const thiefEl = document.querySelector('.thief-image');
            const personaEl = document.querySelector('.persona-image');
            const thiefFile = encodeURIComponent(`${characterName}.webp`);
            const personaFile = encodeURIComponent(`${characterName} - ${basicCharacter.persona}.webp`);
            const thiefSrc = `{{ site.baseurl }}/assets/img/character-detail/${thiefFile}`;
            const personaSrc = `{{ site.baseurl }}/assets/img/character-detail/${personaFile}`;
            if (thiefEl) { thiefEl.src = thiefSrc; thiefEl.setAttribute('fetchpriority', 'high'); thiefEl.setAttribute('loading', 'eager'); }
            if (personaEl) { personaEl.src = personaSrc; personaEl.setAttribute('fetchpriority', 'high'); personaEl.setAttribute('loading', 'eager'); }
            const preload1 = document.createElement('link');
            preload1.rel = 'preload';
            preload1.as = 'image';
            preload1.href = thiefSrc;
            document.head.appendChild(preload1);
            const preload2 = document.createElement('link');
            preload2.rel = 'preload';
            preload2.as = 'image';
            preload2.href = personaSrc;
            document.head.appendChild(preload2);
        } catch (e) { console.warn('[SAFE:early-image-load]', e); }

        // 언어별 데이터 로드 후 캐릭터 정보 설정
        await safeAwait('loadLanguageData', loadLanguageData());

        // 한국어인 경우 바로 스킬 정보 로드
        if (currentLang === 'kr') {
            safeRun('fillSkillsInfo-kr', () => { if (typeof fillSkillsInfo === 'function') { fillSkillsInfo(characterName); } });
        }

        const character = characterData[characterName];
        const ritual = ritualData[characterName];

        // 언어별 데이터 로드 (영어/일본어가 있는 경우 우선 사용)
        let localizedSkills = null;
        let localizedRitual = null;
        let localizedWeapon = null;

        if (currentLang !== 'kr') {
            // 언어별 데이터 파일 동적 로드
            try {
                if (currentLang === 'en') {
                    // 영어 데이터는 window 객체에서 직접 접근
                    if (window.enCharacterSkillsData && window.enCharacterSkillsData[characterName]) {
                        localizedSkills = window.enCharacterSkillsData[characterName];
                    }
                    if (window.enCharacterRitualData && window.enCharacterRitualData[characterName]) {
                        localizedRitual = window.enCharacterRitualData[characterName];
                    }
                    if (window.enCharacterWeaponData && window.enCharacterWeaponData[characterName]) {
                        localizedWeapon = window.enCharacterWeaponData[characterName];
                    }
                } else if (currentLang === 'jp') {
                    // 일본어 데이터는 window 객체에서 직접 접근
                    if (window.jpCharacterSkillsData && window.jpCharacterSkillsData[characterName]) {
                        localizedSkills = window.jpCharacterSkillsData[characterName];
                    }
                    if (window.jpCharacterRitualData && window.jpCharacterRitualData[characterName]) {
                        localizedRitual = window.jpCharacterRitualData[characterName];
                    }
                    if (window.jpCharacterWeaponData && window.jpCharacterWeaponData[characterName]) {
                        localizedWeapon = window.jpCharacterWeaponData[characterName];
                    }
                }

                /*console.log('언어별 데이터 로드 결과:', {
                    lang: currentLang,
                    skills: !!localizedSkills,
                    ritual: !!localizedRitual,
                    weapon: !!localizedWeapon
                });*/
            } catch (e) {
                console.log('언어별 데이터 로드 실패:', e);
            }
        }

        // 캐릭터 리뷰 렌더링 함수

        // 안전하게 리뷰 렌더링
        try {
            const reviewContainer = document.getElementById('character-review');
            if (!reviewContainer) throw new Error('reviewContainer not found');
            const characterReviewData = characterReview[characterName];
            const ReviewCard = document.querySelector('.review-card');
            if (!characterReviewData || !characterReviewData.review) {
                reviewContainer.innerHTML = '<p style="color: #888; font-style: italic;"></p>';
                reviewContainer.style.display = 'none';
                if (ReviewCard) ReviewCard.style.display = 'none';
            } else {
                let currentReview = characterReviewData.review;
                if (currentLang === 'en' && characterReviewData.review_en) {
                    currentReview = characterReviewData.review_en;
                } else if (currentLang === 'jp' && characterReviewData.review_jp) {
                    currentReview = characterReviewData.review_jp;
                }
                // 변환: 전각/유사 별표 → ASCII *, 제로폭/비가시/방향 제어/소프트하이픈/NBSP 제거 (언어 선택 이후 적용)
                const normalized = currentReview
                    .replace(/\uFF0A/g, '*')    // 전각 별표 ＊ → *
                    .replace(/\u2217/g, '*')    // ∗ → *
                    .replace(/[\u200B-\u200D\uFEFF]/g, '') // ZWSP/ZWNJ/ZWJ/ZWNBSP 제거
                    .replace(/[\u200E\u200F]/g, '')          // LRM/RLM 제거
                    .replace(/[\u202A-\u202E]/g, '')         // 방향 제어 문자 제거
                    .replace(/\u00AD/g, '')                   // Soft hyphen 제거
                    .replace(/\u2060/g, '')                   // WORD JOINER 제거
                    .replace(/\u00A0/g, ' ');                 // NBSP → 공백

                let htmlContent = marked.parse(normalized);
                // 폴백: 파싱 후에도 **...**가 그대로 남았으면 강제 <strong> 치환 (이미 파싱된 경우엔 영향 없음)
                if (htmlContent.includes('**')) {
                    htmlContent = htmlContent.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                }
                reviewContainer.innerHTML = htmlContent;
            }
        } catch (e) { console.warn('[SAFE:render-review]', e); }


        // 이미지 설정
        // 이미지 세팅 보호 (URL 인코딩 포함)
        try {
            const thiefImgEl = document.querySelector('.thief-image');
            const thiefFile = `${characterName}.webp`;
            if (thiefImgEl) thiefImgEl.src = `{{ site.baseurl }}/assets/img/character-detail/${thiefFile}`;
            const personaImgEl = document.querySelector('.persona-image');
            const personaFile = `${characterName} - ${character.persona}.webp`;
            if (personaImgEl) personaImgEl.src = `{{ site.baseurl }}/assets/img/character-detail/${personaFile}`;
        } catch (e) { console.warn('[SAFE:set-images]', e); }

        // Set character name (en에서는 로딩 전에 skeleton 사용)
        try {
            const nameElement = document.querySelector('.character-name');
            if (nameElement) {
                if (currentLang === 'en') {
                    nameElement.classList.add('skeleton');
                    requestAnimationFrame(() => {
                        try { nameElement.textContent = character.name_en || characterName; } catch (_) { }
                        nameElement.classList.remove('skeleton');
                    });
                } else if (currentLang === 'jp' && character.name_jp) {
                    nameElement.textContent = character.name_jp;
                } else {
                    nameElement.textContent = character.name;
                }
            }
        } catch (e) { console.warn('[SAFE:set-name]', e); }

        // 코드네임 설정
        try {
            const codeNameLabel = currentLang === 'kr' ? '코드네임 ' :
                currentLang === 'en' ? 'Code Name ' : 'コードネーム ';
            const codeEl = document.querySelector('.code-name');
            if (codeEl) {
                codeEl.innerHTML = `
                    <span class="label">${codeNameLabel}</span><span class="value">${character.codename || ''}</span>
                `;
            }
            const personaLabel = currentLang === 'kr' ? '페르소나 ' :
                currentLang === 'en' ? 'Persona ' : 'ペルソナ ';
            const personaValue = currentLang === 'en' && character.persona_en ? character.persona_en :
                currentLang === 'jp' && character.persona_jp ? character.persona_jp :
                    character.persona || '';
            const personaEl = document.querySelector('.persona-name');
            if (personaEl) {
                personaEl.innerHTML = `
                    <span class="label">${personaLabel}</span><span class="value">${personaValue}</span>
                `;
            }
        } catch (e) { console.warn('[SAFE:code-persona]', e); }

        // 속성 아이콘 설정
        try {
            if (character.element) {
                const elementIcons = document.querySelector('.element-icons');
                if (elementIcons) elementIcons.innerHTML = `<img src="{{ site.baseurl }}/assets/img/character-cards/속성_${character.element}.png" alt="${character.element}">`;
            }
        } catch (e) { console.warn('[SAFE:element-icon]', e); }

        // 직업 아이콘 및 이름 설정
        try {
            if (character.position) {
                const positionIcon = document.querySelector('.position-icon');
                if (positionIcon) positionIcon.innerHTML = `<img src="{{ site.baseurl }}/assets/img/character-cards/직업_${character.position}.png" alt="${character.position}">`;
            }
        } catch (e) { console.warn('[SAFE:position-icon]', e); }

        // 약점/내성 설정 (데이터가 있을 경우에만)
        const resistanceIcons = document.querySelector('.resistance-icons');
        try {
            if (character.resistances && Array.isArray(character.resistances)) {
                character.resistances.forEach(res => {
                    const icon = document.createElement('div');
                    icon.className = `resistance-icon ${res.type}`;
                    icon.innerHTML = `<img src="{{ site.baseurl }}/assets/img/character-cards/속성_${res.element}.png" alt="${res.element}">`;
                    resistanceIcons.appendChild(icon);
                });
            }
        } catch (e) { console.warn('[SAFE:resistances]', e); }

        // 스탯 설정 (데이터가 있을 경우에만)
        try {
            if (character.stats) {
                const statGrid = document.querySelector('.stat-grid');
                if (!statGrid) throw new Error('statGrid not found');
                statGrid.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">공격력</span>
                    <span class="stat-value">${character.stats.attack || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">방어력</span>
                    <span class="stat-value">${character.stats.defense || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">생명</span>
                    <span class="stat-value">${character.stats.hp || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">SP</span>
                    <span class="stat-value">${character.stats.sp || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">속도</span>
                    <span class="stat-value">${character.stats.speed || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">크리티컬 확률</span>
                    <span class="stat-value">${character.stats.critRate || 0}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">크리티컬 효과</span>
                    <span class="stat-value">${character.stats.critDmg || 0}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">효과 명중</span>
                    <span class="stat-value">${character.stats.effectHit || 0}%</span>
                </div>
            `;
            }
        } catch (e) { console.warn('[SAFE:stat-grid]', e); }


        // 스킬 설정은 cha_detail.js에서 자동 처리됨


        // 의식 정보 설정
        const ritualItems = document.querySelectorAll('.ritual-item');

        function updateAllRitualContent() {
            // 언어별 의식 데이터 우선 사용
            const ritualToUse = localizedRitual || ritual;

            ritualItems.forEach(item => {
                const level = item.getAttribute('data-ritual');
                const title = item.querySelector('.ritual-title');
                const description = item.querySelector('.ritual-description');

                title.textContent = ritualToUse[`r${level}`] || '';
                description.innerHTML = ritualToUse[`r${level}_detail`] || '';
            });

        }

        // 초기 의식 내용 설정
        try { updateAllRitualContent(); } catch (e) { console.warn('[SAFE:updateAllRitualContent]', e); }

        // 전투 진입 시 요구 스탯 + 처리
        const battlePlusStats = document.querySelector('.battle-plus-stats');
        try {
            if (!battlePlusStats) throw new Error('battlePlusStats not found');
            // 언어 별 battle-plus-stats
            if (currentLang === 'en' && character.battle_plus_stats_en) {
                battlePlusStats.textContent = character.battle_plus_stats_en;
            } else if (currentLang === 'jp' && character.battle_plus_stats_jp) {
                battlePlusStats.textContent = character.battle_plus_stats_jp;
            } else {
                battlePlusStats.textContent = character.battle_plus_stats;
            }
        } catch (e) { console.warn('[SAFE:battlePlus-init]', e); }

        if (battlePlusStats && battlePlusStats.textContent && battlePlusStats.textContent !== 'nan') {
            // console.log('Original battle_plus_stats:', character.battle_plus_stats);

            // <b> 태그의 수 확인
            const bTagCount = (battlePlusStats.textContent.match(/<b>/g) || []).length;
            //console.log('bTagCount:', bTagCount);
            //console.log('battlePlusStats.textContent:', battlePlusStats.textContent);
            if (bTagCount >= 2) {
                // 2열 레이아웃으로 변경
                battlePlusStats.style.display = 'grid';
                battlePlusStats.style.gridTemplateColumns = 'repeat(2, 1fr)';
                battlePlusStats.style.gap = '20px';

                // <b> 태그로 분할하여 각 섹션을 div로 래핑
                const sections = battlePlusStats.textContent.split(/<b>/).filter(Boolean);
                battlePlusStats.innerHTML = sections.map(section => {
                    const processedSection = section.trim().replace(/\s*\/\s*/g, '<br>·');
                    const finalSection = processedSection.replace(/<<br>·b><br>/, '</b>');
                    return `<div class="battle-stat-section"><b>${finalSection}</div>`;
                }).join('');
            } else {
                // 기존 방식대로 한 열로 표시
                let rawContent = battlePlusStats.textContent.trim();
                // console.log('Raw content:', rawContent);

                // / 기준으로 분할
                let items = rawContent.split(/\s*\/\s*/);
                // console.log('Split items:', items);

                // 첫 번째 항목이 ·로 시작하지 않으면 추가
                if (items[0] && !items[0].trim().startsWith('·')) {
                    items[0] = '· ' + items[0].trim();
                }

                // 나머지 항목들 앞에 ·를 추가 (이미 있으면 제거 후 추가)
                for (let i = 1; i < items.length; i++) {
                    items[i] = '· ' + items[i].trim().replace(/^·\s*/, '');
                }

                // DOM 요소 직접 생성
                battlePlusStats.innerHTML = '';

                // 심상 번역 텍스트 정의
                const mindTexts = {
                    'kr': '심상5',
                    'en': 'Mindscape5',
                    'jp': 'イメジャリー5'
                };

                items.forEach((item, index) => {
                    if (item.trim()) {
                        const div = document.createElement('div');
                        let processedItem = item.trim();
                        // 심상 번역 처리
                        processedItem = processedItem.replace(/심상5/g, mindTexts[currentLang] || '심상5');
                        processedItem = processedItem.replace(/심상 5/g, mindTexts[currentLang] || '심상5');
                        div.textContent = processedItem;
                        battlePlusStats.appendChild(div);
                    }
                });

                // console.log('Final items:', items);
            }
        } else if (battlePlusStats) {
            battlePlusStats.textContent = '-';
        }

        // 수치 패턴 변환 함수
        function transformEnhancementValues(description, stage, weaponStars) {
            if (stage === 'all') {
                return description.replace(
                    /(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)/g,
                    '<span class="enhancement-values">$1</span>/<span class="enhancement-values">$2</span>/<span class="enhancement-values">$3</span>/<span class="enhancement-values">$4</span>/<span class="enhancement-values">$5</span>/<span class="enhancement-values">$6</span>/<span class="enhancement-values">$7</span>'
                );
            } else if (stage === 'mixed') {
                return description.replace(
                    /(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)/g,
                    (match, s0, s1, s2, s3, s4, s5, s6) => {
                        return `<span class="enhancement-values">${weaponStars === 5 ? s0 : s6}</span>`;
                    }
                );
            } else {
                const stageNum = parseInt(stage);
                return description.replace(
                    /(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)\/(\d+\.?\d*%?)/g,
                    (match, s0, s1, s2, s3, s4, s5, s6) => {
                        const values = [s0, s1, s2, s3, s4, s5, s6];
                        return `<span class="enhancement-values">${values[stageNum]}</span>`;
                    }
                );
            }
        }

        // 무기 설정 함수 수정
        async function loadWeapons(characterName, stage = 'mixed') {
            const weaponsContainer = document.querySelector('.weapons-container');
            weaponsContainer.innerHTML = '';

            // 언어별 무기 데이터 우선 사용
            const weaponDataToUse = localizedWeapon || WeaponData[characterName];
            if (!weaponDataToUse) return;

            const characterWeapons = weaponDataToUse;
            const weaponTypes = [
                { key: 'weapon5-1', suffix: '5-01', stars: 5 },
                { key: 'weapon4-1', suffix: '4-01', stars: 4 },
                { key: 'weapon4-2', suffix: '4-02', stars: 4 },
                { key: 'weapon3-1', suffix: '3-01', stars: 3 }
            ];

            for (const weapon of weaponTypes) {
                const imagePath = `{{ site.baseurl }}/assets/img/character-weapon/${characterName}-${weapon.suffix}.png`;

                // 무기 데이터 가져오기 (현재 언어 데이터 우선)
                const weaponData = characterWeapons[weapon.key];
                // 한국어 원본 데이터의 highlight도 병합해서 사용
                const krWeaponData = (WeaponData && WeaponData[characterName] && WeaponData[characterName][weapon.key]) || null;

                // weaponData가 없으면 건너뛰기
                if (!weaponData) continue;

                const weaponItem = document.createElement('div');
                weaponItem.className = 'weapon-item';
                // highlight: true 이면 언어와 무관하게 하이라이트 스타일 적용
                const isHighlighted = (weaponData && weaponData.highlight === true) || (krWeaponData && krWeaponData.highlight === true);
                if (isHighlighted) weaponItem.classList.add('super-highlight');


                // 무기 이미지
                // img container 안에 img 추가
                const weaponImageContainer = document.createElement('div');
                weaponImageContainer.className = 'weapon-image-container';

                const weaponImage = document.createElement('img');
                weaponImage.src = imagePath;
                weaponImage.alt = weaponData.name || '무기 이미지';
                weaponImage.className = 'weapon-image';
                // 이미지 로드 실패시 기본 이미지로 대체
                /*
                weaponImage.onerror = () => {
                    weaponImage.src = '{{ site.baseurl }}/assets/img/character-weapon/default.png';
                };*/

                // 무기 정보 컨테이너
                const weaponInfo = document.createElement('div');
                weaponInfo.className = 'weapon-info';

                // 무기 헤더 (이름 + 별)
                const weaponHeader = document.createElement('div');
                weaponHeader.className = 'weapon-header';

                // 무기 이름과 스탯
                const weaponName = document.createElement('span');
                weaponName.className = `weapon-name${weapon.stars === 5 ? ' five-star' : ''}`;
                weaponName.textContent = weaponData.name || '무기 이름';

                // 스탯 정보
                const weaponStats = document.createElement('div');
                weaponStats.className = 'weapon-stats';
                // 현재 언어 라벨 계산 (I18NUtils 폴백 포함)
                const _lang = (typeof I18NUtils !== 'undefined' && I18NUtils.getCurrentLanguageSafe) ? I18NUtils.getCurrentLanguageSafe() : (typeof getCurrentLanguage === 'function' ? getCurrentLanguage() : 'kr');
                const _dict = (typeof I18NUtils !== 'undefined' && I18NUtils.statTranslations && I18NUtils.statTranslations[_lang]) ? I18NUtils.statTranslations[_lang] : null;
                const _label = (ko) => (_dict && _dict[ko]) ? _dict[ko] : ko;
                const _healthLabel = _label('생명');
                const _attackLabel = _label('공격력');
                const _defenseLabel = _label('방어력');
                weaponStats.innerHTML = `
                    <img src="{{ site.baseurl }}/assets/img/character-detail/weapon-health.png" alt="${_healthLabel}"><p>${_healthLabel} ${weaponData.health || 0}</p>
                    <img src="{{ site.baseurl }}/assets/img/character-detail/weapon-attack.png" alt="${_attackLabel}"><p>${_attackLabel} ${weaponData.attack || 0}</p>
                    <img src="{{ site.baseurl }}/assets/img/character-detail/weapon-defense.png" alt="${_defenseLabel}"><p>${_defenseLabel} ${weaponData.defense || 0}</p>
                `;

                // 별 표시
                const weaponStars = document.createElement('div');
                weaponStars.className = 'weapon-stars';
                for (let i = 0; i < weapon.stars; i++) {
                    const star = document.createElement('img');
                    star.src = `{{ site.baseurl }}/assets/img/character-detail/star${weapon.stars}.png`;
                    star.alt = '★';
                    weaponStars.appendChild(star);
                }
                // weapon.key가 weapon4-2라면 별 옆에 'EVENT' 텍스트를 추가한다.
                //console.log(weapon.key);
                if (weapon.key == "weapon4-2") {
                    const eventText = document.createElement('span');
                    eventText.className = 'event-text';
                    eventText.textContent = 'EVENT';
                    eventText.style.color = '#ecda81';
                    eventText.style.fontSize = '10px';
                    eventText.style.lineHeight = '1';
                    eventText.style.margin = '1px 0 0 4px';
                    weaponStars.appendChild(eventText);
                }

                // 스킬 정보
                const weaponSkill = document.createElement('div');
                weaponSkill.className = 'weapon-skill';
                if (weaponData.skill_name || weaponData.description) {
                    let description = weaponData.description || '';
                    description = transformEnhancementValues(description, stage, weapon.stars);
                    description = description.replace(/(?<!\d)\.(?!\d)/g, '.\n');

                    // 스킬명이 있으면 표시, 없으면 설명만 표시
                    if (weaponData.skill_name) {
                        weaponSkill.innerHTML = `
                        <h4>${weaponData.skill_name}</h4>
                        <p>${description}</p>
                    `;
                    } else if (description) {
                        weaponSkill.innerHTML = `
                            <p>${description}</p>
                        `;
                    }
                }

                weaponHeader.appendChild(weaponName);
                weaponHeader.appendChild(weaponStars);

                weaponInfo.appendChild(weaponHeader);
                weaponInfo.appendChild(weaponStats);
                weaponInfo.appendChild(weaponSkill);

                weaponImageContainer.appendChild(weaponImage);
                weaponItem.appendChild(weaponImageContainer);
                weaponItem.appendChild(weaponInfo);

                weaponsContainer.appendChild(weaponItem);

            }

            // 무기 로드 후 스탯 텍스트 번역 적용 (안전 폴백 포함)
            setTimeout(() => {
                try {
                    if (typeof window.translateStatTexts === 'function') {
                        window.translateStatTexts();
                    } else if (window.I18NUtils && typeof I18NUtils.translateStatTexts === 'function') {
                        I18NUtils.translateStatTexts(document);
                    }
                } catch (_) { }
            }, 100);

            addTooltips();

        }

        // 캐릭터 로드 시 무기 정보도 함께 로드
        try { if (characterName && characterData[characterName]) { loadWeapons(characterName, 'mixed'); } } catch (e) { console.warn('[SAFE:loadWeapons-init]', e); }

        // 추천 페르소나와 파티 로드
        try { loadRecommendations(characterName); } catch (e) { console.warn('[SAFE:loadRecommendations]', e); }

        // 툴팁 추가
        try { addTooltips(); } catch (e) { console.warn('[SAFE:addTooltips]', e); }

        // 버튼 이벤트 리스너 추가
        const enhancementButtons = document.querySelectorAll('.enhancement-btn');

        enhancementButtons.forEach(button => {
            try {
                button.addEventListener('click', () => {
                    try {
                        enhancementButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        const urlParams = new URLSearchParams(window.location.search);
                        const characterName = urlParams.get('name');
                        loadWeapons(characterName, button.dataset.stage);
                    } catch (e) { console.warn('[SAFE:enhancement-click-inner]', e); }
                });
            } catch (e) { console.warn('[SAFE:enhancement-click]', e); }
        });



        // SEO 메타데이터 동적 업데이트
        const baseUrl = 'https://lufel.net'; // 실제 도메인으로 변경 필요

        // 언어별 캐릭터명 설정
        let characterDisplayName = character.name;
        if (currentLang === 'en' && character.name_en) {
            characterDisplayName = character.name_en;
        } else if (currentLang === 'jp' && character.name_jp) {
            characterDisplayName = character.name_jp;
        }

        // 언어별 사이트 정보
        const siteInfo = {
            'kr': {
                siteName: '육성 가이드 - 페르소나5 더 팬텀 X',
                siteTitle: 'P5X 루페르넷',
                description: '추천 세팅, 스킬, 의식, 전용무기 정보'
            },
            'en': {
                siteName: 'Build & Guide - Persona 5: The Phantom X',
                siteTitle: 'P5X LufelNet',
                description: 'Recommended setup, skills, awareness, exclusive weapon info'
            },
            'jp': {
                siteName: '攻略 - ペルソナ5 ザ・ファントム X',
                siteTitle: 'P5X LufelNet',
                description: 'おすすめ設定、スキル、意識、専用武器情報'
            }
        };

        const currentSiteInfo = siteInfo[currentLang] || siteInfo['kr'];

        // 타이틀 업데이트
        try { document.title = `${characterDisplayName} ${currentSiteInfo.siteName}`; } catch (e) { console.warn('[SAFE:seo-title]', e); }

        // 메타 태그 업데이트 (태그가 존재하는 경우에만)
        const description = `${characterDisplayName}(${character.codename}) - ${currentSiteInfo.siteName} : ${currentSiteInfo.description}`;

        const metaDescription = document.querySelector('meta[name="description"]');
        const ogTitle = document.querySelector('meta[property="og:title"]');
        const ogDescription = document.querySelector('meta[property="og:description"]');
        const ogImage = document.querySelector('meta[property="og:image"]');
        const ogUrl = document.querySelector('meta[property="og:url"]');
        const canonicalLink = document.getElementById('canonical-link');

        try {
            if (metaDescription) metaDescription.setAttribute('content', description);
            if (ogTitle) ogTitle.setAttribute('content', `${characterDisplayName} - ${currentSiteInfo.siteName}`);
            if (ogDescription) ogDescription.setAttribute('content', description);
            if (ogImage) ogImage.setAttribute('content', `${baseUrl}/img/character-detail/${characterName}.webp`);
            if (ogUrl) ogUrl.setAttribute('content', `${baseUrl}/${currentLang}/character/character.html?name=${characterName}`);
            if (canonicalLink) {
                const canonicalUrl = `https://lufel.net/${currentLang}/character/character.html?name=${characterName}`;
                canonicalLink.setAttribute('href', canonicalUrl);
            }
        } catch (e) { console.warn('[SAFE:seo-meta]', e); }

        // 번역 적용 (캐릭터 데이터 로드 후)
        try { applyTranslations(); } catch (e) { console.warn('[SAFE:applyTranslations]', e); }

        // 번역 적용 후 레이아웃 재계산
        setTimeout(() => {
            try { if (typeof fillOperationInfo === 'function') { fillOperationInfo(characterName); } } catch (e) { console.warn('[SAFE:fillOperationInfo-timeout]', e); }
            try {
                if (window.innerWidth <= 1200) {
                    const operationSettings = document.querySelector('.operation-settings');
                    if (operationSettings) {
                        operationSettings.style.gridTemplateColumns = '1fr';
                        operationSettings.style.display = 'flex';
                        operationSettings.style.flexDirection = 'column';
                        operationSettings.style.gap = '20px';
                    }
                }
            } catch (e) { console.warn('[SAFE:operationSettings-mobile]', e); }
        }, 100);

        // 영어/일본어에서 주의 메시지 표시
        try {
            if (currentLang === 'en' || currentLang === 'jp') {
                const warningMessage = currentLang === 'en' ?
                    'The recommended settings are based on future content. Some features may not be currently available (Revelations, Mindscape, etc.)' :
                    '推奨設定は将来のコンテンツを基準に提示されます。現在は存在しないコンテンツが含まれる可能性があります（啓示、イメジャリーなど）';
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning-message';
                warningDiv.style.cssText = 'background: rgba(17, 17, 17, 0.2); color: #6c757d; padding: 10px; margin: 15px 0; border-radius: 4px; font-size: 13px; opacity: 0.5;';
                warningDiv.innerHTML = `<strong>${currentLang === 'en' ? 'Notice' : '注意'}</strong><br>${warningMessage}`;
                const settingsCard = document.querySelector('.settings-card');
                if (settingsCard) {
                    settingsCard.insertBefore(warningDiv, settingsCard.firstChild.nextSibling);
                }
            }
        } catch (e) { console.warn('[SAFE:lang-warning]', e); }




        try {
            const tagElements = document.querySelectorAll('.chracter-tag, .chracter-role');
            tagElements.forEach(el => { if (el) el.style.display = ''; });
        } catch (e) { console.warn('[SAFE:tag-display]', e); }

        //role은 kr 아니면 숨기기
        try {
            const roleElement = document.querySelector('.chracter-role');
            if (currentLang !== 'kr' && roleElement) { roleElement.style.display = 'none'; }
        } catch (e) { console.warn('[SAFE:role-hide]', e); }

        try {
            const noteSection = document.querySelector('.operation-settings .setting-section:last-child');
            const notes = noteSection ? noteSection.querySelector('.operation-notes') : null;
            if (!notes || notes.innerHTML.trim() === '') {
                if (noteSection) noteSection.style.display = 'none';
                const operationSettings = document.querySelector('.operation-settings');
                if (operationSettings) {
                    operationSettings.style.gridTemplateColumns = '1fr';
                    operationSettings.style.display = 'flex';
                    operationSettings.style.flexDirection = 'column';
                }
            }
        } catch (e) { console.warn('[SAFE:note-section]', e); }

    });


    // MutationObserver를 사용해 동적 콘텐츠 변경 감지
    const observer = new MutationObserver((mutations) => {
        let shouldTranslate = false;
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                shouldTranslate = true;
            }
        });

        if (shouldTranslate && typeof window.translateStatTexts === 'function') {
            setTimeout(() => {
                window.translateStatTexts();
            }, 100);
        }
    });

    // 관찰 시작
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    // 언어별 계시 데이터 로드
    function loadRevelationDataByLanguage() {
        const currentLang = getCurrentLanguage();

        return new Promise((resolve) => {
            if (currentLang === 'en') {
                // 영어 계시 데이터 로드
                fetch(`${BASE_URL}/data/en/revelations/revelations.js?v=${APP_VERSION}`)
                    .then(response => response.text())
                    .then(scriptContent => {
                        // revelationData를 enRevelationData로 변경해서 실행
                        const modifiedScript = scriptContent.replace('const enRevelationData', 'window.enRevelationData');
                        eval(modifiedScript);
                        // console.log('영어 계시 데이터 로드 완료:', window.enRevelationData);
                        resolve();
                    })
                    .catch(error => {
                        console.error('영어 계시 데이터 로드 실패:', error);
                        resolve(); // 실패해도 계속 진행
                    });
            } else if (currentLang === 'jp') {
                // 일본어 계시 데이터는 영어 데이터와 동일하게 사용
                fetch(`${BASE_URL}/data/jp/revelations/revelations.js?v=${APP_VERSION}`)
                    .then(response => response.text())
                    .then(scriptContent => {
                        // revelationData를 jpRevelationData로 변경해서 실행
                        const modifiedScript = scriptContent.replace('const jpRevelationData', 'window.jpRevelationData');
                        eval(modifiedScript);
                        // console.log('일본어 계시 데이터 로드 완료:', window.jpRevelationData);
                        resolve();
                    })
                    .catch(error => {
                        console.error('일본어 계시 데이터 로드 실패:', error);
                        resolve(); // 실패해도 계속 진행
                    });
            } else {
                resolve(); // 한국어는 바로 완료
            }
        });
    }

    // 계시 데이터 로드 완료 후 캐릭터 정보 다시 렌더링
    function refreshRevelationDisplay() {
        const urlParams = new URLSearchParams(window.location.search);
        const characterName = urlParams.get('name');

        if (characterName && characterData[characterName]) {
            const character = characterData[characterName];

            // 계시 부분만 다시 렌더링
            const mainRevelationValue = document.querySelector('.main-revelation .value');
            const subRevelationValue = document.querySelector('.sub-revelation .value');

            // 메인 계시 설정
            if (character.main_revelation && Array.isArray(character.main_revelation)) {
                mainRevelationValue.textContent = '';
                mainRevelationValue.appendChild(window.createRevelationValue(character.main_revelation, true));
            }

            // 서브 계시 설정
            if (character.sub_revelation && Array.isArray(character.sub_revelation)) {
                subRevelationValue.textContent = '';
                subRevelationValue.appendChild(window.createRevelationValue(character.sub_revelation, false));
            }
        }
    }

    // 페이지 로드 후 언어별 계시 데이터 로드
    loadRevelationDataByLanguage().then(() => {
        // 데이터 로드 완료 후 계시 표시 새로고침
        setTimeout(refreshRevelationDisplay, 100);
    });


    // 공통 번역 유틸로 적용 함수 위임 (중복 로직 제거)
    try {
        applyTranslations = function () {
            try { if (window.CharI18N && typeof CharI18N.applySectionLabels === 'function') { CharI18N.applySectionLabels(); } } catch (e) { console.warn('[CharI18N:applySectionLabels]', e); }
            try {
                if (typeof window.translateStatTexts === 'function') {
                    window.translateStatTexts();
                } else if (window.I18NUtils && typeof I18NUtils.translateStatTexts === 'function') {
                    I18NUtils.translateStatTexts();
                }
            } catch (e) { console.warn('[I18N:translateStatTexts]', e); }
        };
    } catch (e) { console.warn('[I18N:override-applyTranslations]', e); }
    // 추천 페르소나와 파티 로드 함수
    function loadRecommendations(characterName) {
        if (!characterName || !recommendParty[characterName]) {
            document.getElementById('recommended-sections').style.display = 'none';
            return;
        }

        const data = recommendParty[characterName];
        document.getElementById('recommended-sections').style.display = 'block';

        // 추천 페르소나/무기 표시 여부 결정
        const personaCardEl = document.querySelector('.recommended-persona-card');
        const personaContentEl = document.getElementById('recommended-persona-content');
        const hasWeapon = Array.isArray(data.weapon) && data.weapon.some(function (w) { return typeof w === 'string' && w.trim().length > 0; });
        const hasPersona = Array.isArray(data.persona) && data.persona.some(function (category) {
            return Array.isArray(category.list) && category.list.some(function (p) { return typeof p === 'string' && p.trim().length > 0; });
        });

        // 섹션 제목 다국어 지원
        updateSectionTitles();

        // persona 또는 weapon 둘 중 하나라도 없으면 카드 비표시
        if (hasWeapon && hasPersona) {
            if (personaCardEl) personaCardEl.style.display = '';

            // 다국어 안내 노트 (비한국어) - 페르소나 카드가 표시될 때만 추가
            const currentLang = getCurrentLanguage();
            if (currentLang !== 'kr' && !document.querySelector('.unreleased-note')) {
                const noteContainer = document.createElement('div');
                noteContainer.className = 'unreleased-note';
                noteContainer.style.fontSize = '0.9em';
                noteContainer.style.color = '#888';
                noteContainer.style.marginBottom = '15px';
                noteContainer.style.fontStyle = 'italic';

                const noteText = document.createElement('p');
                noteText.textContent = currentLang === 'en'
                    ? 'Note: Some recommended personas & weapons may not be released yet in your region.'
                    : '※推奨されているペルソナとウェポンの一部は、現在の地域ではリリースされていない可能性があります。';

                noteContainer.appendChild(noteText);
                if (personaContentEl && personaContentEl.parentNode) {
                    personaContentEl.parentNode.insertBefore(noteContainer, personaContentEl);
                }
            }

            // 추천 페르소나/무기 로드
            loadRecommendedPersona(data.persona);
        } else {
            // 둘 다 없으면 카드 숨김 및 내용 초기화, 기존 안내문도 제거
            if (personaCardEl) personaCardEl.style.display = 'none';
            if (personaContentEl) personaContentEl.innerHTML = '';
            const existingNote = document.querySelector('.unreleased-note');
            if (existingNote && existingNote.parentNode) existingNote.parentNode.removeChild(existingNote);
        }

        // 추천 파티 로드
        loadRecommendedParty(data.party);
    }

    // 섹션 제목 다국어 지원
    function updateSectionTitles() {
        const currentLang = getCurrentLanguage();
        const personaTitle = document.querySelector('.recommended-persona-card h2');
        const partyTitle = document.querySelector('.recommended-party-card h2');

        if (currentLang === 'en') {
            if (personaTitle) personaTitle.textContent = 'Recommended Personas';
            if (partyTitle) partyTitle.textContent = 'Recommended Parties Example';
        } else if (currentLang === 'jp') {
            if (personaTitle) personaTitle.textContent = '推奨ペルソナ';
            if (partyTitle) partyTitle.textContent = '推奨パーティ例';
        } else {
            if (personaTitle) personaTitle.textContent = '추천 페르소나';
            if (partyTitle) partyTitle.textContent = '추천 파티 예시';
        }
    }

    // 페르소나 이름 다국어 지원
    function getLocalizedPersonaName(personaName) {
        const currentLang = getCurrentLanguage();
        if (!personaData || !personaData[personaName]) {
            return personaName;
        }

        if (currentLang === 'en' && personaData[personaName].name_en) {
            return personaData[personaName].name_en;
        } else if (currentLang === 'jp' && personaData[personaName].name_jp) {
            return personaData[personaName].name_jp;
        }
        return personaName;
    }

    // 캐릭터 이름 다국어 지원
    function getLocalizedCharacterName(characterName) {
        const currentLang = getCurrentLanguage();
        if (!characterData || !characterData[characterName]) {
            return characterName;
        }

        if (currentLang === 'en' && characterData[characterName].codename) {
            return characterData[characterName].codename;
        } else if (currentLang === 'jp' && characterData[characterName].name_jp) {
            return characterData[characterName].name_jp;
        }
        return characterName;
    }

    function loadRecommendedPersona(personaData) {
        const container = document.getElementById('recommended-persona-content');
        container.innerHTML = '';

        // Get character name from URL
        const urlParams = new URLSearchParams(window.location.search);
        const characterName = urlParams.get('name');
        const currentLang = getCurrentLanguage();

        // Add Wonder Weapons section if character has weapons
        if (characterName && recommendParty[characterName]?.weapon?.length > 0) {
            const weaponSection = document.createElement('div');
            weaponSection.className = 'persona-attribute-section';

            const title = document.createElement('h3');
            title.textContent = currentLang === 'en' ? 'WEAPONS' :
                (currentLang === 'jp' ? 'ウェポン' : 'WEAPONS');
            weaponSection.appendChild(title);

            const weaponList = document.createElement('div');
            weaponList.className = 'persona-list';

            recommendParty[characterName].weapon.forEach(weaponName => {
                const weaponItem = document.createElement('div');
                weaponItem.className = 'persona-item';
                // 이름 끝의 ! 표시 여부에 따라 하이라이트 적용
                const hasHighlight = /!+$/.test(weaponName);
                if (hasHighlight) weaponItem.classList.add('super-highlight');
                weaponItem.style.cursor = 'pointer';
                weaponName = weaponName.replace(/!+$/, '');

                const img = document.createElement('img');
                const imgSrc = `../assets/img/wonder-weapon/${weaponName}.webp`;
                img.src = imgSrc;
                img.alt = weaponName;
                img.onerror = function () {
                    this.onerror = null;
                    this.src = '../assets/img/placeholder.png';
                };

                const name = document.createElement('span');
                // Get localized weapon name from matchWeapons if available
                let weaponNameText = weaponName;
                if (matchWeapons && matchWeapons[weaponName]) {
                    if (currentLang === 'en' && matchWeapons[weaponName].name_en) {
                        weaponNameText = matchWeapons[weaponName].name_en;
                    } else if (currentLang === 'jp' && matchWeapons[weaponName].name_jp) {
                        weaponNameText = matchWeapons[weaponName].name_jp;
                    }
                }
                // 표시 텍스트에서는 ! 제거
                name.textContent = weaponNameText.replace(/!+$/, '');

                // Add click handler to show weapon effect
                weaponItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    showWeaponEffect(weaponName, imgSrc, weaponNameText);
                });

                weaponItem.appendChild(img);
                weaponItem.appendChild(name);
                weaponList.appendChild(weaponItem);
            });

            weaponSection.appendChild(weaponList);
            container.appendChild(weaponSection);
        }

        // 속성 이름 다국어 처리
        const attributeTranslations = {
            'BUFF': { 'en': 'BUFF', 'jp': 'バフ' },
            'DEF': { 'en': 'DEF', 'jp': '防御' },
            'ATK': { 'en': 'ATK', 'jp': '攻撃' },
            'HEAL': { 'en': 'HEAL', 'jp': '回復' },
            'DEBUFF': { 'en': 'DEBUFF', 'jp': 'デバフ' },
            'SUPPORT': { 'en': 'SUPPORT', 'jp': 'サポート' },
            'REDUCE DEF': { 'en': 'REDUCE DEF', 'jp': '防御低下' },
            'CRITICAL': { 'en': 'CRITICAL', 'jp': 'クリティカル' }
        };

        // personaData가 없거나 비어있으면 이후 렌더링 생략
        if (!Array.isArray(personaData) || personaData.length === 0) {
            return;
        }

        personaData.forEach(category => {
            const attributeSection = document.createElement('div');
            attributeSection.className = 'persona-attribute-section';

            const title = document.createElement('h3');
            // 속성 이름 다국어 처리
            const currentLang = getCurrentLanguage();
            const attribute = category.type;

            if (currentLang === 'en' && attributeTranslations[attribute]?.en) {
                title.textContent = attributeTranslations[attribute].en;
            } else if (currentLang === 'jp' && attributeTranslations[attribute]?.jp) {
                title.textContent = attributeTranslations[attribute].jp;
            } else {
                title.textContent = attribute;
            }
            attributeSection.appendChild(title);

            // 코멘트를 페르소나 리스트 위로 이동
            const commentContainer = document.createElement('div');
            commentContainer.className = 'comment-container';

            if (category.comment || category.comment_en || category.comment_jp) {
                const commentEl = document.createElement('p');
                commentEl.className = 'persona-comment';

                if (currentLang === 'en' && category.comment_en) {
                    commentEl.textContent = category.comment_en;
                } else if (currentLang === 'jp' && category.comment_jp) {
                    commentEl.textContent = category.comment_jp;
                } else {
                    commentEl.textContent = category.comment;
                }
                commentContainer.appendChild(commentEl);
            }

            const personaList = document.createElement('div');
            personaList.className = 'persona-list';

            try {
                category.list.forEach(personaName => {
                    const personaItem = document.createElement('div');
                    personaItem.className = 'persona-item';
                    // 이름 끝의 ! 표시 여부에 따라 하이라이트 적용
                    const hasHighlight = /!+$/.test(personaName);
                    if (hasHighlight) personaItem.classList.add('super-highlight');

                    personaName = personaName.replace(/!+$/, '');
                    const personaLink = document.createElement('a');
                    personaLink.href = '#';
                    personaLink.onclick = function (e) {
                        e.preventDefault();
                        // Open persona page in new tab with search parameter
                        const personaPageUrl = `${window.location.origin}/persona/?search=${encodeURIComponent(personaName)}`;
                        window.open(personaPageUrl, '_blank');
                    };

                    const img = document.createElement('img');
                    img.src = `../assets/img/persona/${personaName}.webp`;
                    img.alt = personaName;
                    img.onerror = function () {
                        this.onerror = null;
                        this.src = '../assets/img/placeholder.png';
                    };

                    const name = document.createElement('span');
                    // 표시 텍스트에서는 ! 제거 후 출력
                    const localized = getLocalizedPersonaName(personaName);
                    name.textContent = localized.replace(/!+$/, '');

                    personaLink.appendChild(img);
                    personaItem.appendChild(personaLink);
                    personaItem.appendChild(name);
                    personaList.appendChild(personaItem);
                });

                attributeSection.appendChild(personaList);
                // 코멘트 컨테이너를 페르소나 리스트 아래에 추가
                if (commentContainer.hasChildNodes()) {
                    attributeSection.appendChild(commentContainer);
                }
                container.appendChild(attributeSection);
            }
            catch (error) {
                // console.error('Error loading recommended persona:', error);
                console.log('Error loading recommended persona');
            }
        });
    }

    // Extract data from script text (same as index.html)
    function extractDataFromScript(scriptText) {
        // characterData와 characterList를 추출하는 정규식
        const characterDataMatch = scriptText.match(/const characterData = ({[\s\S]*?});/);
        const characterListMatch = scriptText.match(/const characterList = ({[\s\S]*?});/);

        if (!characterDataMatch || !characterListMatch) {
            throw new Error('Failed to extract data from script');
        }

        // JSON으로 파싱하기 위해 Function 생성자 사용
        const characterData = new Function('return ' + characterDataMatch[1])();
        const characterList = new Function('return ' + characterListMatch[1])();

        return { characterData, characterList };
    }

    // Load character list for the current language
    let currentLangCharacterList = { mainParty: [], supportParty: [] };
    let characterListLoaded = false;

    async function loadCharacterList() {
        const currentLang = getCurrentLanguage();
        if (currentLang === 'kr') {
            characterListLoaded = true;
            return; // No need to load for Korean
        }

        try {
            // console.log(`Loading ${currentLang} character list...`);
            const langUrl = `../data/${currentLang}/characters/characters.js?v=${Date.now()}`;
            // console.log('Character list URL:', langUrl);

            const langResponse = await fetch(langUrl);
            // console.log('Character list response status:', langResponse.status);

            if (langResponse.ok) {
                const langScriptText = await langResponse.text();

                const { characterData: langCharacterData, characterList: langCharacterList } = extractDataFromScript(langScriptText);


                // Store the character list
                currentLangCharacterList = {
                    mainParty: [...(langCharacterList.mainParty || [])],
                    supportParty: [...(langCharacterList.supportParty || [])]
                };
                characterListLoaded = true;

            } else {
                console.error(`Failed to load ${currentLang} character list:`, langResponse.status);
                characterListLoaded = true; // Mark as loaded to prevent blocking
            }
        } catch (error) {
            console.error(`Error loading ${currentLang} character list:`, error);
            characterListLoaded = true; // Mark as loaded to prevent blocking
        }
    }

    // Check if a character exists in the current language's character list
    async function isCharacterReleased(koreanName) {
        const currentLang = getCurrentLanguage();
        if (currentLang === 'kr') return true; // Always show all characters in Korean

        // If we haven't loaded the character list yet, assume it's not released
        // The actual check will happen when the list is loaded
        if (!characterListLoaded) {
            return false;
        }

        // Check if the character is in either mainParty or supportParty
        const isReleased = currentLangCharacterList.mainParty.includes(koreanName) ||
            currentLangCharacterList.supportParty.includes(koreanName);

        return isReleased;
    }

    // Check if character has persona5 or persona3 property and update ads visibility
    function updateAdsForPersona5(characterName) {
        try {
            const character = characterData[characterName];
            if (!character) return;

            // 기본적으로 모든 광고가 표시된 상태에서
            // Persona 5 캐릭터인 경우 일반 광고를 숨기고, 아닌 경우 Persona 5 광고를 숨김
            if (character.persona5) {
                // 일반 광고 숨기기
                const adsToHide = document.querySelectorAll('.ad-unit:not([id^="ad-unit-p5-"])');
                adsToHide.forEach(ad => {
                    if (ad && ad.style) {
                        ad.style.display = 'none';
                    }
                });
                // Persona 5 광고는 이미 표시된 상태 유지
            }
            else if (character.persona3) {
                // 일반 광고 숨기기
                const adsToHide = document.querySelectorAll('.ad-unit:not([id^="ad-unit-p3-"])');
                adsToHide.forEach(ad => {
                    if (ad && ad.style) {
                        ad.style.display = 'none';
                    }
                });
                // Persona 3 광고는 이미 표시된 상태 유지
            }
            else {
                // Persona 3, 5 광고 숨기기
                const p5AdsToHide = document.querySelectorAll('[id^="ad-unit-p5-"]');
                const p3AdsToHide = document.querySelectorAll('[id^="ad-unit-p3-"]');

                p5AdsToHide.forEach(ad => {
                    if (ad && ad.style) {
                        ad.style.display = 'none';
                    }
                });
                p3AdsToHide.forEach(ad => {
                    if (ad && ad.style) {
                        ad.style.display = 'none';
                    }
                });
                // 일반 광고는 이미 표시된 상태 유지
            }
        } catch (error) {
            console.warn('광고 업데이트 중 오류 발생:', error);
            // 오류가 발생해도 다른 기능에 영향을 주지 않도록 함
        }
    }


    // Load character list when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadCharacterList().then(() => {
            // If we have recommendations to show, refresh them after loading the character list
            const recommendations = document.getElementById('recommended-sections');
            const characterName = new URLSearchParams(window.location.search).get('name');
            if (characterName) {
                // Update ads based on character's persona3, persona5 property
                //updateAdsForPersona5(characterName);
                //pushAdUnitsForCharacter(characterName);
                // Load recommendations if the section is visible
                if (recommendations && recommendations.style.display !== 'none') {
                    loadRecommendations(characterName);
                }

            }
        });
    });

    function loadRecommendedParty(partyData) {
        const container = document.getElementById('recommended-party-content');
        container.innerHTML = '';

        partyData.forEach((party, index) => {
            const partySection = document.createElement('div');
            partySection.className = 'party-section';

            // 파티 코멘트 컨테이너 생성 (나중에 추가하기 위해)
            let commentEl = null;
            if (party.comment || party.comment_en || party.comment_jp) {
                const currentLang = getCurrentLanguage();
                commentEl = document.createElement('p');
                commentEl.className = 'party-comment';

                if (currentLang === 'en' && party.comment_en) {
                    commentEl.textContent = party.comment_en;
                } else if (currentLang === 'jp' && party.comment_jp) {
                    commentEl.textContent = party.comment_jp;
                } else {
                    commentEl.textContent = party.comment;
                }
            }

            const partyList = document.createElement('div');
            partyList.className = 'party-list';

            // Process each member asynchronously
            const processMembers = async () => {
                const currentPageChar = new URLSearchParams(window.location.search).get('name');
                for (const memberName of party.members) {
                    const memberItem = document.createElement('a');
                    memberItem.className = 'party-member';
                    if (memberName !== "") {
                        memberItem.href = `character.html?name=${memberName}`;
                    }
                    // Check if character is released in current language using Korean name
                    const isReleased = await isCharacterReleased(memberName);

                    if (!isReleased && memberName !== currentPageChar && memberName !== "") {
                        memberItem.classList.add('spoiler');
                        memberItem.addEventListener('click', function (e) {
                            if (this.classList.contains('spoiler')) {
                                e.preventDefault();
                                e.stopPropagation();
                                this.classList.remove('spoiler');
                            }
                            // On second click, the default link behavior will work
                        });
                    }
                    // 현재 페이지 캐릭터는 스포일러 제외 (전역 토글이 켜져 있어도 강제 해제)
                    if (memberName === currentPageChar) {
                        memberItem.classList.remove('spoiler');
                    }

                    const link = document.createElement('a');
                    link.href = `character.html?name=${memberName}`;

                    const img = document.createElement('img');
                    img.src = `../assets/img/tier/${memberName}.webp`;
                    img.alt = memberName;
                    img.onerror = function () { this.style.display = 'none'; };

                    const name = document.createElement('span');
                    name.className = 'character-name';
                    name.textContent = getLocalizedCharacterName(memberName);

                    link.appendChild(img);
                    memberItem.appendChild(link);
                    memberItem.appendChild(name);
                    partyList.appendChild(memberItem);
                }
            };

            // Start processing members
            processMembers();

            partySection.appendChild(partyList);

            // 파티 리스트 아래에 코멘트 추가
            if (commentEl) {
                const commentContainer = document.createElement('div');
                commentContainer.className = 'comment-container';
                commentContainer.appendChild(commentEl);
                partySection.appendChild(commentContainer);
            }

            container.appendChild(partySection);
        });
    }

    // Weapon Effect Modal Functions
    function showWeaponEffect(weaponId, imageUrl, weaponName) {
        const modal = document.getElementById('weapon-effect-modal');
        const modalImage = document.getElementById('weapon-effect-image');
        const modalTitle = document.getElementById('weapon-effect-title');
        const modalDescription = document.getElementById('weapon-effect-description');

        // Set the weapon image and name
        modalImage.src = imageUrl;
        modalImage.alt = weaponName;
        modalTitle.textContent = weaponName;

        // Get the effect text based on current language
        let effectText = 'No effect information available.';
        if (matchWeapons && matchWeapons[weaponId]) {
            if (currentLang === 'en' && matchWeapons[weaponId].effect_en) {
                effectText = matchWeapons[weaponId].effect_en;
            } else if (currentLang === 'jp' && matchWeapons[weaponId].effect_jp) {
                effectText = matchWeapons[weaponId].effect_jp;
            } else if (matchWeapons[weaponId].effect) {
                effectText = matchWeapons[weaponId].effect; // Default to Korean
            }
        }

        // Set the effect text with proper line breaks
        modalDescription.innerHTML = effectText.replace(/\n/g, '<br>');

        // modaDescription에 <br> 추가
        const br = document.createElement('br');
        modalDescription.appendChild(br);

        // modalDescription에 아래 'Detail' 추가하고 링크 걸기 /wonder-weapon
        const detailLink = document.createElement('a');
        detailLink.href = `/wonder-weapon/`;
        detailLink.textContent = 'Detail →';
        detailLink.target = '_blank';
        modalDescription.appendChild(detailLink);

        // Show the modal
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    // Close modal when clicking the close button
    document.addEventListener('click', function (e) {
        if (e.target.closest('.weapon-effect-close')) {
            closeWeaponEffectModal();
            return;
        }

        // Close modal when clicking outside the modal content
        const modal = document.getElementById('weapon-effect-modal');
        const modalContent = document.querySelector('.weapon-effect-modal-content');
        if (modal.classList.contains('show') && !e.target.closest('.weapon-effect-modal-content') && !e.target.closest('.persona-item')) {
            closeWeaponEffectModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
        const modal = document.getElementById('weapon-effect-modal');
        if (e.key === 'Escape' && modal.classList.contains('show')) {
            closeWeaponEffectModal();
        }
    });

    function closeWeaponEffectModal() {
        const modal = document.getElementById('weapon-effect-modal');
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
    // 실수로 포커스가 들어오면 즉시 떼기(드래그는 유지됨)
    document.querySelectorAll('.drag-me').forEach(el => {
        el.addEventListener('focus', () => el.blur());
    });

</script>

<!-- Weapon Effect Modal -->
<div id="weapon-effect-modal" class="weapon-effect-modal">
    <div class="weapon-effect-modal-content">
        <span class="weapon-effect-close">&times;</span>
        <div class="weapon-effect-header">
            <img id="weapon-effect-image" src="" alt="Weapon" class="weapon-effect-image">
            <h3 id="weapon-effect-title"></h3>
        </div>
        <div id="weapon-effect-description" class="weapon-effect-description"></div>
    </div>
</div>

<!-- Help Modal -->
<div id="help-modal" class="weapon-effect-modal">
    <div class="help-modal-content weapon-effect-modal-content">
        <span class="help-close weapon-effect-close">&times;</span>
        <div class="help-header weapon-effect-header">
            <h3 id="help-modal-title"></h3>
        </div>
        <div id="help-modal-description" class="help-description weapon-effect-description"></div>
    </div>
</div>



<style>
    @media screen and (max-width: 1200px) {
        .post-item {
            width: calc(100% - 40px);
            display: flex;
            flex-wrap: wrap;
            justify-content: left;
            gap: 0 !important;
        }

        .tactic-preview-container {
            margin-left: 16px !important;
        }

        .post-footer {
            display: none;
        }
    }

    .posts-list {
        margin-bottom: 20px;
    }

    .party-images-container {
        justify-content: right;
        margin-right: 16px;
    }
</style>