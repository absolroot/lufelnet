<script>
(function () {
  var params = new URLSearchParams(window.location.search);
  var lang = params.get('lang');
  if (!lang) return;

  var path = window.location.pathname;

  // / ì—ì„œ /?lang=xx â†’ /{lang}/ ë¡œ ì •ê·œí™”
  if (path === '/' && ['kr', 'en', 'jp'].indexOf(lang) !== -1) {
    params.delete('lang');
    var remaining = params.toString();
    history.replaceState(null, '', '/' + lang + '/' + (remaining ? '?' + remaining : ''));
    return;
  }

  // /{lang}/ ì—ì„œ ?lang= strip (pathì— ì´ë¯¸ ì–¸ì–´ ìˆìŒ)
  if (/^\/(kr|en|jp)\//.test(path)) {
    params.delete('lang');
    var remaining = params.toString();
    history.replaceState(null, '', path + (remaining ? '?' + remaining : ''));
  }
})();
</script>
<link rel="stylesheet" href="/apps/home/home.css">
<script src="/apps/home/tactic-posts-home.js"></script>
<script src="/apps/home/js/popular-characters.js"></script>
<script src="/apps/home/js/guides-home.js"></script>

{% if page.alternate_urls %}
{% for alt in page.alternate_urls %}
<link rel="alternate" hreflang="{{ alt[0] }}" href="{{ site.url }}{{ alt[1] }}" />
{% endfor %}
<link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ page.alternate_urls['ko'] | default: page.alternate_urls.first[1] }}" />
{% endif %}

{% include supabase-config.html %}

<style>
    .header-container .language-selector-container {
        max-width: 120px;
        margin: 0 0 4px 4px;
        padding: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border: none;
        /* ì¶”ê°€ */
    }

    .header-container .language-selector-container .options-container {
        top: 100%;
        /* ìƒë‹¨ì—ì„œ 100% ìœ„ì¹˜ì— ë°°ì¹˜ (ì•„ë˜ë¡œ) */
        bottom: auto;
        /* ê¸°ì¡´ bottom ì†ì„± ì œê±° */
        margin-top: 5px;
        /* ì„ íƒê¸°ì™€ì˜ ê°„ê²© */
    }

    /* Quick Grid styles moved to assets/js/home/quick-grid.js */
</style>


<div class="main-wrapper">
    <!-- ì–¸ì–´ ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div id="language-notice" class="language-notice" style="display: none;">
        <p id="language-notice-text"></p>
    </div>

    <!-- Header (logo, etc.) -->
    <div class="header-container">
        <h1 id="site-title">P5X ë£¨í˜ë¥´ë„·</h1> <span class="beta-text"></span>
        <div class="language-selector-container">
            <div class="custom-select">
                <div class="selected-option">
                    <img src="{{ site.baseurl }}/assets/img/flags/kr.png" alt="kr" class="flag-icon">
                    <span>í•œêµ­ì–´</span>
                </div>
                <div class="options-container">
                    <div class="option ${currentLang === 'kr' ? 'selected' : ''}" data-value="kr" role="button"
                        tabindex="0" onclick="return false;">
                        <img src="{{ site.baseurl }}/assets/img/flags/kr.png" alt="kr" class="flag-icon">
                        <span>í•œêµ­ì–´</span>
                    </div>

                    <div class="option ${currentLang === 'en' ? 'selected' : ''}" data-value="en" role="button"
                        tabindex="0" onclick="return false;">
                        <img src="{{ site.baseurl }}/assets/img/flags/en.png" alt="en" class="flag-icon">
                        <span>English</span>
                    </div>
                    <div class="option ${currentLang === 'jp' ? 'selected' : ''}" data-value="jp" role="button"
                        tabindex="0" onclick="return false;">
                        <img src="{{ site.baseurl }}/assets/img/flags/jp.png" alt="jp" class="flag-icon">
                        <span>æ—¥æœ¬èª</span>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Carousel: inserted above menu-cards -->
    <div id="home-carousel-root" style="width: 100%;"></div>

    <!--<div class="separator-line"></div>-->
    <!-- Main content -->
    <div class="main-content">
        <!-- Quick Launcher Grid -->
        <div class="quick-grid" id="quick-grid"></div>
        <div class="update-notice"></div>
    </div>
    <div class="separator-line"></div>
    <div class="popular-content" data-max-count="10">
        <div class="posts-header">
            <h2><a href="/character/" style="text-decoration: none; color: inherit;" id="popular-characters-title">ì¸ê¸°
                    ê´´ë„</a></h2>
            <a href="/character/" class="show-more-characters-btn" style="text-decoration: none; color: inherit;"
                id="show-more-characters-btn"><img src="{{ site.baseurl }}/assets/img/home/news_more2.png" alt="logo"
                    style="
                max-height: 11px; opacity: 0.75;
            "></a>
        </div>
        <div class="character-cards" id="popular-character-cards"></div>
    </div>
    <!-- Guild Bosses Section -->
    <div id="home-bosses-root"></div>
    <div class="separator-line"></div>
    <div class="guides-container">
        <div class="posts-header">
            <h2><a href="/article/" style="text-decoration: none; color: inherit;" id="guides-title">ê°€ì´ë“œ</a></h2>
            <a href="/article/" class="show-more-characters-btn" style="text-decoration: none; color: inherit;"
                id="show-more-guides-btn"><img src="{{ site.baseurl }}/assets/img/home/news_more2.png" alt="logo"
                    style="max-height: 11px; opacity: 0.75;"></a>
        </div>
        <div class="guides-list" id="guides-list"></div>
    </div>

    <div class="posts-container" id="posts-container">
        <div class="posts-header">
            <h2><a href="./tactic/tactics" style="text-decoration: none; color: inherit;" id="tactic-workshop-title">íƒí‹±
                    ë„ì„œê´€ NEW</a></h2>
            <a href="./tactic/tactics" class="show-more-posts-btn" style="text-decoration: none; color: inherit;"
                id="show-more-posts-btn"><img src="{{ site.baseurl }}/assets/img/home/news_more2.png" alt="logo" style="
                max-height: 11px; opacity: 0.75;
            "></a>
        </div>
        <div class="posts-list" id="postsList"></div>
    </div>

    <!-- ê´‘ê³  -->
    <!--
    <div class="ads-container responsive-padding">
        <ins class="adsbygoogle"
        style="display:block"
        data-ad-format="fluid"
        data-ad-layout-key="-gc+3n+7a-ag-4h"
        data-ad-client="ca-pub-5862324369257695"
        data-ad-slot="5373524213"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>-->

    <!--ê´‘ê³ -->
    <!--
    <div id="ad-unit-bottom" class="AD-bottom" style="width:100%; margin-top: 32px; text-align: center; align-items: center; display: flex; justify-content: center;">
    <ins class="adsbygoogle"
        style="display:inline-block;width:970px;height:90px"
        data-ad-client="ca-pub-5862324369257695"
        data-ad-slot="9244892982"></ins>
    </div>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    <div style="height: 20px;"></div>

    <style>
        @media (max-width: 1440px) {
            .AD-bottom {
                display: none !important;
            }
        }
        @media (min-width: 1440px) {
            .ads-container {
                display: none !important;
            }
        }
        .responsive-padding { margin: 20px 20px 20px 0; padding: 0 0; }
        @media (max-width: 1200px) { .responsive-padding {margin: 20px 0 0px 0; padding: 0; } }
    </style>
    -->
</div>
</div>

<!-- Support Modal Styles for Mobile Centering -->
<style>
    @media (max-width: 768px) {

        #supportModalJP .modal-content,
        #supportModalKR .modal-content,
        #kakaoPayModalHome .modal-content {
            margin: 0 !important;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    }
</style>

<!-- Support Modal for JP -->
<div id="supportModalJP" class="modal"
    style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #2a2a2a; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; color: white;">
        <span class="close-button" onclick="document.getElementById('supportModalJP').style.display='none'"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3 style="margin-top: 0; margin-bottom: 20px; text-align: center;">ã‚µãƒãƒ¼ãƒˆ</h3>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <a href="https://absolroot.fanbox.cc/plans" target="_blank" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                    background-color: #F5F5F5;
                    color: #333;
                    text-decoration: none;
                    font-weight: bold;
                    padding: 15px;
                    border-radius: 8px;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <img src="https://img.icons8.com/color/48/pixiv.png" alt="pixiv" style="width: 32px; height: 32px;">
                <span style="font-size: 1.1em;">pixivFANBOXã§æ”¯æ´ã™ã‚‹</span>
            </a>

            <a href="https://ko-fi.com/S6S11F0PUN" target="_blank" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                    background-color: #72a4f2;
                    color: white;
                    text-decoration: none;
                    font-weight: bold;
                    padding: 15px;
                    border-radius: 8px;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <img src="https://storage.ko-fi.com/cdn/cup-border.png" alt="Ko-fi" style="width: 32px; height: auto;">
                <span style="font-size: 1.1em;">Ko-fiã§æ”¯æ´ã™ã‚‹</span>
            </a>
        </div>
    </div>
</div>

<!-- Support Modal for KR -->
<div id="supportModalKR" class="modal"
    style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #2a2a2a; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; color: white;">
        <span class="close-button" onclick="document.getElementById('supportModalKR').style.display='none'"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3 style="margin-top: 0; margin-bottom: 20px; text-align: center;">ì„œí¬íŠ¸</h3>
        <!-- <p style="text-align: center; margin-bottom: 20px; word-break: keep-all;">
            ë£¨í˜ë¥´ë„·ì€ ì—¬ëŸ¬ë¶„ì˜ í›„ì›ìœ¼ë¡œë§Œ ìš´ì˜ë©ë‹ˆë‹¤.<br>
        </p>-->
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <!-- KakaoPay Button -->
            <button
                onclick="document.getElementById('supportModalKR').style.display='none'; document.getElementById('kakaoPayModalHome').style.display='block';"
                style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                    background-color: #ffeb00;
                    color: #000;
                    border: none;
                    font-weight: bold;
                    padding: 15px;
                    border-radius: 8px;
                    cursor: pointer;
                    width: 100%;
                    font-size: 1rem;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <img src="{{ site.baseurl }}/assets/img/logo/kakaopay-logo.png" alt="kakaopay"
                    style="height: 24px; vertical-align: middle;">
                <span>ì¹´ì¹´ì˜¤í˜ì´</span>
            </button>

            <!-- Ko-fi Button -->
            <a href="https://ko-fi.com/S6S11F0PUN" target="_blank" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                    background-color: #72a4f2;
                    color: white;
                    text-decoration: none;
                    font-weight: bold;
                    padding: 15px;
                    border-radius: 8px;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <img src="https://storage.ko-fi.com/cdn/cup-border.png" alt="Ko-fi" style="width: 32px; height: auto;">
                <span style="font-size: 1.1em;">Support me on Ko-fi</span>
            </a>
        </div>
    </div>
</div>

<!-- KakaoPay QR Modal (Home) -->
<div id="kakaoPayModalHome" class="modal"
    style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #2a2a2a; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; color: white; text-align: center;">
        <span class="close-button" onclick="document.getElementById('kakaoPayModalHome').style.display='none'"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3 style="margin-top: 0; margin-bottom: 20px;">KakaoPay QR</h3>
        <div style="background: white; padding: 20px; border-radius: 8px; display: inline-block;">
            <img src="{{ site.baseurl }}/assets/img/logo/kakaopay.png" alt="ì¹´ì¹´ì˜¤í˜ì´ QR"
                style="width: 100%; max-width: 250px; height: auto;">
        </div>
        <p style="margin-top: 15px; color: #ccc; font-size: 0.9em;">
            ìŠ¤ë§ˆíŠ¸í° ì¹´ë©”ë¼ ë˜ëŠ” ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.
        </p>
    </div>
</div>

<!-- Home i18n bootstrap -->
<script src="{{ site.baseurl }}/i18n/service/i18n-adapter.js?v={{ site.time | date: '%s' }}"></script>
<script src="/apps/home/js/home-i18n.js?v={{ site.time | date: '%s' }}"></script>
<!-- Carousel JS -->
<script src="/apps/home/js/carousel.js?v={{ site.time | date: '%s' }}"></script>
<!-- Tooltip (for affix hover) -->
<script src="{{ site.baseurl }}/assets/js/tooltip.js?v={{ site.time | date: '%s' }}"></script>
<!-- Bosses JS -->
<script src="/apps/home/js/bosses.js?v={{ site.time | date: '%s' }}"></script>
<!-- SOS JS -->
<script src="/apps/home/js/sos.js?v={{ site.time | date: '%s' }}"></script>
<!-- Quick Grid JS -->
<script src="/apps/home/js/quick-grid.js?v={{ site.time | date: '%s' }}"></script>
<link rel="stylesheet" href="/apps/home/js/carousel.css?v={{ site.time | date: '%s' }}">


<script>

    // ì˜¤ë²„ë ˆì´ ì¶”ê°€ í•¨ìˆ˜
    function addComingSoonOverlay(cardId, text) {
        const card = document.getElementById(cardId);
        if (!card) return;

        // ì´ë¯¸ ì˜¤ë²„ë ˆì´ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingOverlay = card.querySelector('.coming-soon-overlay');
        if (existingOverlay) {
            existingOverlay.remove();
        }

        // ì¹´ë“œë¥¼ ìƒëŒ€ ìœ„ì¹˜ë¡œ ì„¤ì •
        card.style.position = 'relative';

        // ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.createElement('div');
        overlay.className = 'coming-soon-overlay';
        overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 10;
            border-radius: inherit;
            cursor: not-allowed;
        `;
        overlay.textContent = text;

        // ë§í¬ ë¹„í™œì„±í™”
        const link = card.querySelector('a');
        if (link) {
            link.style.pointerEvents = 'none';
        }

        card.appendChild(overlay);
    }

    // ì˜¤ë²„ë ˆì´ ì œê±° í•¨ìˆ˜
    function removeComingSoonOverlay(cardId) {
        const card = document.getElementById(cardId);
        if (!card) return;

        // ì˜¤ë²„ë ˆì´ ì œê±°
        const overlay = card.querySelector('.coming-soon-overlay');
        if (overlay) {
            overlay.remove();
        }

        // ë§í¬ í™œì„±í™”
        const link = card.querySelector('a');
        if (link) {
            link.style.pointerEvents = 'auto';
        }
    }

    // ëª¨ë“  ë§í¬ì— ì–¸ì–´ íŒŒë¼ë¯¸í„° ì¶”ê°€ í•¨ìˆ˜
    function updateLinksWithLanguage(currentLang) {
        // ë©”ë‰´ ì¹´ë“œ ë§í¬ë“¤ ì—…ë°ì´íŠ¸
        const menuLinks = [
            { selector: '.menu-card a[href*="./character/"]', path: './character/' },
            { selector: '.menu-card a[href*="./persona/"]', path: './persona/' },
            { selector: '.menu-card a[href*="./revelations/"]', path: './revelations/' },
            { selector: '.menu-card a[href*="./tactic"]', path: './tactic/tactics' }
        ];

        menuLinks.forEach(linkInfo => {
            const link = document.querySelector(linkInfo.selector);
            if (link) {
                const url = new URL(linkInfo.path + `?lang=${currentLang}&v=${APP_VERSION}`, window.location.origin);
                link.href = url.pathname + url.search;
            }
        });

        // ì¸ê¸° ìºë¦­í„° ë§í¬ë“¤ ì—…ë°ì´íŠ¸
        const characterLinks = document.querySelectorAll('.character-card-img a[href*="/character/character.html"]');
        characterLinks.forEach(link => {
            const url = new URL(link.href);
            url.searchParams.set('lang', currentLang);
            link.href = url.pathname + url.search;
        });

        // íƒí‹± ë„ì„œê´€ ë§í¬ë“¤ ì—…ë°ì´íŠ¸ (í™ˆ ëª©ë¡ ì´ë™ ë²„íŠ¼)
        const tacticLinks = document.querySelectorAll('a[href*="./tactic/tactics"]');
        tacticLinks.forEach(link => {
            const url = new URL('./tactic/tactics' + `?lang=${currentLang}&v=${APP_VERSION}`, window.location.origin);
            link.href = url.pathname + url.search;
        });

        // ê³¼ê¸ˆíš¨ìœ¨ ê³„ì‚° ë§í¬ ì—…ë°ì´íŠ¸
        const payCalcLink = document.querySelector('a[href*="https://lufel.net/pay-calc"]');
        if (payCalcLink) {
            payCalcLink.href = `https://lufel.net/pay-calc/?lang=${currentLang}&v=${APP_VERSION}`;
        }
    }

    async function waitHomeI18nReady() {
        if (!window.__HOME_I18N_READY__) return;
        try {
            await window.__HOME_I18N_READY__;
        } catch (_) { }
    }

    function detectHomeRawLang() {
        if (window.HomeI18n && typeof window.HomeI18n.detectRawLang === 'function') {
            return window.HomeI18n.detectRawLang();
        }
        return 'kr';
    }

    function homeT(key, fallback, rawLang) {
        if (window.HomeI18n && typeof window.HomeI18n.t === 'function') {
            return window.HomeI18n.t(key, fallback, rawLang);
        }
        return fallback;
    }

    function getLanguageLabel(rawLang) {
        const labels = {
            kr: homeT('language_name_kr', 'í•œêµ­ì–´', rawLang),
            en: homeT('language_name_en', 'English', rawLang),
            jp: homeT('language_name_jp', 'æ—¥æœ¬èª', rawLang),
            cn: homeT('language_name_cn', 'ä¸­æ–‡', rawLang)
        };
        return labels[rawLang] || labels.kr;
    }

    // ë‹¤êµ­ì–´ ì§€ì› í•¨ìˆ˜
    async function updateLanguageContent() {
        await waitHomeI18nReady();
        const currentLang = detectHomeRawLang();

        const siteTitle = document.getElementById('site-title');
        if (siteTitle) {
            siteTitle.textContent = homeT('site_title', 'P5X ë£¨í˜ë¥´ë„·', currentLang);
        }

        const sectionTitles = {
            'popular-characters-title': homeT('popular_characters', 'ì¸ê¸° ê´´ë„', currentLang),
            'guides-title': homeT('guides', 'ê°€ì´ë“œ', currentLang),
            'tactic-workshop-title': homeT('tactic_workshop', 'íƒí‹± ë„ì„œê´€', currentLang)
        };

        Object.keys(sectionTitles).forEach((id) => {
            const element = document.getElementById(id);
            if (element && sectionTitles[id]) {
                element.textContent = sectionTitles[id];
            }
        });

        // ëª¨ë“  ë§í¬ì— í˜„ì¬ ì–¸ì–´ íŒŒë¼ë¯¸í„° ì¶”ê°€
        updateLinksWithLanguage(currentLang);

        // ì–¸ì–´ë³„ ë©”ë‰´ ì œí•œ (ê¸°ì¡´ ë™ì‘ ìœ ì§€)
        if (currentLang === 'en' || currentLang === 'jp') {
            removeComingSoonOverlay('menu-persona-card');
            removeComingSoonOverlay('menu-revelations-card');
            removeComingSoonOverlay('menu-tactic-card');

            const middleContainer = document.querySelector('.middle-container');
            if (middleContainer) {
                middleContainer.style.display = 'none';
            }
        } else {
            const tacticCard = document.getElementById('menu-tactic-card');
            if (tacticCard) {
                tacticCard.style.display = 'block';
            }

            removeComingSoonOverlay('menu-persona-card');
            removeComingSoonOverlay('menu-revelations-card');
            removeComingSoonOverlay('menu-tactic-card');

            const postsContainer = document.getElementById('posts-container');
            if (postsContainer) {
                postsContainer.style.display = 'block';
                const overlay = postsContainer.querySelector('.coming-soon-overlay');
                if (overlay) {
                    overlay.remove();
                }
                const links = postsContainer.querySelectorAll('a');
                links.forEach((link) => {
                    link.style.pointerEvents = 'auto';
                });
            }

            const middleContainer = document.querySelector('.middle-container');
            const guidesContainer = document.querySelector('.guides-container');

            if (middleContainer) {
                middleContainer.style.display = 'grid';
            }
            if (guidesContainer) {
                guidesContainer.style.display = 'block';
            }
        }
    }

    // ì–¸ì–´ë³„ SEO ì„¤ì • í•¨ìˆ˜
    async function updateSEOContent() {
        await waitHomeI18nReady();
        const currentLang = detectHomeRawLang();
        const seoTitle = homeT('seo_title', 'í˜ë¥´ì†Œë‚˜5 ë” íŒ¬í…€ X - ë£¨í˜ë¥´ë„·', currentLang);
        const seoDescription = homeT('seo_description', 'í˜ë¥´ì†Œë‚˜5 ë” íŒ¬í…€ Xì˜ ëª¨ë“  ì •ë³´ë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•˜ì„¸ìš”. ìºë¦­í„°, í˜ë¥´ì†Œë‚˜, ìŠ¤í‚¬, ê³µëµ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.', currentLang);

        document.title = seoTitle;

        const metaDescription = document.querySelector('meta[name="description"]');
        const ogTitle = document.querySelector('meta[property="og:title"]');
        const ogDescription = document.querySelector('meta[property="og:description"]');

        if (metaDescription) metaDescription.setAttribute('content', seoDescription);
        if (ogTitle) ogTitle.setAttribute('content', seoTitle);
        if (ogDescription) ogDescription.setAttribute('content', seoDescription);
    }

    // ì²« ë°©ë¬¸ì ì–¸ì–´ ê°ì§€ í•¨ìˆ˜
    async function checkAndDetectLanguage() {
        // path ê¸°ë°˜ ì–¸ì–´ í˜ì´ì§€ì—ì„œëŠ” IP ê°ì§€ ìŠ¤í‚µ
        if (/^\/(kr|en|jp)\/$/.test(window.location.pathname)) return;

        const hasLanguagePreference = localStorage.getItem('preferredLanguage');
        const hasLanguageDetected = localStorage.getItem('languageDetected');
        const urlParams = new URLSearchParams(window.location.search);
        const hasUrlLang = urlParams.get('lang');

        // ì²« ë°©ë¬¸ìì´ê³  ì–¸ì–´ ì„¤ì •ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ê°ì§€
        if (!hasLanguagePreference && !hasLanguageDetected && !hasUrlLang) {
            //console.log('ğŸ‘‹ ì²« ë°©ë¬¸ì ê°ì§€, IP ê¸°ë°˜ ì–¸ì–´ ì„¤ì • ì‹œì‘...');

            try {
                const apis = [
                    'https://ipapi.co/json/',
                    'https://ipinfo.io/json'
                ];

                let detectedLang = 'kr'; // ê¸°ë³¸ê°’

                for (const api of apis) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);

                        const response = await fetch(api, { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (response.ok) {
                            const data = await response.json();
                            const countryCode = data.country_code || data.country;

                            //console.log(`ğŸŒ ê°ì§€ëœ êµ­ê°€: ${countryCode}`);

                            if (countryCode === 'KR') {
                                detectedLang = 'kr';
                                //console.log('ğŸ‡°ğŸ‡· í•œêµ­ ì‚¬ìš©ì ê°ì§€');
                            } else if (countryCode === 'JP') {
                                detectedLang = 'jp';
                                //console.log('ğŸ‡¯ğŸ‡µ ì¼ë³¸ ì‚¬ìš©ì ê°ì§€');
                            } else {
                                detectedLang = 'en';
                                //console.log('ğŸŒ í•´ì™¸ ì‚¬ìš©ì ê°ì§€');
                            }

                            break; // ì²« ë²ˆì§¸ ì„±ê³µí•œ APIë¡œ ê²°ì •
                        }
                    } catch (error) {
                        //console.log(`âŒ ${api} ì‹¤íŒ¨:`, error.message);
                        continue;
                    }
                }

                // ì–¸ì–´ ì„¤ì • ì €ì¥
                localStorage.setItem('preferredLanguage', detectedLang);
                localStorage.setItem('languageDetected', 'true');

                //console.log(`âœ… ê°ì§€ëœ ì–¸ì–´: ${detectedLang}`);

                // í•œêµ­ì–´ê°€ ì•„ë‹Œ ê²½ìš° ë¦¬ë‹¤ì´ë ‰íŠ¸
                if (detectedLang !== 'kr') {
                    //console.log(`ğŸ”„ ${detectedLang} ì–¸ì–´ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸...`);
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('lang', detectedLang);
                    window.location.replace(newUrl.toString());
                    return;
                }

            } catch (error) {
                //console.log('âŒ ì–¸ì–´ ê°ì§€ ì‹¤íŒ¨:', error);
                // í´ë°±: ë¸Œë¼ìš°ì € ì–¸ì–´ í™•ì¸
                const browserLang = navigator.language.toLowerCase();
                let fallbackLang = 'kr';

                if (browserLang.startsWith('ja')) {
                    fallbackLang = 'jp';
                } else if (browserLang.startsWith('en')) {
                    fallbackLang = 'en';
                }

                localStorage.setItem('preferredLanguage', fallbackLang);
                localStorage.setItem('languageDetected', 'true');

                if (fallbackLang !== 'kr') {
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('lang', fallbackLang);
                    window.location.replace(newUrl.toString());
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        Navigation.load('home');
        VersionChecker.check();

        // ì²« ë°©ë¬¸ì ì–¸ì–´ ê°ì§€ (í™ˆí˜ì´ì§€ì—ì„œë§Œ)
        await checkAndDetectLanguage();

        // ì–¸ì–´ ì½˜í…ì¸  ì—…ë°ì´íŠ¸ (ìš°ì„  ì‹¤í–‰)
        await updateLanguageContent();

        // SEO ì„¤ì • ì—…ë°ì´íŠ¸
        await updateSEOContent();

        // í—¤ë”ì˜ ì–¸ì–´ ì„ íƒê¸° ì´ˆê¸°í™”
        const currentLang = detectHomeRawLang();
        const headerSelectedOption = document.querySelector('.header-container .selected-option');
        if (headerSelectedOption) {
            // í˜„ì¬ ì–¸ì–´ë¡œ ì„ íƒëœ ì˜µì…˜ ì—…ë°ì´íŠ¸
            const flagImg = headerSelectedOption.querySelector('.flag-icon');
            const langText = headerSelectedOption.querySelector('span');
            const displayFlagLang = ['kr', 'en', 'jp', 'cn', 'tw'].includes(currentLang) ? currentLang : 'kr';
            if (flagImg) flagImg.src = `${BASE_URL}/assets/img/flags/${displayFlagLang}.png`;
            if (langText) {
                langText.textContent = getLanguageLabel(currentLang);
            }

            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            headerSelectedOption.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const optionsContainer = headerSelectedOption.nextElementSibling;
                if (optionsContainer) {
                    optionsContainer.classList.toggle('active');
                }
            });
        }

        // í—¤ë”ì˜ ì–¸ì–´ ì˜µì…˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.querySelectorAll('.header-container .option').forEach(option => {
            option.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (this.classList.contains('disabled')) {
                    return;
                }

                const lang = this.getAttribute('data-value');
                Navigation.selectLanguage(lang, e);
            });
        });

        // ì–¸ì–´ ë¼ìš°í„° ì´ˆê¸°í™”
        if (typeof LanguageRouter !== 'undefined') {
            LanguageRouter.init().then(async () => {
                // ì–¸ì–´ ë¼ìš°í„° ì´ˆê¸°í™” í›„ ë‹¤ì‹œ í•œ ë²ˆ ì—…ë°ì´íŠ¸
                await updateLanguageContent();
                await updateSEOContent();
            });
        }

        // í™ˆ íƒí‹± ë¯¸ë¦¬ë³´ê¸°: tactic-posts-home.jsì˜ ê³µìš© í•¨ìˆ˜ë¡œ ì¼ì›í™”
        const currentLangFromUrl = detectHomeRawLang();
        if (typeof window.loadHomeTacticsFromSupabase === 'function') {
            window.loadHomeTacticsFromSupabase(currentLangFromUrl);
        }

        // í´ë¦­ ì´ë²¤íŠ¸ ê°ì§€í•˜ì—¬ ì–¸ì–´ ì„ íƒê¸° ë‹«ê¸°
        document.addEventListener('click', (e) => {
            const optionsContainers = document.querySelectorAll('.options-container');
            optionsContainers.forEach(container => {
                if (!container.contains(e.target) &&
                    !e.target.closest('.selected-option')) {
                    container.classList.remove('active');
                }
            });
        });
    });

    // í˜ì´ì§€ ì™„ì „ ë¡œë“œ í›„ ìµœì¢… ì–¸ì–´ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
    window.addEventListener('load', async () => {
        // ì•½ê°„ì˜ ì§€ì—° í›„ ìµœì¢… ì—…ë°ì´íŠ¸ (ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í›„)
        setTimeout(async () => {
            await updateLanguageContent();
            await updateSEOContent();
            //console.log('ğŸ”„ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì–¸ì–´ ì½˜í…ì¸  ìµœì¢… ì—…ë°ì´íŠ¸');
        }, 100);


        // ê´‘ê³  í° ë°•ìŠ¤ ìˆ¨ê¹€
        /*
        setTimeout(() => {
            document.querySelectorAll(".adsbygoogle").forEach(el => {
                const status = el.getAttribute("data-ad-status");
                const adslot = el.getAttribute("data-ad-slot");
                //console.log("google status", status);
                //console.log("google adslot", adslot);
                if (status === "unfilled" || el.querySelector("iframe") === null) {
                    el.style.display = "none";
                }
            });
        }, 2000); */ // ê´‘ê³  ë¡œë”© ê¸°ë‹¤ë ¸ë‹¤ê°€ 2ì´ˆ í›„ ê²€ì‚¬
    });

    // ìœ í‹¸
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    function formatDate(date) {
        try {
            if (window.HomeI18n && typeof window.HomeI18n.formatRelativeDate === 'function') {
                return window.HomeI18n.formatRelativeDate(date);
            }
        } catch (_) { }
        try {
            return date.toLocaleDateString('ko-KR');
        } catch (_) {
            return '';
        }
    }
</script>
