---
layout: default
custom_css: []
custom_js: [tooltip]
custom_data: [tooltip.js, wonder/skills.js]
permalink: /persona-new/
redirect_from:
- /kr/persona-new/
- /kr/persona-new/index.html
language: kr
title : 주요 페르소나 - 페르소나5 더 팬텀 X 루페르넷
description: 페르소나5 더 팬텀 X의 주요 페르소나 정보
alternate_urls:
en: /persona-new/?lang=en
jp: /persona-new/?lang=jp
---

{% if page.alternate_urls %}
<link rel="alternate" hreflang="ko" href="{{ site.url }}/persona-new/" />
{% for lang in page.alternate_urls %}
<link rel="alternate" hreflang="{{ lang[0] }}" href="{{ site.url }}{{ lang[1] }}" />
{% endfor %}
<link rel="alternate" hreflang="x-default" href="{{ site.url }}/persona-new/" />
{% endif %}

<div class="main-wrapper">
    <link rel="stylesheet" href="{{ site.baseurl }}/apps/persona-new/skillfrom.css?v={{ site.time | date: '%s' }}">
    <link rel="stylesheet" href="{{ site.baseurl }}/apps/persona-new/persona.css?v={{ site.time | date: '%s' }}">
    <script src="{{ site.baseurl }}/assets/js/ad-injector.js?v={{ site.time | date: '%s' }}"></script>
    <!-- 페르소나 순서 및 로더 -->
    <script src="{{ site.baseurl }}/data/persona/order.js?v={{ site.time | date: '%s' }}"></script>
    <script src="{{ site.baseurl }}/data/persona/nonorder.js?v={{ site.time | date: '%s' }}"></script>
    <script src="{{ site.baseurl }}/assets/js/persona-loader.js?v={{ site.time | date: '%s' }}"></script>
    <script src="{{ site.baseurl }}/apps/persona-new/getfrom.js?v={{ site.time | date: '%s' }}"></script>

    <div class="navigation-path">
        <script>document.write(`<a href="../../?v=${APP_VERSION}" id="nav-home">홈</a>`);</script>
        <span class="separator">/</span>
        <span class="current-page" id="nav-current">페르소나</span>
    </div>
    <div class="header-container">
        <h1 id="page-title">주요 페르소나</h1>
    </div>

    <!-- Filter section -->
    <div class="filter-section">
        <div class="filter-header">
            <button class="filter-toggle-btn">
                <img src="{{ site.baseurl }}/assets/img/character-cards/filter.png" alt="필터" />
                <span></span>
            </button>
            <button class="filter-reset-btn" style="display: none;">
                <img src="{{ site.baseurl }}/assets/img/character-cards/reset.png" alt="초기화" />
            </button>
        </div>

        <div class="filter-content" style="display: none;">
            <!-- Element filter -->
            <div class="filter-group">
                <h3>속성</h3>
                <div class="filter-options">
                    <label>
                        <input type="checkbox" name="element" value="물리">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_물리.png" alt="물리">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="총격">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_총격.png" alt="총격">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="화염">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_화염.png" alt="화염">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="빙결">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_빙결.png" alt="빙결">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="전격">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_전격.png" alt="전격">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="질풍">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_질풍.png" alt="질풍">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="염동">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_염동.png" alt="염동">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="핵열">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_핵열.png" alt="핵열">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="축복">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_축복.png" alt="축복">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="주원">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_주원.png" alt="주원">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="element" value="만능">
                        <img src="{{ site.baseurl }}/assets/img/persona/속성_만능.png" alt="만능">
                        <span></span>
                    </label>
                </div>
            </div>

            <!-- Position filter -->
            <div class="filter-group">
                <h3>직업</h3>
                <div class="filter-options">
                    <label>
                        <input type="checkbox" name="position" value="지배">
                        <img src="{{ site.baseurl }}/assets/img/persona/직업_지배.png" alt="지배">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="반항">
                        <img src="{{ site.baseurl }}/assets/img/persona/직업_반항.png" alt="반항">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="우월">
                        <img src="{{ site.baseurl }}/assets/img/persona/직업_우월.png" alt="우월">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="굴복">
                        <img src="{{ site.baseurl }}/assets/img/persona/직업_굴복.png" alt="굴복">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="방위">
                        <img src="{{ site.baseurl }}/assets/img/persona/직업_방위.png" alt="방위">
                    </label>
                    <label>
                        <input type="checkbox" name="position" value="구원">
                        <img src="{{ site.baseurl }}/assets/img/persona/직업_구원.png" alt="구원">
                    </label>
                </div>
            </div>

            <!-- Rarity filter -->
            <div class="filter-group">
                <h3>희귀도</h3>
                <div class="filter-options">
                    <label>
                        <input type="checkbox" name="rarity" value="5" hidden>
                        <div class="star-container">
                            <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                        </div>
                    </label>
                    <label>
                        <input type="checkbox" name="rarity" value="4" hidden>
                        <div class="star-container">
                            <img src="{{ site.baseurl }}/assets/img/persona/star4.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star4.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star4.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star4.webp" alt="★">
                        </div>
                    </label>
                    <label>
                        <input type="checkbox" name="rarity" value="3" hidden>
                        <div class="star-container">
                            <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                            <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                        </div>
                    </label>
                </div>
            </div>

            <!-- Grade filter -->
            <div class="filter-group">
                <h3>등급</h3>
                <div class="filter-options">
                    <label>
                        <input type="checkbox" name="grade" value="1">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade1.webp" alt="1등급">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="grade" value="2">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade2.webp" alt="2등급">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="grade" value="3">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade3.webp" alt="3등급">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="grade" value="4">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade4.webp" alt="4등급">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="grade" value="5">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade5.webp" alt="5등급">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="grade" value="6">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade6.webp" alt="6등급">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="grade" value="7">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade7.webp" alt="7등급">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="grade" value="8">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade8.webp" alt="8등급">
                        <span></span>
                    </label>
                    <label>
                        <input type="checkbox" name="grade" value="9">
                        <img src="{{ site.baseurl }}/assets/img/persona/persona-grade9.webp" alt="9등급">
                        <span></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Separator line -->
    <div class="separator-line"></div>

    <!-- Search section below filter section -->
    <div class="search-section">
        <div class="search-container">
            <div class="search-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z"
                        fill="rgba(255, 255, 255, 0.6)" />
                </svg>
            </div>
            <input type="text" id="personaSearch" placeholder="페르소나 검색..." autocomplete="off">
            <div id="searchDropdown" class="search-dropdown"></div>
        </div>
        <div class="search-count">
            <span id="filteredCount">전체 0개</span>
        </div>


        <span class="skill-level-separator">|</span>
        <div class="skill-level-toggle">
            <span class="skill-level-label">스킬 레벨 :</span>
            <div class="skill-level-buttons skill-level-buttons-global">
                <button type="button" class="skill-level-btn active" data-level="0">LV6</button>
                <button type="button" class="skill-level-btn" data-level="1">LV7</button>
                <button type="button" class="skill-level-btn" data-level="2">LV8</button>
                <button type="button" class="skill-level-btn" data-level="ALL">ALL</button>
            </div>
        </div>


    </div>

    <!-- Split View Container -->
    <div class="split-view-container">
        <!-- Left Panel: Filter & List -->
        <div class="persona-list-panel">
            <div class="persona-header-info"
                style="border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px; margin-bottom: 10px;">
                <h2 id="personaListTitle">Persona List</h2>
            </div>
            <div class="persona-cards drag-me" id="personaCards">
                <!-- Dynamically generated by JavaScript -->
            </div>
        </div>

        <!-- Right Panel: Detail -->
        <div class="persona-detail-panel">
            <div id="personaDetailContent" class="sticky-content">
                <div class="empty-state-message">
                    <p>페르소나를 선택하여 상세 정보를 확인하세요.</p>
                </div>
            </div>
        </div>
    </div>



</div>


</div>





<script>
    // 다국어 지원 함수
    async function updateLanguageContent() {
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';

        // 다국어 데이터 정의
        const i18nData = {
            kr: {
                nav_home: "홈",
                nav_current: "페르소나",
                page_title: "주요 페르소나",
                filtered_count: "전체",
                search_placeholder: "페르소나 검색...",
                filter_element: "속성",
                filter_position: "직업",
                filter_rarity: "희귀도",
                filter_grade: "등급",
                count_unit: "개",
                skill_level_label: "스킬 레벨 :"
            },
            en: {
                nav_home: "Home",
                nav_current: "Personas",
                page_title: "Core Personas",
                filtered_count: "Total",
                search_placeholder: "Search personas...",
                filter_element: "Element",
                filter_position: "Position",
                filter_rarity: "Rarity",
                filter_grade: "Grade",
                count_unit: "",
                skill_level_label: "Skill Level :"
            },
            jp: {
                nav_home: "ホーム",
                nav_current: "ペルソナ",
                page_title: "主要ペルソナ",
                filtered_count: "全体",
                search_placeholder: "ペルソナ検索...",
                filter_element: "属性",
                filter_position: "職業",
                filter_rarity: "タイプ",
                filter_grade: "グレード",
                count_unit: "",
                skill_level_label: "スキルレベル :"
            }
        };

        const data = i18nData[currentLang];
        if (!data) return;

        // 네비게이션 및 제목 업데이트
        const navHome = document.getElementById('nav-home');
        const navCurrent = document.getElementById('nav-current');
        const pageTitle = document.getElementById('page-title');
        const searchInput = document.getElementById('personaSearch');

        if (navHome) navHome.textContent = data.nav_home;
        if (navCurrent) navCurrent.textContent = data.nav_current;
        if (pageTitle) pageTitle.textContent = data.page_title;
        if (searchInput) searchInput.placeholder = data.search_placeholder;

        // 필터 라벨 번역
        const filterLabels = document.querySelectorAll('.filter-group h3');
        if (filterLabels[0]) filterLabels[0].textContent = data.filter_element;
        if (filterLabels[1]) filterLabels[1].textContent = data.filter_position;
        if (filterLabels[2]) filterLabels[2].textContent = data.filter_rarity;
        if (filterLabels[3]) filterLabels[3].textContent = data.filter_grade;

        // 스킬 레벨 라벨 번역
        const skillLevelLabel = document.querySelector('.skill-level-label');
        if (skillLevelLabel && data.skill_level_label) {
            skillLevelLabel.textContent = data.skill_level_label;
        }

        // 필터 카운트 텍스트 업데이트를 위한 전역 변수 설정
        window.i18nFilteredCount = data.filtered_count;
        window.i18nCountUnit = data.count_unit;

    }

    // 언어별 SEO 설정 함수
    function updateSEOContent() {
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';

        const seoData = {
            'kr': {
                title: '주요 페르소나 - 페르소나5 더 팬텀 X',
                description: '페르소나5 더 팬텀 X의 주요 페르소나 정보. 본능, 고유 스킬, 추천 스킬 정보를 확인하세요.'
            },
            'en': {
                title: 'Core Personas Build & Guide - Persona 5: The Phantom X',
                description: 'Core Persona information for Persona 5: The Phantom X. Talent, unique skills, and recommended skills.'
            },
            'jp': {
                title: '主要ペルソナ 攻略 - ペルソナ5 ザ・ファントム X',
                description: 'ペルソナ5 ザ・ファントム Xの主要ペルソナ情報。本能、固有スキル、推奨スキル情報をご確認ください。'
            }
        };

        const currentSEO = seoData[currentLang] || seoData['kr'];

        // 타이틀 업데이트
        document.title = currentSEO.title;

        // 메타 태그 업데이트
        const metaDescription = document.querySelector('meta[name="description"]');
        const ogTitle = document.querySelector('meta[property="og:title"]');
        const ogDescription = document.querySelector('meta[property="og:description"]');

        if (metaDescription) metaDescription.setAttribute('content', currentSEO.description);
        if (ogTitle) ogTitle.setAttribute('content', currentSEO.title);
        if (ogDescription) ogDescription.setAttribute('content', currentSEO.description);
    }



    // URL에서 검색 파라미터를 가져와서 검색을 실행하는 함수
    function handleSearchParam() {
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('search');
        //console.log("[DEBUG] search param:", searchQuery);

        if (searchQuery) {
            const searchInput = document.getElementById('personaSearch');
            //console.log("[DEBUG] searchInput:", searchInput);

            if (searchInput) {
                // URL 기반 검색 적용 플래그 설정 (자동 확장 및 드롭다운 숨김은 이 경우에만)
                window.isApplyingUrlSearch = true;
                searchInput.value = searchQuery;
                //console.log("[DEBUG] Dispatching input event");
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                // 초기 파라미터 적용 시 자동완성 드롭다운은 표시하지 않음
                const dropdown = document.getElementById('searchDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        Navigation.load('persona');
        VersionChecker.check();

        // SEO 설정 업데이트
        updateSEOContent();

        // 언어 라우터 초기화 및 콘텐츠 업데이트
        if (typeof LanguageRouter !== 'undefined') {
            // 이미 언어 파라미터가 있거나 직접 접근한 경우 리다이렉션 없이 진행
            const hasLangParam = window.location.search.includes('lang=');
            if (hasLangParam) {
                // 언어 파라미터가 있으면 바로 콘텐츠 로드
                updateLanguageContent().then(() => {
                    const runInit = () => {
                        initializePageContent().then(() => {
                            // 검색 파라미터 처리 (짧은 지연 추가)
                            setTimeout(handleSearchParam, 100);
                            // 전역 스킬 레벨 선택기 초기화
                            setupGlobalSkillLevelSelector();
                        });
                    };
                    if (typeof ensurePersonaFilesLoaded === 'function') {
                        ensurePersonaFilesLoaded(runInit);
                    } else {
                        runInit();
                    }
                });
            } else {
                // 언어 파라미터가 없으면 기본 한국어로 설정하고 콘텐츠 로드
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('lang', 'kr');
                window.history.replaceState({}, '', currentUrl);

                updateLanguageContent().then(() => {
                    const runInit = () => {
                        initializePageContent().then(() => {
                            // 검색 파라미터 처리 (짧은 지연 추가)
                            setTimeout(handleSearchParam, 100);
                            // 전역 스킬 레벨 선택기 초기화
                            setupGlobalSkillLevelSelector();
                        });
                    };
                    if (typeof ensurePersonaFilesLoaded === 'function') {
                        ensurePersonaFilesLoaded(runInit);
                    } else {
                        runInit();
                    }
                });
            }
        } else {
            updateLanguageContent().then(() => {
                const runInit = () => {
                    initializePageContent().then(() => {
                        // 검색 파라미터 처리 (짧은 지연 추가)
                        setTimeout(handleSearchParam, 100);
                        // 전역 스킬 레벨 선택기 초기화
                        setupGlobalSkillLevelSelector();
                    });
                };
                if (typeof ensurePersonaFilesLoaded === 'function') {
                    ensurePersonaFilesLoaded(runInit);
                } else {
                    runInit();
                }
            });
        }
    });

    // 공용: LV6/LV7/LV8/ALL 버튼으로 "/" 구분 3단 수치를 필터링하는 헬퍼
    function filterDescByLevel(originalText, levelIndex) {
        if (levelIndex === null || levelIndex === undefined) return originalText;
        // "150.0%/157.5%/165.0%" 또는 "1471/1854/2275" 형태를 개별 값으로 치환
        const tripleRegex = /(\d+(?:\.\d+)?)(%?)\/(\d+(?:\.\d+)?)(%?)\/(\d+(?:\.\d+)?)(%?)/g;
        return originalText.replace(tripleRegex, (match, n1, u1, n2, u2, n3, u3) => {
            const variants = [`${n1}${u1}`, `${n2}${u2}`, `${n3}${u3}`];
            return variants[levelIndex] || variants[0];
        });
    }

    async function initializePageContent() {
        const cardsContainer = document.getElementById('personaCards');

        // 현재 언어 확인
        const currentLang = typeof LanguageRouter !== 'undefined' ? LanguageRouter.getCurrentLanguage() : 'kr';

        // 새 데이터(window.personaFiles)만 사용 (기존 persona.js 는 더 이상 참조하지 않음)
        const personaSource = (typeof window !== 'undefined' && window.personaFiles)
            ? window.personaFiles
            : {};

        // order.js 에서 로드된 순서 정보 + nonorder.js 정보 병합
        let orderList = (typeof window !== 'undefined' && window.personaOrder)
            ? window.personaOrder
            : [];

        const nonOrderList = (typeof window !== 'undefined' && window.personaNonOrder)
            ? window.personaNonOrder
            : [];

        // 병합
        orderList = orderList.concat(nonOrderList);

        // 전역 스킬 레벨 (0: LV6, 1: LV7, 2: LV8, null: ALL)
        let globalSkillLevel = 0;


        // 정렬된 페르소나 이름 목록 구성
        const allNames = Object.keys(personaSource);
        const inOrder = [];
        const remaining = new Set(allNames);

        orderList.forEach(name => {
            if (remaining.has(name)) {
                inOrder.push(name);
                remaining.delete(name);
            }
        });
        const tail = Array.from(remaining).sort((a, b) => {
            // Sort by Star (Rarity) Descending
            const starA = personaSource[a].star || 0;
            const starB = personaSource[b].star || 0;
            if (starA !== starB) return starB - starA;
            // Name Ascending as fallback
            return a.localeCompare(b);
        });
        const sortedPersonas = inOrder.concat(tail);

        // Update initial count (정렬된 목록 길이 기준)
        const countText = window.i18nFilteredCount || '전체';
        const countUnit = window.i18nCountUnit !== undefined ? window.i18nCountUnit : (currentLang === 'kr' ? '개' : '');
        document.getElementById('filteredCount').textContent = `${countText} ${sortedPersonas.length}${countUnit}`;
        // 대량 렌더링 최적화: 청크 단위로 분할 렌더링하여 메인 스레드 점유를 줄임
        const CHUNK_SIZE = 10;
        let currentIndex = 0;

        function renderChunk() {
            const fragment = document.createDocumentFragment();
            let processed = 0;
            while (processed < CHUNK_SIZE && currentIndex < sortedPersonas.length) {
                const personaName = sortedPersonas[currentIndex];
                const index = currentIndex;
                const detailContainer = document.createElement('div');
                detailContainer.className = 'persona-detail-container';
                // Add data attributes for filtering
                detailContainer.dataset.element = personaSource[personaName].element;
                detailContainer.dataset.position = personaSource[personaName].position;
                detailContainer.dataset.rarity = personaSource[personaName].star;
                detailContainer.dataset.name = personaName;  // Add data-name attribute for search
                detailContainer.dataset.grade = personaSource[personaName].grade;  // Add data-grade attribute for grade
                detailContainer.dataset.event = personaSource[personaName].event;
                detailContainer.dataset.wild_emblem_rainbow = personaSource[personaName].wild_emblem_rainbow;
                // Preserve original order for restoring after collapse
                detailContainer.dataset.order = String(index);

                // Left card image section
                const cardSection = document.createElement('div');
                cardSection.className = 'persona-card-section';

                // Insert existing card creation code here
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.element = personaSource[personaName].element;
                card.dataset.position = personaSource[personaName].position;
                card.dataset.rarity = personaSource[personaName].star;

                // Add card background with optimization
                const cardBg = document.createElement('img');
                cardBg.src = `{{ site.baseurl }}/assets/img/persona/persona-card-${personaSource[personaName].element}.webp`;
                cardBg.alt = "card background";
                cardBg.className = 'card-background';
                cardBg.loading = 'lazy';
                cardBg.decoding = 'async';

                // Persona image with optimized lazy loading
                const img = document.createElement('img');
                img.src = `{{ site.baseurl }}/assets/img/persona/${personaName}.webp`;
                img.alt = personaName;
                img.className = 'persona-img';
                img.loading = 'lazy';
                img.decoding = 'async';  // 비동기 디코딩으로 렌더링 성능 향상

                // Add rarity cover
                const coverStar = document.createElement('img');
                coverStar.src = `{{ site.baseurl }}/assets/img/persona/persona-cover-star${personaSource[personaName].star}.webp`;
                coverStar.alt = "rarity cover";
                coverStar.className = 'cover-star';
                coverStar.loading = 'lazy';

                // Add remaining elements
                const positionContainer = document.createElement('div');
                positionContainer.className = 'position-container';

                const positionIcon = document.createElement('img');
                positionIcon.src = `{{ site.baseurl }}/assets/img/persona/직업_${personaSource[personaName].position}.png`;
                positionIcon.alt = personaSource[personaName].position;
                positionIcon.className = 'position-icon';
                positionIcon.loading = 'lazy';
                positionIcon.decoding = 'async';

                const elementIcon = document.createElement('img');
                elementIcon.src = `{{ site.baseurl }}/assets/img/persona/속성_${personaSource[personaName].element}.png`;
                elementIcon.alt = personaSource[personaName].element;
                elementIcon.className = 'element-icon';
                elementIcon.loading = 'lazy';
                elementIcon.decoding = 'async';

                positionContainer.appendChild(positionIcon);

                // Wild Emblem
                if (personaSource[personaName].wild_emblem_rainbow) {
                    const wildEmblem = document.createElement('img');
                    wildEmblem.src = `{{ site.baseurl }}/assets/img/persona/wild-emblem-rainbow.png`;
                    wildEmblem.alt = "wild emblem";
                    wildEmblem.className = 'wild-emblem';
                    wildEmblem.loading = 'lazy';
                    wildEmblem.decoding = 'async';
                    // attach to card so it can be absolutely positioned at top-right via CSS
                    card.appendChild(wildEmblem);
                }


                // Final assembly
                card.appendChild(cardBg);
                card.appendChild(img);
                card.appendChild(coverStar);
                card.appendChild(positionContainer);
                card.appendChild(elementIcon);

                // Tier Labels
                // Logic: 
                // 1. best_persona = true -> Tier S
                // 2. In orderList (and not best_persona) -> Tier A (assumed "in order means important")
                // 3. Otherwise -> No Label
                if (personaSource[personaName].best_persona) {
                    const tierLabel = document.createElement('div');
                    tierLabel.className = 'tier-label tier-s';
                    tierLabel.textContent = 'Tier S';
                    card.appendChild(tierLabel);
                } else {
                    // orderList check. `orderList` array contains names.
                    // We need to check if personaName is in original orderList.
                    // The `orderList` variable from line ~549 is the merged one.
                    // Let's rely on checking if it was in `inOrder` array logic, or just check the source lists.
                    // Re-checking window.personaOrder is safest since `orderList` was modified.
                    const originalOrder = (typeof window !== 'undefined' && window.personaOrder) ? window.personaOrder : [];
                    if (originalOrder.includes(personaName)) {
                        const tierLabel = document.createElement('div');
                        tierLabel.className = 'tier-label tier-a';
                        tierLabel.textContent = 'Tier A';
                        card.appendChild(tierLabel);
                    }
                }

                cardSection.appendChild(card);

                // 언어별 데이터 가져오기 (이름만 필요)
                const persona = personaSource[personaName];
                let displayName = personaName;
                if (currentLang === 'en') {
                    displayName = persona.name_en || personaName;
                } else if (currentLang === 'jp') {
                    displayName = persona.name_jp || personaName;
                }

                // Collapsed-mode name caption under the card
                const nameCaption = document.createElement('div');
                nameCaption.className = 'persona-name';
                nameCaption.textContent = displayName;

                // 만약 persona_best 값이 true 일경우 nameCaption에 color 적용
                if (personaSource[personaName].best_persona) {
                    nameCaption.style.color = 'rgb(255 109 122)';
                }
                cardSection.appendChild(nameCaption);

                // Info Section 생략 (detailPanel에서 생성)

                // Add sections to container
                detailContainer.appendChild(cardSection);

                fragment.appendChild(detailContainer);
                currentIndex++;
                processed++;
            }
            // 청크 단위로 DOM 삽입
            cardsContainer.appendChild(fragment);

            if (currentIndex < sortedPersonas.length) {
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(renderChunk, { timeout: 100 });
                } else {
                    setTimeout(renderChunk, 0);
                }
            } else {
                // 전체 렌더 완료 후 툴팁 1회 지연 실행 및 컨테이너 캐싱
                if (typeof addTooltips === 'function') {
                    if ('requestIdleCallback' in window) {
                        requestIdleCallback(() => addTooltips(), { timeout: 1000 });
                    } else {
                        setTimeout(() => addTooltips(), 0);
                    }
                }
                // 컨테이너 목록 캐싱 (필터/검색에서 재사용)
                containers = document.querySelectorAll('.persona-detail-container');
                // 인터랙션 연결
                wireCardInteractions();

                // 렌더 완료 후 URL 검색 파라미터 적용 (컨테이너 준비된 이후에만 실행)
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const searchQuery = urlParams.get('search');
                    if (searchQuery && searchInput) {
                        searchInput.value = searchQuery;
                        // 드롭다운은 표시하지 않음
                        if (dropdown) dropdown.style.display = 'none';
                        // 리스너가 연결된 이후 안전하게 트리거
                        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                } catch (_) { /* no-op */ }
            }
        }
        // 초기 렌더 시작
        if ('requestIdleCallback' in window) {
            requestIdleCallback(renderChunk, { timeout: 50 });
        } else {
            setTimeout(renderChunk, 0);
        }

        // 컨테이너 목록은 렌더 완료 후 할당됨
        let containers = null;

        // Function to generate detailed info section dynamically
        function generatePersonaDetail(personaName) {
            if (!personaSource[personaName]) return null;

            const persona = personaSource[personaName];
            // Create info section
            const infoSection = document.createElement('div');
            infoSection.className = 'persona-info-section';

            // Localize
            let displayName = personaName;
            let uniqueSkillName = persona.uniqueSkill?.name || '';
            let uniqueSkillEffect = persona.uniqueSkill?.desc || persona.uniqueSkill?.effect || '';
            let highlightEffect = persona.highlight?.desc || persona.highlight?.effect || '';
            let comment = persona.comment;

            if (currentLang === 'en') {
                displayName = persona.name_en || personaName;
                uniqueSkillName = persona.uniqueSkill?.name_en || persona.uniqueSkill?.name || uniqueSkillName;
                uniqueSkillEffect = persona.uniqueSkill?.desc_en || persona.uniqueSkill?.desc || persona.uniqueSkill?.effect_en || persona.uniqueSkill?.effect || uniqueSkillEffect;
                highlightEffect = persona.highlight?.desc_en || persona.highlight?.desc || persona.highlight?.effect_en || persona.highlight?.effect || highlightEffect;
                comment = persona.comment_en || persona.comment;
            } else if (currentLang === 'jp') {
                displayName = persona.name_jp || personaName;
                uniqueSkillName = persona.uniqueSkill?.name_jp || persona.uniqueSkill?.name || uniqueSkillName;
                uniqueSkillEffect = persona.uniqueSkill?.desc_jp || persona.uniqueSkill?.desc || persona.uniqueSkill?.effect_jp || persona.uniqueSkill?.effect || uniqueSkillEffect;
                highlightEffect = persona.highlight?.desc_jp || persona.highlight?.desc || persona.highlight?.effect_jp || persona.highlight?.effect || highlightEffect;
                comment = persona.comment_jp || persona.comment;
            }

            // Header Info
            const headerInfo = document.createElement('div');
            headerInfo.className = 'persona-header-info';
            headerInfo.innerHTML = `
                <h2>${displayName}</h2>
                <img class="persona-grade-img" src="{{ site.baseurl }}/assets/img/persona/persona-grade${persona.grade}.webp" alt="Grade ${persona.grade}">
             `;
            infoSection.appendChild(headerInfo);

            // Acquisition
            try {
                if (window.Acquisition && typeof window.Acquisition.renderInto === 'function') {
                    window.Acquisition.renderInto(infoSection, personaName);
                }
            } catch (e) { }

            // Instinct / Passive
            const instinctInfo = document.createElement('div');
            instinctInfo.className = 'persona-instinct-info';

            // Instinct Variants Logic
            const instinctVariants = [];
            if (Array.isArray(persona.passive_skill) && persona.passive_skill.length > 0) {
                persona.passive_skill.forEach((p) => {
                    if (!p) return;
                    let name = p.name; let effects = p.desc;
                    const priority = typeof persona.passive_priority === 'number' ? persona.passive_priority : 0;
                    if (currentLang === 'en') { name = p.name_en || name; effects = p.desc_en || effects; }
                    else if (currentLang === 'jp') { name = p.name_jp || name; effects = p.desc_jp || effects; }
                    let baseName = name; let roman = '';
                    const m = name && name.match(/\s+([IVX]+)$/);
                    if (m) { roman = m[1]; baseName = name.slice(0, m.index).trim(); }
                    instinctVariants.push({ name, baseName, roman, effects, priority });
                });
            } else {
                function pushLegacy(src) {
                    if (!src) return;
                    let name = src.name; let effects = src.effects; let priority = src.priority;
                    if (currentLang === 'en') { name = src.name_en || name; effects = src.effects_en || effects; }
                    else if (currentLang === 'jp') { name = src.name_jp || name; effects = src.effects_jp || effects; }
                    let baseName = name; let roman = '';
                    const m = name && name.match(/\s+([IVX]+)$/);
                    if (m) { roman = m[1]; baseName = name.slice(0, m.index).trim(); }
                    instinctVariants.push({ name, baseName, roman, effects, priority });
                }
                pushLegacy(persona.instinct);
                if (persona.instinct2) pushLegacy(persona.instinct2);
            }

            // Instinct Header
            const instinctHeader = document.createElement('div');
            instinctHeader.className = 'persona-instinct-header';
            const instinctTitle = document.createElement('h3');
            const baseTitle = instinctVariants[0] ? (instinctVariants[0].baseName || instinctVariants[0].name) : ((persona.instinct && persona.instinct.name) || '');
            instinctTitle.textContent = baseTitle;
            instinctHeader.appendChild(instinctTitle);

            let activeInstinctIndex = instinctVariants.length > 0 ? (instinctVariants.length - 1) : 0;
            let instinctButtonsWrap = null;
            if (instinctVariants.length > 1) {
                instinctButtonsWrap = document.createElement('div');
                instinctButtonsWrap.className = 'instinct-variant-buttons';
                instinctVariants.forEach((variant, idx) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'instinct-variant-btn' + (idx === activeInstinctIndex ? ' active' : '');
                    if (idx === 0) btn.textContent = '0';
                    else if (variant.roman) btn.textContent = variant.roman;
                    else btn.textContent = String(idx);

                    btn.setAttribute('aria-pressed', idx === activeInstinctIndex ? 'true' : 'false');
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (activeInstinctIndex === idx) return;
                        activeInstinctIndex = idx;
                        instinctButtonsWrap.querySelectorAll('.instinct-variant-btn').forEach((b, i) => {
                            b.classList.toggle('active', i === activeInstinctIndex);
                            b.setAttribute('aria-pressed', i === activeInstinctIndex);
                        });
                        updateInstinctEffect();
                    });
                    instinctButtonsWrap.appendChild(btn);
                });
                instinctHeader.appendChild(instinctButtonsWrap);
            }
            instinctInfo.appendChild(instinctHeader);

            const instinctEffectP = document.createElement('p');
            instinctEffectP.className = 'instinct-text';

            function updateInstinctEffect() {
                const current = instinctVariants[activeInstinctIndex] || instinctVariants[0];
                if (!current) return;
                const text = Array.isArray(current.effects) ? current.effects.join('\n') : current.effects;
                instinctEffectP.textContent = text || '';
                instinctTitle.textContent = current.baseName || current.name || instinctTitle.textContent;
                // Re-highlight if needed (tooltips)
                if (typeof addTooltips === 'function') try { addTooltips(); } catch (_) { }
            }
            updateInstinctEffect();
            instinctInfo.appendChild(instinctEffectP);
            infoSection.appendChild(instinctInfo);

            // Unique & Highlight
            const skillContainer = document.createElement('div');
            skillContainer.className = 'skill-highlight-container';

            // Unique
            const uniqueSkillInfo = document.createElement('div');
            uniqueSkillInfo.className = 'persona-unique-skill-info';
            const uniqueSkillIconName = (currentLang === 'en' || currentLang === 'jp')
                ? (persona.uniqueSkill.icon_gl || persona.uniqueSkill.icon) : persona.uniqueSkill.icon;

            const uniqueHeader = document.createElement('div');
            uniqueHeader.className = 'persona-unique-header';
            const uniqueTitle = document.createElement('h3');
            const uniqueIcon = document.createElement('img');
            uniqueIcon.src = `{{ site.baseurl }}/assets/img/persona/속성_${uniqueSkillIconName}.png`;
            uniqueIcon.className = 'skill-type-icon';
            uniqueTitle.appendChild(uniqueIcon);
            uniqueTitle.appendChild(document.createTextNode(` ${uniqueSkillName}`));
            uniqueHeader.appendChild(uniqueTitle);

            const uniqueDescP = document.createElement('p');
            uniqueDescP.dataset.originalText = uniqueSkillEffect;
            if (typeof globalSkillLevel === 'number' && typeof filterDescByLevel === 'function') {
                uniqueDescP.textContent = filterDescByLevel(uniqueSkillEffect, globalSkillLevel);
            } else {
                uniqueDescP.textContent = uniqueSkillEffect;
            }
            uniqueSkillInfo.appendChild(uniqueHeader);
            uniqueSkillInfo.appendChild(uniqueDescP);
            skillContainer.appendChild(uniqueSkillInfo);

            // Highlight
            const highlightLabels = { 'kr': 'HIGHLIGHT', 'en': 'HIGHLIGHT', 'jp': 'HIGHLIGHT' };
            const highlightLabel = highlightLabels[currentLang] || 'HIGHLIGHT';

            const highlightInfo = document.createElement('div');
            highlightInfo.className = 'persona-highlight-info';

            const highlightHeader = document.createElement('div');
            highlightHeader.className = 'persona-highlight-header';
            const highlightTitle = document.createElement('h3');
            highlightTitle.textContent = highlightLabel;
            highlightHeader.appendChild(highlightTitle);

            const highlightDescP = document.createElement('p');
            highlightDescP.dataset.originalText = highlightEffect;
            if (typeof globalSkillLevel === 'number' && typeof filterDescByLevel === 'function') {
                highlightDescP.textContent = filterDescByLevel(highlightEffect, globalSkillLevel);
            } else {
                highlightDescP.textContent = highlightEffect;
            }
            highlightInfo.appendChild(highlightHeader);
            highlightInfo.appendChild(highlightDescP);
            skillContainer.appendChild(highlightInfo);

            infoSection.appendChild(skillContainer);

            // Recommended Skills
            if (persona.recommendSkill && persona.recommendSkill.length > 0 && persona.recommendSkill[0].name) {
                const recommendedSkillLabels = { 'kr': '추천 스킬', 'en': 'Recommended Skills', 'jp': '推奨スキル' };
                const recommendedSkillLabel = recommendedSkillLabels[currentLang] || '추천 스킬';

                const recommendedSkills = document.createElement('div');
                recommendedSkills.className = 'persona-recommended-skills';
                recommendedSkills.innerHTML = `<h3>${recommendedSkillLabel}</h3><ul>` +
                    persona.recommendSkill.map(skill => {
                        const skillInfo = personaSkillList[skill.name];
                        if (!skillInfo) return '';
                        let skillName = skill.name; let skillDescription = skillInfo.description;
                        if (currentLang === 'en') { skillName = skillInfo.name_en || skill.name; skillDescription = skillInfo.description_en || skillInfo.description; }
                        else if (currentLang === 'jp') { skillName = skillInfo.name_jp || skill.name; skillDescription = skillInfo.description_jp || skillInfo.description; }
                        const iconName = (currentLang === 'en' || currentLang === 'jp') ? (skillInfo.icon_gl || skillInfo.icon) : skillInfo.icon;
                        const isPassive = skillInfo.type === "패시브";
                        return `<li data-priority="${skill.priority}">
                                    <div class="skill-info">
                                        <div class="skill-name-container">
                                            <img src="{{ site.baseurl }}/assets/img/persona/속성_${iconName}.png" alt="${iconName}" class="skill-icon">
                                            <span class="skill-name" data-skill-kor-full="${skill.name}">${skillName}</span>
                                        </div>
                                        <span class="skill-description" ${isPassive ? 'data-passive="true"' : ''}>${skillDescription}</span>
                                    </div>
                                </li>`;
                    }).join('') + `</ul>`;

                // Apply skill level filtering to recommended skills
                const recommendedDescSpans = recommendedSkills.querySelectorAll('.skill-description');
                recommendedDescSpans.forEach((span) => {
                    if (span.dataset.passive === 'true') return;
                    const original = span.textContent || '';
                    span.dataset.originalText = original;
                    if (typeof globalSkillLevel === 'number' && typeof filterDescByLevel === 'function') {
                        span.textContent = filterDescByLevel(original, globalSkillLevel);
                    }
                });
                infoSection.appendChild(recommendedSkills);
            }

            // Comment
            if (comment && comment.trim() !== '') {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'persona-comment';
                commentDiv.innerHTML = `<div class="comment-container"><span class="comment-icon">💬</span><p>${comment}</p></div>`;
                infoSection.appendChild(commentDiv);
            }

            return infoSection;
        }


        // 카드 클릭 인터랙션 (Selection -> Detail View)
        function wireCardInteractions() {
            const grid = document.getElementById('personaCards');
            if (containers) {
                containers.forEach(container => {
                    // 클릭 가능한 영역 설정
                    const clickTarget = container.querySelector('.persona-card-section') || container;
                    clickTarget.style.cursor = 'pointer';

                    clickTarget.onclick = (e) => {
                        e.stopPropagation();

                        // 1. Highlight Selection
                        containers.forEach(c => c.classList.remove('selected'));
                        container.classList.add('selected');

                        // 2. Render Detail
                        renderDetailInPanel(container);
                    };
                });
            }
        }

        function renderDetailInPanel(sourceContainer) {
            const detailPanel = document.getElementById('personaDetailContent');
            const sourceName = sourceContainer.dataset.name;

            // Generate content dynamically
            const infoSection = generatePersonaDetail(sourceName);
            if (!infoSection) {
                return;
            }

            // Clear previous content
            detailPanel.innerHTML = '';
            detailPanel.className = 'sticky-content';

            // Append to panel
            detailPanel.appendChild(infoSection);

            // Re-bind tooltips
            // The generate function doesn't automatically bind tooltips, we need to do it here
            if (typeof bindTooltipElement === 'function') {
                const newTooltips = detailPanel.querySelectorAll('.tooltip-text, [data-tooltip]');
                newTooltips.forEach(bindTooltipElement);
            } else if (typeof addTooltips === 'function') {
                try { addTooltips(); } catch (_) { }
            }
        }


        // ----------------------------------------------------
        // Filter implementation

        const filterToggleBtn = document.querySelector('.filter-toggle-btn');
        const filterContent = document.querySelector('.filter-content');
        const filterResetBtn = document.querySelector('.filter-reset-btn');
        const checkboxes = document.querySelectorAll('.filter-options input[type="checkbox"]');
        filterContent.style.display = 'block';

        // Filter toggle
        filterToggleBtn.addEventListener('click', () => {
            filterContent.style.display = filterContent.style.display === 'none' ? 'block' : 'none';
        });

        // 필터 디바운싱을 위한 타이머
        let filterDebounceTimer;

        // Detect checkbox changes with debouncing
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                // 디바운싱 적용
                clearTimeout(filterDebounceTimer);
                filterDebounceTimer = setTimeout(() => {
                    // Check if any filters are selected
                    const hasChecked = Array.from(checkboxes).some(cb => cb.checked);
                    //filterResetBtn.style.display = hasChecked ? 'block' : 'none';

                    // Apply filters
                    applyFilters();
                }, 50); // 50ms 디바운싱
            });
        });

        // Reset button

        filterResetBtn.addEventListener('click', () => {
            // 배치로 체크박스 상태 변경
            requestAnimationFrame(() => {
                checkboxes.forEach(cb => cb.checked = false);
                filterResetBtn.style.display = 'none';

                // 캐시 초기화
                filterCache = {
                    elements: new Set(),
                    positions: new Set(),
                    rarities: new Set(),
                    grades: new Set()
                };

                applyFilters();
            });
        });

        filterToggleBtn.style.display = 'none';
        filterResetBtn.style.display = 'none';

        // 필터 상태 캐싱을 위한 변수들
        let filterCache = {
            elements: new Set(),
            positions: new Set(),
            rarities: new Set(),
            grades: new Set()
        };

        // 성능 최적화된 필터 적용 함수
        function applyFilters() {
            if (!containers) return; // 아직 렌더링 중이면 무시
            // 필터 상태를 Set으로 캐싱하여 빠른 조회
            filterCache.elements = new Set(Array.from(document.querySelectorAll('input[name="element"]:checked')).map(cb => cb.value));
            filterCache.positions = new Set(Array.from(document.querySelectorAll('input[name="position"]:checked')).map(cb => cb.value));
            filterCache.rarities = new Set(Array.from(document.querySelectorAll('input[name="rarity"]:checked')).map(cb => parseInt(cb.value)));
            filterCache.grades = new Set(Array.from(document.querySelectorAll('input[name="grade"]:checked')).map(cb => cb.value));

            let visibleCount = 0;

            // requestAnimationFrame으로 DOM 조작 배치 처리
            requestAnimationFrame(() => {
                containers.forEach(container => {
                    const element = container.dataset.element;
                    const position = container.dataset.position;
                    const rarity = parseInt(container.dataset.rarity);
                    const grade = container.dataset.grade;
                    const personaName = container.dataset.name;

                    // Set.has()로 빠른 조회 (O(1))
                    const elementMatch = filterCache.elements.size === 0 || filterCache.elements.has(element);
                    const positionMatch = filterCache.positions.size === 0 || filterCache.positions.has(position);
                    const rarityMatch = filterCache.rarities.size === 0 || filterCache.rarities.has(rarity);
                    const gradeMatch = filterCache.grades.size === 0 ||
                        filterCache.grades.has(grade);

                    const isVisible = elementMatch && positionMatch && rarityMatch && gradeMatch;

                    // display 대신 position으로 성능 개선 (레이아웃 재계산 방지)
                    if (isVisible) {
                        container.style.position = 'relative';
                        container.style.visibility = 'visible';
                        container.style.height = 'auto';
                        visibleCount++;
                    } else {
                        container.style.position = 'absolute';
                        container.style.visibility = 'hidden';
                        container.style.height = '0';
                    }
                });

                // 카운트 업데이트
                const countText = window.i18nFilteredCount || '전체';
                const countUnit = window.i18nCountUnit !== undefined ? window.i18nCountUnit : (currentLang === 'kr' ? '개' : '');
                document.getElementById('filteredCount').textContent = `${countText} ${visibleCount}${countUnit}`;

                // 광고 가시성 관리
                //manageAdVisibility();
            });
        }

        // Search functionality implementation
        const searchInput = document.getElementById('personaSearch');
        const dropdown = document.getElementById('searchDropdown');
        // 드롭다운 노출 억제 플래그 (엔터/URL 검색 확정 후 재노출 방지)
        let suppressDropdown = false;
        // 마지막 확정 검색어 (엔터/URL 적용 시 기록)
        let lastConfirmedSearchValue = '';
        // Note: reuse cached NodeList from above to avoid redeclaration and extra DOM query
        // const containers = document.querySelectorAll('.persona-detail-container');

        // 언어별 페르소나 이름 매핑 생성
        const personaNameMapping = {};
        const nameSource = (typeof window !== 'undefined' && window.personaFiles)
            ? window.personaFiles
            : {};
        Object.keys(nameSource).forEach(koreanName => {
            const persona = nameSource[koreanName];
            personaNameMapping[koreanName.toLowerCase()] = koreanName;

            // 영어 이름 추가
            if (persona.name_en) {
                personaNameMapping[persona.name_en.toLowerCase()] = koreanName;
            }

            // 일본어 이름 추가
            if (persona.name_jp) {
                personaNameMapping[persona.name_jp.toLowerCase()] = koreanName;
            }
        });

        // 디바운싱을 위한 타이머
        let searchDebounceTimer;

        // 검색 핸들러 함수 분리
        function handleSearchInput(e) {
            const searchValue = e ? e.target.value.toLowerCase() : '';

            // 사용자가 마지막 확정 검색어에서 변경을 시작하면 드롭다운 억제 해제
            if (searchValue !== lastConfirmedSearchValue) {
                suppressDropdown = false;
            }

            // 드롭다운 업데이트 (즉시) — 억제 중이면 숨김 유지
            if (suppressDropdown) {
                if (dropdown) dropdown.style.display = 'none';
            } else {
                updateDropdown(searchValue);
            }

            // 검색 필터링 (디바운싱 적용)
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                filterBySearch(searchValue);
            }, 100); // 100ms 디바운싱
        }

        // 이벤트 리스너 등록
        searchInput.addEventListener('input', handleSearchInput);
        // Enter로 검색 확정 시 드롭다운 닫고 즉시 필터 적용
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = searchInput.value.trim().toLowerCase();
                // 일반 입력 검색: 드롭다운 유지, 자동 확장 없음
                clearTimeout(searchDebounceTimer);
                filterBySearch(value);
            }
        });

        // 드롭다운 업데이트 함수 분리
        function updateDropdown(searchValue) {
            // URL 파라미터 검색 적용 중에는 드롭다운을 노출하지 않음
            if (window.isApplyingUrlSearch) {
                if (dropdown) dropdown.style.display = 'none';
                return;
            }
            if (suppressDropdown) {
                if (dropdown) dropdown.style.display = 'none';
                return;
            }
            dropdown.innerHTML = '';

            if (searchValue.length > 0) {
                const matches = Object.keys(personaNameMapping).filter(name =>
                    name.includes(searchValue)
                ).slice(0, 10); // 성능을 위해 최대 10개로 제한

                if (matches.length > 0) {
                    dropdown.style.display = 'block';

                    // DocumentFragment로 배치 DOM 추가
                    const fragment = document.createDocumentFragment();

                    matches.forEach(matchedName => {
                        const koreanName = personaNameMapping[matchedName];
                        const persona = nameSource[koreanName];

                        // 현재 언어에 맞는 표시 이름 가져오기
                        let displayName = koreanName;
                        if (currentLang === 'en' && persona.name_en) {
                            displayName = persona.name_en;
                        } else if (currentLang === 'jp' && persona.name_jp) {
                            displayName = persona.name_jp;
                        }

                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        div.textContent = displayName;
                        div.addEventListener('click', () => {
                            searchInput.value = displayName;
                            dropdown.style.display = 'none';
                            filterBySearch(matchedName.toLowerCase());
                        });
                        fragment.appendChild(div);
                    });

                    dropdown.appendChild(fragment);
                } else {
                    dropdown.style.display = 'none';
                }
            } else {
                dropdown.style.display = 'none';
            }
        }

        // 검색 결과 캐싱
        let searchCache = new Map();

        // 성능 최적화된 검색 필터링 함수
        function filterBySearch(searchValue) {
            // 캐시에서 결과 확인
            if (searchCache.has(searchValue)) {
                applySearchResults(searchCache.get(searchValue));
                return;
            }

            let visibleCount = 0;
            const results = [];
            let firstVisibleIndex = -1;

            // requestAnimationFrame으로 배치 처리
            requestAnimationFrame(() => {
                containers.forEach(container => {
                    const koreanName = container.dataset.name;
                    const persona = nameSource[koreanName];

                    // 모든 언어 이름으로 검색 가능하도록
                    const searchableNames = [
                        koreanName.toLowerCase(),
                        persona.name_en ? persona.name_en.toLowerCase() : '',
                        persona.name_jp ? persona.name_jp.toLowerCase() : ''
                    ].filter(name => name); // 빈 문자열 제거

                    const isVisible = searchValue === '' || searchableNames.some(name => name.includes(searchValue));

                    // display 대신 position으로 성능 개선
                    if (isVisible) {
                        container.style.position = 'relative';
                        container.style.visibility = 'visible';
                        container.style.height = 'auto';
                        visibleCount++;
                    } else {
                        container.style.position = 'absolute';
                        container.style.visibility = 'hidden';
                        container.style.height = '0';
                    }

                    results.push(isVisible);
                    if (isVisible && firstVisibleIndex === -1) {
                        firstVisibleIndex = results.length - 1;
                    }
                });

                // 결과 캐싱 (최대 50개까지만)
                if (searchCache.size < 50) {
                    searchCache.set(searchValue, results);
                }

                // 카운트 업데이트
                const countText = window.i18nFilteredCount || '전체';
                const countUnit = window.i18nCountUnit !== undefined ? window.i18nCountUnit : (currentLang === 'kr' ? '개' : '');
                document.getElementById('filteredCount').textContent = `${countText} ${visibleCount}${countUnit}`;

                // Update List Title
                const listTitle = document.getElementById('personaListTitle');
                if (listTitle) {
                    if (currentLang === 'en') listTitle.textContent = 'Persona List';
                    else if (currentLang === 'jp') listTitle.textContent = 'ペルソナリスト';
                    else listTitle.textContent = '페르소나 목록';
                }

                // URL 파라미터 검색일 때만 자동 확장/드롭다운 숨김 적용
                if (window.isApplyingUrlSearch) {
                    const expandAllToggle = document.getElementById('expandAllToggle');
                    if (!expandAllToggle || !expandAllToggle.checked) {
                        // 기존 확장 상태 초기화
                        containers.forEach(c => { c.classList.remove('expanded'); c.classList.remove('active'); });
                        if (firstVisibleIndex >= 0) {
                            const firstEl = containers[firstVisibleIndex];
                            if (firstEl) {
                                firstEl.classList.add('selected'); // Just select, don't expand in split view
                                renderDetailInPanel(firstEl);
                            }
                        }
                    }
                    // 드롭다운 숨김
                    const dropdown = document.getElementById('searchDropdown');
                    if (dropdown) dropdown.style.display = 'none';
                    // 플래그 리셋
                    window.isApplyingUrlSearch = false;
                } else if (!window.hasAutoSelected) {
                    // Auto-select first visible item on initial load (if not searching)
                    if (firstVisibleIndex >= 0) {
                        const firstEl = containers[firstVisibleIndex];
                        if (firstEl) {
                            firstEl.classList.add('selected');
                            renderDetailInPanel(firstEl);
                            window.hasAutoSelected = true;
                        }
                    }
                }
            });
        }

        // 캐시된 검색 결과 적용 함수
        function applySearchResults(results) {
            const containers = document.querySelectorAll('.persona-detail-container');
            let visibleCount = 0;
            let firstVisibleIndex = -1;

            requestAnimationFrame(() => {
                containers.forEach((container, index) => {
                    const isVisible = results[index];

                    if (isVisible) {
                        container.style.position = 'relative';
                        container.style.visibility = 'visible';
                        container.style.height = 'auto';
                        visibleCount++;
                        if (firstVisibleIndex === -1) firstVisibleIndex = index;
                    } else {
                        container.style.position = 'absolute';
                        container.style.visibility = 'hidden';
                        container.style.height = '0';
                    }
                });

                // 카운트 업데이트
                const countText = window.i18nFilteredCount || '전체';
                const countUnit = window.i18nCountUnit !== undefined ? window.i18nCountUnit : (currentLang === 'kr' ? '개' : '');
                document.getElementById('filteredCount').textContent = `${countText} ${visibleCount}${countUnit}`;

                // 검색 후 광고 가시성 관리
                //manageAdVisibility();

                // URL 파라미터 검색일 때만 자동 확장/드롭다운 숨김 적용
                if (window.isApplyingUrlSearch) {
                    // 드롭다운 숨김
                    if (dropdown) dropdown.style.display = 'none';
                    // 첫 번째 결과 자동 확장 (expand-all이 꺼져 있을 때만)
                    const expandAllToggle = document.getElementById('expandAllToggle');
                    if (!expandAllToggle || !expandAllToggle.checked) {
                        containers.forEach(c => { c.classList.remove('expanded'); c.classList.remove('active'); });
                        if (firstVisibleIndex >= 0) {
                            const firstEl = containers[firstVisibleIndex];
                            if (firstEl) {
                                firstEl.classList.add('expanded');
                                firstEl.classList.add('active');
                            }
                        }
                    }
                    // 플래그 리셋
                    window.isApplyingUrlSearch = false;
                }
            });
        }

        // Close dropdown when clicking outside search
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // When keyboard appears
        searchInput.addEventListener('focus', () => {
            document.body.classList.add('keyboard-open');
        });

        // When keyboard disappears
        searchInput.addEventListener('blur', () => {
            document.body.classList.remove('keyboard-open');
        });

        // Prevent viewport size changes on iOS
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.content = 'width=device-width, initial-scale=1, maximum-scale=1';
            }
        }
    } // initializePageContent 함수 종료

    // ----------------------------------------------------
    // Global skill level selector (LV6 / LV7 / LV8 / ALL)
    // ----------------------------------------------------

    function setupGlobalSkillLevelSelector() {
        const buttons = document.querySelectorAll('.skill-level-buttons-global .skill-level-btn');
        if (!buttons.length) return;

        function applyGlobalSkillLevel(level) {
            globalSkillLevel = level;
            const applyTo = (p) => {
                const original = p.dataset.originalText || p.textContent || '';
                if (level === null) {
                    p.textContent = original;
                } else {
                    p.textContent = filterDescByLevel(original, level);
                }
            };
            const uniqueParas = document.querySelectorAll('.persona-unique-skill-info p');
            const highlightParas = document.querySelectorAll('.persona-highlight-info p');
            uniqueParas.forEach(applyTo);
            highlightParas.forEach(applyTo);
            // 추천 스킬(description)에도 동일한 스킬 레벨 필터 적용
            const recommendedParas = document.querySelectorAll('.persona-recommended-skills .skill-description');
            recommendedParas.forEach((p) => {
                // type 이 "패시브" 인 추천 스킬은 스킬 레벨 토글의 영향을 받지 않는다.
                if (p.dataset.passive === 'true') return;
                applyTo(p);
            });
            if (typeof addTooltips === 'function') {
                try { addTooltips(); } catch (_) { /* noop */ }
            }
        }

        buttons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const levelAttr = btn.dataset.level;
                const level = levelAttr === 'ALL' ? null : parseInt(levelAttr, 10);

                buttons.forEach(b => {
                    const isActive = b === btn;
                    b.classList.toggle('active', isActive);
                    b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                });

                applyGlobalSkillLevel(level);
            });
        });

        // 초기 상태(LV6) 전역 적용
        applyGlobalSkillLevel(0);
    }


</script>



<script>window.SITE_BASEURL = '{{ site.baseurl }}';</script>
<script src="{{ site.baseurl }}/apps/persona-new/skillfrom.js?v={{ site.time | date: '%s' }}"></script>