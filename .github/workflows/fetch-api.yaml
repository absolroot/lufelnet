name: Fetch external JSON every 6h

on:
  schedule:
    - cron: "0 */6 * * *"   # 6시간마다 (UTC)
  workflow_dispatch: {}      # 필요 시 수동 실행

permissions:
  contents: write

concurrency:
  group: fetch-external-json
  cancel-in-progress: false

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch & update JSON files
        env:
          BASE_URL: https://iant.kr:5000/data
        run: |
          set -euo pipefail

          # 저장 루트 설정
          ROOT_DIR="data/external"
          mkdir -p "$ROOT_DIR/gacha" "$ROOT_DIR/guildboss" "$ROOT_DIR/sos"
          mkdir -p "$ROOT_DIR/character" "$ROOT_DIR/weapon"
          mkdir -p "$ROOT_DIR/before"
          mkdir -p "$ROOT_DIR/before/character" "$ROOT_DIR/before/weapon"

          # 엔드포인트와 리전 정의
          ENDPOINTS=("gacha" "guildboss" "sos")
          REGIONS=("kr" "en" "cn" "tw" "jp" "sea")
          CODENAME_FILE="${ROOT_DIR}/character/codename.json"

          changed=0

          # [핵심 변경] Python을 사용한 강력한 JSON 정화 함수
          # 1. UTF-8 인코딩을 안전하게 처리 (일본어/한글 깨짐 방지)
          # 2. 정규식으로 숫자 앞의 불필요한 0 제거 (예: : 0123 -> : 123)
          clean_json() {
            python3 -c "import sys, re; content = sys.stdin.read(); sys.stdout.write(re.sub(r'([:\[,]\s*)0+([1-9])', r'\1\2', content))"
          }

          fetch_and_write () {
            local endpoint="$1"
            local region="$2"
            local url="${BASE_URL}/${endpoint}/${region}?source=lufelnet"
            local out="${ROOT_DIR}/${endpoint}/${region}.json"
            local backup_dir="${ROOT_DIR}/before/${endpoint}"
            local timestamp=$(date +"%Y%m%d_%H%M%S")
            local backup_file="${backup_dir}/${region}_${timestamp}.json"

            echo "➡️  Fetching: ${url}"

            tmp_new="$(mktemp)"
            
            # Python 정화 함수를 거쳐서 저장
            if ! curl -sS "$url" | clean_json > "$tmp_new"; then
               echo "❌ Curl Failed: $url"
               return
            fi

            # jq 유효성 검사
            if ! jq . "$tmp_new" > /dev/null 2>&1; then
               echo "❌ jq Error (Invalid JSON) on $url"
               echo "=== RAW CONTENT HEAD ==="
               head -n 20 "$tmp_new"
               return
            fi
            
            jq -S . "$tmp_new" > "${tmp_new}.sorted"

            # 변경 감지 및 저장
            if [ -f "$out" ]; then
              tmp_old="$(mktemp)"
              jq -S . "$out" > "$tmp_old"
              if diff -q "$tmp_old" "${tmp_new}.sorted" > /dev/null; then
                echo "   No change: ${endpoint}/${region}.json"
              else
                cp "$out" "$backup_file"
                echo "   Backup created: ${backup_file}"
                cp "${tmp_new}.sorted" "$out"
                echo "   Updated: ${endpoint}/${region}.json"
                changed=1
              fi
            else
              cp "${tmp_new}.sorted" "$out"
              echo "   Created: ${endpoint}/${region}.json"
              changed=1
            fi
          }

          fetch_and_write_character () {
            local region="$1"
            local api_codename="$2"
            local local_codename="$3"
            local url="${BASE_URL}/character/${region}/${api_codename}?source=lufelnet"
            local out="${ROOT_DIR}/character/${region}/${local_codename}.json"
            local backup_dir="${ROOT_DIR}/before/character/${region}"
            local timestamp=$(date +"%Y%m%d_%H%M%S")
            local backup_file="${backup_dir}/${local_codename}_${timestamp}.json"

            echo "➡️  Fetching: ${url}"

            tmp_new="$(mktemp)"
            
            curl -sS "$url" | clean_json > "$tmp_new"
            
            # jq 유효성 검사
            if ! jq . "$tmp_new" > /dev/null 2>&1; then
               # 캐릭터 없음(status 100) 에러인지 텍스트로 확인
               if grep -q '"status": 100' "$tmp_new" || grep -q '"status":100' "$tmp_new"; then
                   if [ -f "$out" ]; then
                      echo "   Character not found (status 100). Keeping existing file."
                   else
                      echo "   Character not found (status 100). No file created."
                   fi
                   return
               else
                   echo "❌ jq Error (Invalid JSON) on $url"
                   head -n 20 "$tmp_new"
                   return
               fi
            fi

            # 데이터가 null인 경우 처리
            if jq -e '.status == 100 and .data == null' "$tmp_new" > /dev/null 2>&1; then
              if [ -f "$out" ]; then
                echo "   Error response (data null). Keep existing."
              else
                echo "   Error response (data null). Skip create."
              fi
              return
            fi

            jq -S . "$tmp_new" > "${tmp_new}.sorted"

            mkdir -p "$(dirname "$out")"
            mkdir -p "$backup_dir"

            if [ -f "$out" ]; then
              tmp_old="$(mktemp)"
              jq -S . "$out" > "$tmp_old"
              if diff -q "$tmp_old" "${tmp_new}.sorted" > /dev/null; then
                echo "   No change: character/${region}/${local_codename}.json"
              else
                cp "$out" "$backup_file"
                echo "   Backup created: ${backup_file}"
                cp "${tmp_new}.sorted" "$out"
                echo "   Updated: character/${region}/${local_codename}.json"
                changed=1
              fi
            else
              cp "${tmp_new}.sorted" "$out"
              echo "   Created: character/${region}/${local_codename}.json"
              changed=1
            fi
          }

          fetch_and_write_weapon () {
            local region="$1"
            local api_codename="$2"
            local local_codename="$3"
            local url="${BASE_URL}/weapon/${region}/${api_codename}?source=lufelnet"
            local out="${ROOT_DIR}/weapon/${region}/${local_codename}.json"
            local backup_dir="${ROOT_DIR}/before/weapon/${region}"
            local timestamp=$(date +"%Y%m%d_%H%M%S")
            local backup_file="${backup_dir}/${local_codename}_${timestamp}.json"

            echo "➡️  Fetching: ${url}"

            tmp_new="$(mktemp)"
            
            curl -sS "$url" | clean_json > "$tmp_new"
            
            if ! jq . "$tmp_new" > /dev/null 2>&1; then
               echo "❌ jq Error on $url"
               return
            fi

            if jq -e 'has("error")' "$tmp_new" > /dev/null 2>&1; then
              if [ -f "$out" ]; then
                echo "   Weapon not found error. Keep existing."
              else
                echo "   Weapon not found error. Skip create."
              fi
              return
            fi

            jq -S . "$tmp_new" > "${tmp_new}.sorted"

            mkdir -p "$(dirname "$out")"
            mkdir -p "$backup_dir"

            if [ -f "$out" ]; then
              tmp_old="$(mktemp)"
              jq -S . "$out" > "$tmp_old"
              if diff -q "$tmp_old" "${tmp_new}.sorted" > /dev/null; then
                echo "   No change: weapon/${region}/${local_codename}.json"
              else
                cp "$out" "$backup_file"
                echo "   Backup created: ${backup_file}"
                cp "${tmp_new}.sorted" "$out"
                echo "   Updated: weapon/${region}/${local_codename}.json"
                changed=1
              fi
            else
              cp "${tmp_new}.sorted" "$out"
              echo "   Created: weapon/${region}/${local_codename}.json"
              changed=1
            fi
          }

          # 실행 루프
          for ep in "${ENDPOINTS[@]}"; do
            for rg in "${REGIONS[@]}"; do
              fetch_and_write "$ep" "$rg"
            done
          done

          if [ -f "$CODENAME_FILE" ]; then
            echo "➡️  Loading codenames mapping from: $CODENAME_FILE"
            mapfile -t CN_API < <(jq -r '.[].api' "$CODENAME_FILE")
            mapfile -t CN_LOCAL < <(jq -r '.[].local' "$CODENAME_FILE")
            for rg in "${REGIONS[@]}"; do
              mkdir -p "$ROOT_DIR/character/$rg" "$ROOT_DIR/weapon/$rg"
              mkdir -p "$ROOT_DIR/before/character/$rg" "$ROOT_DIR/before/weapon/$rg"
              for i in "${!CN_API[@]}"; do
                api_code="${CN_API[$i]}"
                local_code="${CN_LOCAL[$i]}"
                fetch_and_write_character "$rg" "$api_code" "$local_code"
                fetch_and_write_weapon "$rg" "$api_code" "$local_code"
              done
            done
          else
            echo "⚠️  $CODENAME_FILE not found. Skip character fetch."
          fi

          # 변경 사항 커밋
          if [ "$changed" -eq 1 ] || ! git diff --quiet; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A || true
            git commit -m "chore(data): update /data/external JSONs [skip ci]" || echo "ℹ️ No new commits created."
            git push || echo "ℹ️ Nothing to push or push skipped."
            echo "✅ Commit/push step completed."
          else
            echo "✅ No changes to commit."
          fi

          exit 0