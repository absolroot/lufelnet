---
layout: default
custom_css: [tactic, tactic-share]
custom_js: [tooltip, tactic-preview]
custom_data: [tooltip.js, characters/characters.js, revelations/revelations.js, tactic/pattern.js, wonder/weapons.js, wonder/persona.js, wonder/skills.js]
permalink: /tactic/tactic-upload.html
language: kr
title: 택틱 업로드 - 페르소나5 더 팬텀 X 루페르넷
description: 페르소나5 더 팬텀 X 택틱을 업로드하세요.
---
{% include supabase-config.html %}

<!-- 메인 컨텐츠 -->
<div class="main-wrapper">
    <!-- 네비게이션 경로 -->
    <div class="navigation-path">
        <script>document.write(`<a href="../../?v=${APP_VERSION}">홈</a>`);</script>
        <span class="separator">/</span>
        <span class="current-page">택틱 / 택틱 업로드</span>
    </div>
    <div class="header-container">
        <h1>택틱 업로드</h1>
    </div>

    <!-- 로그인 확인 메시지 -->
    <div id="loginRequired" class="login-required" style="display: none;">
        <div class="login-message">
            <h3>로그인이 필요합니다</h3>
            <p>택틱을 업로드하려면 로그인해주세요.</p>
            <button id="loginButton" class="login-btn">로그인하기</button>
        </div>
    </div>

    <!-- 업로드 폼 -->
    <div id="uploadForm" class="upload-container" style="display: none;">
        <form id="tacticUploadForm" class="tactic-upload-form">
            <div class="form-section">
                <h3>택틱 정보</h3>
                
                <!-- 택틱 타입 -->
                <div class="form-group">
                    <label for="tacticType">택틱 타입 *</label>
                    <select id="tacticType" name="tacticType" required>
                        <option value="">선택해주세요</option>
                        <option value="흉몽">흉몽</option>
                        <option value="바다">바다</option>
                        <option value="이벤트">이벤트</option>
                        <option value="기타">기타</option>
                    </select>
                </div>

                <!-- 제목 -->
                <div class="form-group">
                    <label for="tacticTitle">제목 *</label>
                    <input type="text" id="tacticTitle" name="tacticTitle" placeholder="[택틱 타입] 보스 이름 (점수)" required>
                    <small>예: [첩첩 흉몽] 쿠 훌린 (1.4억)</small>
                </div>

                <!-- 작성자 -->
                <div class="form-group">
                    <label for="tacticAuthor">작성자 *</label>
                    <input type="text" id="tacticAuthor" name="tacticAuthor" required>
                </div>
            </div>

            <div class="form-section">
                <h3>택틱 데이터</h3>
                
                <!-- JSON 파일 업로드 -->
                <div class="form-group">
                    <label for="jsonFile">택틱 JSON 파일 *</label>
                    <input type="file" id="jsonFile" name="jsonFile" accept=".json" required>
                    <small>택틱 메이커에서 내보낸 JSON 파일을 업로드해주세요.</small>
                </div>

                <!-- JSON 데이터 미리보기 -->
                <div id="jsonPreview" class="json-preview" style="display: none;">
                    <h4>데이터 미리보기</h4>
                    <div id="previewContent"></div>
                </div>
            </div>

            <div class="form-section">
                <h3>추가 정보 (선택사항)</h3>
                
                <!-- 코멘트 -->
                <div class="form-group">
                    <label for="tacticComment">코멘트</label>
                    <textarea id="tacticComment" name="tacticComment" rows="4" placeholder="원본 링크, 유튜브 링크, 참고 사항 등"></textarea>
                </div>

                <!-- URL -->
                <div class="form-group">
                    <label for="tacticUrl">관련 URL</label>
                    <input type="url" id="tacticUrl" name="tacticUrl" placeholder="https://example.com">
                    <small>유튜브 링크, 원본 택틱 링크 등</small>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" id="previewButton" class="preview-btn">미리보기</button>
                <button type="submit" id="submitButton" class="submit-btn">업로드</button>
            </div>
        </form>
    </div>

    <!-- 미리보기 모달 -->
    <div id="previewModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>택틱 미리보기</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalPreviewContent"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-close-btn">닫기</button>
            </div>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>업로드 중...</p>
        </div>
    </div>
</div>

<style>
.login-required {
    text-align: center;
    padding: 60px 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    margin: 40px auto;
    max-width: 500px;
}

.login-message h3 {
    color: #fff;
    margin-bottom: 15px;
}

.login-message p {
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 25px;
}

.login-btn {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s;
}

.login-btn:hover {
    transform: translateY(-2px);
}

.upload-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.tactic-upload-form {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 30px;
}

.form-section {
    margin-bottom: 40px;
}

.form-section h3 {
    color: #fff;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #fff;
    margin-bottom: 8px;
    font-weight: 500;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 14px;
}

.form-group input::placeholder,
.form-group textarea::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.form-group small {
    display: block;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 5px;
    font-size: 12px;
}

.json-preview {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.json-preview h4 {
    color: #fff;
    margin-bottom: 10px;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
}

.preview-btn,
.submit-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.preview-btn {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.preview-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.submit-btn {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.submit-btn:hover {
    transform: translateY(-1px);
}

.submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #1a1a2e;
    border-radius: 15px;
    max-width: 90%;
    max-height: 90%;
    overflow: hidden;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h3 {
    color: #fff;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    text-align: right;
}

.modal-close-btn {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loading-spinner {
    text-align: center;
    color: #fff;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
class TacticUploader {
    constructor() {
        this.currentUser = null;
        this.tacticData = null;
        this.tacticPreview = new TacticPreview();
        
        this.init();
    }

    async init() {
        await this.checkAuth();
        this.initEventListeners();
    }

    async checkAuth() {
        try {
            // 먼저 현재 세션 확인
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (sessionError) {
                console.error('세션 확인 실패:', sessionError);
                this.showLoginRequired();
                return;
            }

            if (session && session.user) {
                this.currentUser = session.user;
                this.showUploadForm();
                
                // 작성자 필드에 사용자 이름 자동 입력
                const authorInput = document.getElementById('tacticAuthor');
                const displayName = session.user.user_metadata?.display_name || 
                                   session.user.user_metadata?.full_name || 
                                   session.user.email || '';
                authorInput.value = displayName;
                
                console.log('사용자 인증 확인됨:', displayName);
            } else {
                // 세션이 없으면 로컬 스토리지도 확인
                const localUser = localStorage.getItem('user');
                if (localUser) {
                    try {
                        const userData = JSON.parse(localUser);
                        // 로컬 스토리지에 사용자 정보가 있지만 세션이 없는 경우
                        // 세션을 다시 확인하거나 로그인 필요
                        this.showLoginRequired();
                    } catch (e) {
                        this.showLoginRequired();
                    }
                } else {
                    this.showLoginRequired();
                }
            }
        } catch (error) {
            console.error('인증 확인 실패:', error);
            this.showLoginRequired();
        }
    }

    showLoginRequired() {
        document.getElementById('loginRequired').style.display = 'block';
        document.getElementById('uploadForm').style.display = 'none';
    }

    showUploadForm() {
        document.getElementById('loginRequired').style.display = 'none';
        document.getElementById('uploadForm').style.display = 'block';
    }

    initEventListeners() {
        // 로그인 버튼
        document.getElementById('loginButton').addEventListener('click', () => {
            const currentUrl = window.location.href;
            window.location.href = `/login/?redirect=${encodeURIComponent(currentUrl)}`;
        });

        // 파일 업로드
        document.getElementById('jsonFile').addEventListener('change', (e) => {
            this.handleFileUpload(e);
        });

        // 미리보기 버튼
        document.getElementById('previewButton').addEventListener('click', () => {
            this.showPreview();
        });

        // 폼 제출
        document.getElementById('tacticUploadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSubmit();
        });

        // 모달 닫기
        document.querySelectorAll('.modal-close, .modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('previewModal').style.display = 'none';
            });
        });

        // 택틱 타입 변경시 제목 자동 업데이트
        document.getElementById('tacticType').addEventListener('change', (e) => {
            this.updateTitlePrefix(e.target.value);
        });
    }

    updateTitlePrefix(type) {
        const titleInput = document.getElementById('tacticTitle');
        const currentTitle = titleInput.value;
        
        // 기존 접두사 제거
        const cleanTitle = currentTitle.replace(/^\[.*?\]\s*/, '');
        
        if (type && type !== '기타') {
            titleInput.value = `[${type}] ${cleanTitle}`;
        } else {
            titleInput.value = cleanTitle;
        }
    }

    async handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            this.tacticData = data;
            this.showJsonPreview(data);
            
            // 제목이 비어있으면 파일의 제목 사용
            const titleInput = document.getElementById('tacticTitle');
            if (!titleInput.value.trim() && data.title) {
                titleInput.value = data.title;
            }
            
        } catch (error) {
            alert('JSON 파일을 읽는데 실패했습니다. 올바른 형식인지 확인해주세요.');
            console.error('JSON 파싱 오류:', error);
        }
    }

    showJsonPreview(data) {
        const previewDiv = document.getElementById('jsonPreview');
        const contentDiv = document.getElementById('previewContent');
        
        if (data.party && data.party.length > 0) {
            const preview = this.createTacticPreview(data);
            contentDiv.innerHTML = '';
            if (preview) {
                contentDiv.appendChild(preview);
            }
            
            // 파티 정보 텍스트
            const partyInfo = document.createElement('div');
            partyInfo.innerHTML = `
                <p><strong>파티 구성:</strong> ${data.party.filter(p => p.name).map(p => p.name).join(', ')}</p>
                <p><strong>턴 수:</strong> ${data.turns ? data.turns.length : 0}턴</p>
            `;
            contentDiv.appendChild(partyInfo);
        }
        
        previewDiv.style.display = 'block';
    }

    createTacticPreview(tacticData) {
        if (!tacticData || !tacticData.party) return null;

        const previewDiv = document.createElement('div');
        previewDiv.className = 'tactic-preview';

        const partyImagesContainer = document.createElement('div');
        partyImagesContainer.className = 'party-images-container';

        const partyImagesDiv = document.createElement('div');
        partyImagesDiv.className = 'party-images';

        const orderedParty = tacticData.party
            .filter(pm => pm.name !== "")
            .sort((a, b) => {
                if (a.order === "-") return 1;
                if (b.order === "-") return -1;
                return parseInt(a.order, 10) - parseInt(b.order, 10);
            });

        orderedParty.forEach(member => {
            if (member.name === "원더") return;
            
            const container = document.createElement('div');
            if (characterData[member.name]) {
                container.className = 'character-container';

                const charImg = document.createElement('img');
                charImg.className = 'character-img';
                charImg.src = `${BASE_URL}/assets/img/character-half/${member.name}.webp`;
                charImg.alt = member.name;
                charImg.title = member.name;
                container.appendChild(charImg);
            }

            const ritualLevel = parseInt(member.ritual);
            if (ritualLevel >= 1 && ritualLevel <= 6) {
                const ritualImg = document.createElement('img');
                ritualImg.className = 'ritual-img';
                ritualImg.src = `${BASE_URL}/assets/img/ritual/num${ritualLevel}.png`;
                ritualImg.alt = `의식 ${ritualLevel}`;
                container.appendChild(ritualImg);
            }

            partyImagesDiv.appendChild(container);
        });

        partyImagesContainer.appendChild(partyImagesDiv);
        previewDiv.appendChild(partyImagesContainer);
        
        return previewDiv;
    }

    showPreview() {
        if (!this.tacticData) {
            alert('먼저 JSON 파일을 업로드해주세요.');
            return;
        }

        const modal = document.getElementById('previewModal');
        const modalContent = document.getElementById('modalPreviewContent');
        
        // 폼 데이터 수집
        const formData = this.getFormData();
        
        // 미리보기 생성
        const previewHTML = `
            <div class="preview-post">
                <div class="post-header">
                    <h3>
                        ${formData.url ? `
                            <a href="${formData.url}" target="_blank" rel="noopener noreferrer" class="post-title">
                                ${formData.title}
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8.59 16.59L13.17 12L8.59 7.41L10 6L16 12L10 18L8.59 16.59Z" fill="rgba(255, 255, 255, 0.6)"></path>
                                </svg>
                            </a>
                        ` : `
                            <span class="post-title">${formData.title}</span>
                        `}
                    </h3>
                    <div class="post-meta">
                        <span class="post-author">${formData.author}</span>
                        <span class="separator">|</span>
                        <span class="post-date">방금 전</span>
                    </div>
                    ${formData.comment ? `<div class="post-comment">${formData.comment}</div>` : ''}
                </div>
                
                <div class="post-content">
                    ${formData.url ? `
                        <div class="post-link">
                            <a href="${formData.url}" target="_blank" rel="noopener noreferrer">택틱 보기</a>
                        </div>
                    ` : ''}
                    <div class="tactic-preview-container"></div>
                </div>

                <div class="post-footer">
                    <div class="likes-section">
                        <button class="like-button">
                            <img src="${BASE_URL}/assets/img/tactic-share/like.png" alt="좋아요">
                        </button>
                        <div class="likes-count-wrapper">
                            <span class="likes-count">0</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        modalContent.innerHTML = previewHTML;
        
        // 택틱 프리뷰 추가
        const previewContainer = modalContent.querySelector('.tactic-preview-container');
        const tacticPreview = this.createTacticPreview(this.tacticData);
        if (tacticPreview) {
            previewContainer.appendChild(tacticPreview);
        }
        
        modal.style.display = 'flex';
    }

    getFormData() {
        return {
            type: document.getElementById('tacticType').value,
            title: document.getElementById('tacticTitle').value,
            author: document.getElementById('tacticAuthor').value,
            comment: document.getElementById('tacticComment').value,
            url: document.getElementById('tacticUrl').value
        };
    }

    async handleSubmit() {
        if (!this.tacticData) {
            alert('JSON 파일을 업로드해주세요.');
            return;
        }

        const formData = this.getFormData();
        
        // 유효성 검사
        if (!formData.type || !formData.title || !formData.author) {
            alert('필수 항목을 모두 입력해주세요.');
            return;
        }

        this.showLoading(true);

        try {
            const { data, error } = await supabase
                .from('tactics')
                .insert([{
                    title: formData.title,
                    author: formData.author,
                    comment: formData.comment || null,
                    url: formData.url || null,
                    query: this.tacticData,
                    likes: 0,
                    recentLikes: 0,
                    tactic_type: formData.type
                }]);

            if (error) {
                throw error;
            }

            alert('택틱이 성공적으로 업로드되었습니다!');
            
            // 택틱 목록 페이지로 이동
            window.location.href = '/tactic/tactics.html';
            
        } catch (error) {
            console.error('업로드 실패:', error);
            alert('업로드 중 오류가 발생했습니다. 다시 시도해주세요.');
        } finally {
            this.showLoading(false);
        }
    }

    showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        document.getElementById('submitButton').disabled = show;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', () => {
    Navigation.load('tactic-upload');
    window.tacticUploader = new TacticUploader();
});
</script>
