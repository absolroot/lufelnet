{% if page.persona_kr_name %}
<script>
  window.__PERSONA_DEFAULT = {{ page.persona_kr_name | jsonify }};
</script>
{% endif %}
{% if site.data.persona_slugs %}
<script>
  window.__PERSONA_SLUG_MAP = {{ site.data.persona_slugs | jsonify }};
</script>
{% endif %}

<!-- URL rewrite / cleanup:
  - /persona/?name=X&lang=Y -> /{lang}/persona/{slug}/
  - /persona/?lang=Y&v=... -> /{lang}/persona/
  - /{lang}/persona/... removes redundant lang/v query -->
<script>
(function () {
  var params = new URLSearchParams(window.location.search || '');
  var path = String(window.location.pathname || '/');
  var lowerPath = path.toLowerCase();

  var pathLangMatch = lowerPath.match(/^\/(kr|en|jp)(\/|$)/);
  var pathLang = pathLangMatch ? pathLangMatch[1] : '';
  var queryLang = String(params.get('lang') || '').toLowerCase();
  var effectiveLang = pathLang || (['kr', 'en', 'jp'].indexOf(queryLang) !== -1 ? queryLang : '');

  var map = window.__PERSONA_SLUG_MAP;
  var name = params.get('name') || params.get('persona');
  if (name && map && typeof map === 'object') {
    var entry = map[name];
    if (entry && entry.slug) {
      var lang = effectiveLang || 'kr';
      window.__PERSONA_DEFAULT = name;
      window.__SEO_PATH_LANG__ = lang;
      var detailPath = '/' + lang + '/persona/' + entry.slug + '/';
      params.delete('name');
      params.delete('persona');
      params.delete('lang');
      params.delete('v');
      var remainingDetail = params.toString();
      history.replaceState(null, '', detailPath + (remainingDetail ? '?' + remainingDetail : ''));
      return;
    }
  }

  var isLegacyRoot = /^\/persona\/?$/.test(lowerPath);
  var isCanonicalListPath = /^\/(kr|en|jp)\/persona\/?$/.test(lowerPath);
  var isCanonicalDetailPath = /^\/(kr|en|jp)\/persona\/[^/]+\/?$/.test(lowerPath);

  if (isLegacyRoot && effectiveLang) {
    window.__SEO_PATH_LANG__ = effectiveLang;
    params.delete('lang');
    params.delete('v');
    var remainingLegacy = params.toString();
    history.replaceState(null, '', '/' + effectiveLang + '/persona/' + (remainingLegacy ? '?' + remainingLegacy : ''));
    return;
  }

  if (isCanonicalListPath || isCanonicalDetailPath) {
    window.__SEO_PATH_LANG__ = pathLang;
    var before = params.toString();
    params.delete('lang');
    params.delete('v');
    var remainingCanonical = params.toString();
    if (before !== remainingCanonical) {
      history.replaceState(null, '', path + (remainingCanonical ? '?' + remainingCanonical : ''));
    }
    return;
  }

  if (isLegacyRoot && params.has('v')) {
    params.delete('v');
    var remainingRoot = params.toString();
    history.replaceState(null, '', '/persona/' + (remainingRoot ? '?' + remainingRoot : ''));
  }
})();
</script>

{% if page.alternate_urls %}
{% assign persona_alt_ko = page.alternate_urls['ko'] | default: page.alternate_urls.first[1] %}
<link rel="alternate" hreflang="ko" href="{{ site.url }}{{ persona_alt_ko }}" />
{% for alt in page.alternate_urls %}
{% if alt[0] != 'ko' %}
<link rel="alternate" hreflang="{{ alt[0] }}" href="{{ site.url }}{{ alt[1] }}" />
{% endif %}
{% endfor %}
<link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ persona_alt_ko }}" />
{% endif %}

<div class="main-wrapper">
    <link rel="stylesheet" href="{{ site.baseurl }}/apps/persona/skillfrom.css?v={{ site.time | date: '%s' }}">
    <link rel="stylesheet" href="{{ site.baseurl }}/apps/persona/persona.css?v={{ site.time | date: '%s' }}">
    <link rel="stylesheet" href="{{ site.baseurl }}/apps/persona/persona-img.css?v={{ site.time | date: '%s' }}">

    <!--<script src="{{ site.baseurl }}/assets/js/ad-injector.js?v={{ site.time | date: '%s' }}"></script>-->
    <!-- 페르소나 순서 및 로더 -->
    <script src="{{ site.baseurl }}/data/persona/order.js?v={{ site.time | date: '%s' }}"></script>
    <script src="{{ site.baseurl }}/data/persona/nonorder.js?v={{ site.time | date: '%s' }}"></script>
    <script src="{{ site.baseurl }}/assets/js/persona-loader.js?v={{ site.time | date: '%s' }}"></script>
    <script src="{{ site.baseurl }}/apps/persona/getfrom.js?v={{ site.time | date: '%s' }}"></script>

    <div class="navigation-path">
        <script>document.write(`<a href="../../?v=${APP_VERSION}" id="nav-home" data-i18n="navHome">-</a>`);</script>
        <span class="separator">/</span>
        <span class="current-page" id="nav-current" data-i18n="navCurrent">-</span>
    </div>
    <div class="header-container">
        <h1 id="page-title" data-i18n="pageTitle">-</h1>
    </div>



    <!-- Split View Container -->
    <div class="split-view-container">
        <!-- Left Panel: Filter & List -->
        <div class="persona-list-panel">
            <!-- Search & Sort Header Implementation -->
            <div class="search-section filter-header-sticky">
                <div class="search-sort-container"
                    style="display: flex; gap: 8px; align-items: center; justify-content: space-between;">
                    <div class="search-container" style="flex: 1; position: relative;">
                        <div class="search-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z"
                                    fill="rgba(255, 255, 255, 0.6)" />
                            </svg>
                        </div>
                        <input type="text" id="personaSearch" placeholder="Search..." autocomplete="off"
                            data-i18n-placeholder="searchPlaceholder" style="padding-right: 30px;">
                        <button id="searchClearBtn" class="search-clear-btn"
                            style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999; padding: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-circle-x-icon lucide-circle-x">
                                <circle cx="12" cy="12" r="10" />
                                <path d="m15 9-6 6" />
                                <path d="m9 9 6 6" />
                            </svg>
                        </button>
                        <div id="searchDropdown" class="search-dropdown"></div>
                    </div>
                    <div class="sort-container">
                        <select id="sortSelect" class="sort-select">
                            <option value="tier" data-i18n="sortTier">티어 순</option>
                            <option value="rarity" data-i18n="sortRarity">희귀도 순</option>
                            <option value="name" data-i18n="sortName">이름 순</option>
                        </select>
                    </div>
                </div>
                <!-- Filtered Count & Filter Button -->
                <div class="search-status-row"
                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; width:100%;">
                    <div class="search-count" style="font-size: 12px; color: #aaa;">
                        <span id="filteredCount" data-i18n="filteredCount"></span>
                    </div>
                    <button id="filterOpenBtn" class="filter-open-btn" aria-label="필터" data-i18n-aria="common.filter">
                        <span data-i18n="common.filter"
                            style="margin-right: 6px; font-size: 11px; font-weight: 400; color: #aaa;">필터</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                            fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" class="lucide lucide-funnel-icon lucide-funnel">
                            <path
                                d="M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z" />
                        </svg>
                    </button>
                </div>
                <div id="activeFilters" class="active-filters-container"></div>
            </div>
            <div class="persona-cards drag-me" id="personaCards">
                <!-- Dynamically generated by JavaScript -->
            </div>
        </div>

        <!-- Right Panel: Detail -->
        <div class="persona-detail-panel">
            <div id="personaDetailContent" class="sticky-content">
                <div class="detail-placeholder">
                    <div class="loading-spinner"></div>
                </div>
                <div class="empty-state-message" style="display: none;">
                    <p data-i18n="emptyStateMessage">페르소나를 선택하여 상세 정보를 확인하세요.</p>
                </div>
            </div>
        </div>
    </div>


</div>




</div>


</div>




<!-- Filter Modal Structure (Hidden by default) -->
<div id="filterModal" class="filter-modal hidden">
    <div class="filter-backdrop"></div>
    <div class="filter-dialog">
        <div class="filter-header">
            <h3 data-i18n="common.filter">필터</h3>
            <button class="filter-close-btn">×</button>
        </div>
        <div class="filter-body">
            <div class="filter-content">
                <!-- Element filter -->
                <div class="filter-group">
                    <h3 data-i18n="filterElement">속성</h3>
                    <div class="filter-options">
                        <label>
                            <input type="checkbox" name="element" value="물리">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_물리.png" alt="물리">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="총격">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_총격.png" alt="총격">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="화염">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_화염.png" alt="화염">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="빙결">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_빙결.png" alt="빙결">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="전격">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_전격.png" alt="전격">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="질풍">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_질풍.png" alt="질풍">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="염동">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_염동.png" alt="염동">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="핵열">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_핵열.png" alt="핵열">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="축복">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_축복.png" alt="축복">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="주원">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_주원.png" alt="주원">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="element" value="만능">
                            <img src="{{ site.baseurl }}/assets/img/persona/속성_만능.png" alt="만능">
                            <span></span>
                        </label>
                    </div>
                </div>

                <!-- Position filter -->
                <div class="filter-group">
                    <h3 data-i18n="filterPosition">직업</h3>
                    <div class="filter-options">
                        <label>
                            <input type="checkbox" name="position" value="지배">
                            <img src="{{ site.baseurl }}/assets/img/persona/직업_지배.png" alt="지배">
                        </label>
                        <label>
                            <input type="checkbox" name="position" value="반항">
                            <img src="{{ site.baseurl }}/assets/img/persona/직업_반항.png" alt="반항">
                        </label>
                        <label>
                            <input type="checkbox" name="position" value="우월">
                            <img src="{{ site.baseurl }}/assets/img/persona/직업_우월.png" alt="우월">
                        </label>
                        <label>
                            <input type="checkbox" name="position" value="굴복">
                            <img src="{{ site.baseurl }}/assets/img/persona/직업_굴복.png" alt="굴복">
                        </label>
                        <label>
                            <input type="checkbox" name="position" value="방위">
                            <img src="{{ site.baseurl }}/assets/img/persona/직업_방위.png" alt="방위">
                        </label>
                        <label>
                            <input type="checkbox" name="position" value="구원">
                            <img src="{{ site.baseurl }}/assets/img/persona/직업_구원.png" alt="구원">
                        </label>
                    </div>
                </div>

                <!-- Rarity filter -->
                <div class="filter-group">
                    <h3 data-i18n="filterRarity">희귀도</h3>
                    <div class="filter-options">
                        <label>
                            <input type="checkbox" name="rarity" value="5" hidden>
                            <div class="star-container">
                                <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star5.webp" alt="★">
                            </div>
                        </label>
                        <label>
                            <input type="checkbox" name="rarity" value="4" hidden>
                            <div class="star-container">
                                <img src="{{ site.baseurl }}/assets/img/persona/star4.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star4.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star4.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star4.webp" alt="★">
                            </div>
                        </label>
                        <label>
                            <input type="checkbox" name="rarity" value="3" hidden>
                            <div class="star-container">
                                <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                            </div>
                        </label>
                        <label>
                            <input type="checkbox" name="rarity" value="2" hidden>
                            <div class="star-container">
                                <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                                <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                            </div>
                        </label>
                        <label>
                            <input type="checkbox" name="rarity" value="1" hidden>
                            <div class="star-container">
                                <img src="{{ site.baseurl }}/assets/img/persona/star3.webp" alt="★">
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Grade filter -->
                <div class="filter-group">
                    <h3 data-i18n="filterGrade">등급</h3>
                    <div class="filter-options">
                        <label>
                            <input type="checkbox" name="grade" value="1">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade1.webp" alt="1등급">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="grade" value="2">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade2.webp" alt="2등급">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="grade" value="3">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade3.webp" alt="3등급">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="grade" value="4">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade4.webp" alt="4등급">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="grade" value="5">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade5.webp" alt="5등급">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="grade" value="6">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade6.webp" alt="6등급">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="grade" value="7">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade7.webp" alt="7등급">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="grade" value="8">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade8.webp" alt="8등급">
                            <span></span>
                        </label>
                        <label>
                            <input type="checkbox" name="grade" value="9">
                            <img src="{{ site.baseurl }}/assets/img/persona/persona-grade9.webp" alt="9등급">
                            <span></span>
                        </label>
                    </div>
                </div>
            </div> <!-- /filter-content -->
        </div>
        <div class="filter-footer">
            <button id="filterResetBtn" class="filter-action-btn reset" data-i18n="common.reset">초기화</button>
            <button id="filterSaveBtn" class="filter-action-btn save" data-i18n="common.apply">적용</button>
        </div>
    </div>
</div>
<script>window.SITE_BASEURL = '{{ site.baseurl }}';</script>
<script src="{{ site.baseurl }}/apps/persona/persona-list.js?v={{ site.time | date: '%s' }}"></script>
<script src="{{ site.baseurl }}/apps/persona/skillfrom.js?v={{ site.time | date: '%s' }}"></script>
<script src="{{ site.baseurl }}/assets/js/tooltip.js?v={{ site.time | date: '%s' }}"></script>
<script src="{{ site.baseurl }}/apps/persona/persona-search.js?v={{ site.time | date: '%s' }}"></script>
<script>
    // Search initialized via main callback
</script>

<!-- i18n 서비스 -->
<script type="module" src="{{ site.baseurl }}/i18n/service/i18n-service.js?v={{ site.time | date: '%s' }}"></script>
<script defer src="{{ site.baseurl }}/i18n/service/i18n-adapter.js?v={{ site.time | date: '%s' }}"></script>
<script type="module">
    import { handlePersonaRouting } from "{{ site.baseurl }}/apps/persona/persona-routing.js?v={{ site.time | date: '%s' }}";
    window.handlePersonaRouting = handlePersonaRouting;
</script>
